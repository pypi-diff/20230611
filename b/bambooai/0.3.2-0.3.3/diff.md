# Comparing `tmp/bambooai-0.3.2.tar.gz` & `tmp/bambooai-0.3.3.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "bambooai-0.3.2.tar", last modified: Sun Jun 11 02:42:05 2023, max compression
+gzip compressed data, was "bambooai-0.3.3.tar", last modified: Sun Jun 11 03:18:22 2023, max compression
```

## Comparing `bambooai-0.3.2.tar` & `bambooai-0.3.3.tar`

### file list

```diff
@@ -1,15 +1,15 @@
-drwxrwxrwx   0        0        0        0 2023-06-11 02:42:05.006149 bambooai-0.3.2/
--rw-rw-rw-   0        0        0     8017 2023-06-11 02:42:05.005149 bambooai-0.3.2/PKG-INFO
--rw-rw-rw-   0        0        0     7483 2023-06-11 02:09:10.000000 bambooai-0.3.2/README.md
-drwxrwxrwx   0        0        0        0 2023-06-11 02:42:04.973152 bambooai-0.3.2/bambooai/
--rw-rw-rw-   0        0        0       61 2023-06-11 02:37:51.000000 bambooai-0.3.2/bambooai/__init__.py
--rw-rw-rw-   0        0        0    25060 2023-06-11 02:38:22.000000 bambooai-0.3.2/bambooai/bambooai.py
--rw-rw-rw-   0        0        0     8600 2023-06-11 00:55:58.000000 bambooai-0.3.2/bambooai/prompts.py
-drwxrwxrwx   0        0        0        0 2023-06-11 02:42:05.004199 bambooai-0.3.2/bambooai.egg-info/
--rw-rw-rw-   0        0        0     8017 2023-06-11 02:42:04.000000 bambooai-0.3.2/bambooai.egg-info/PKG-INFO
--rw-rw-rw-   0        0        0      239 2023-06-11 02:42:04.000000 bambooai-0.3.2/bambooai.egg-info/SOURCES.txt
--rw-rw-rw-   0        0        0        1 2023-06-11 02:42:04.000000 bambooai-0.3.2/bambooai.egg-info/dependency_links.txt
--rw-rw-rw-   0        0        0       24 2023-06-11 02:42:04.000000 bambooai-0.3.2/bambooai.egg-info/requires.txt
--rw-rw-rw-   0        0        0        9 2023-06-11 02:42:04.000000 bambooai-0.3.2/bambooai.egg-info/top_level.txt
--rw-rw-rw-   0        0        0       42 2023-06-11 02:42:05.006149 bambooai-0.3.2/setup.cfg
--rw-rw-rw-   0        0        0      702 2023-06-11 02:40:09.000000 bambooai-0.3.2/setup.py
+drwxrwxrwx   0        0        0        0 2023-06-11 03:18:22.286844 bambooai-0.3.3/
+-rw-rw-rw-   0        0        0     8017 2023-06-11 03:18:22.286844 bambooai-0.3.3/PKG-INFO
+-rw-rw-rw-   0        0        0     7483 2023-06-11 02:09:10.000000 bambooai-0.3.3/README.md
+drwxrwxrwx   0        0        0        0 2023-06-11 03:18:22.254845 bambooai-0.3.3/bambooai/
+-rw-rw-rw-   0        0        0       53 2023-06-11 03:03:44.000000 bambooai-0.3.3/bambooai/__init__.py
+-rw-rw-rw-   0        0        0    25067 2023-06-11 03:10:50.000000 bambooai-0.3.3/bambooai/bambooai.py
+-rw-rw-rw-   0        0        0     8600 2023-06-11 00:55:58.000000 bambooai-0.3.3/bambooai/prompts.py
+drwxrwxrwx   0        0        0        0 2023-06-11 03:18:22.284843 bambooai-0.3.3/bambooai.egg-info/
+-rw-rw-rw-   0        0        0     8017 2023-06-11 03:18:22.000000 bambooai-0.3.3/bambooai.egg-info/PKG-INFO
+-rw-rw-rw-   0        0        0      239 2023-06-11 03:18:22.000000 bambooai-0.3.3/bambooai.egg-info/SOURCES.txt
+-rw-rw-rw-   0        0        0        1 2023-06-11 03:18:22.000000 bambooai-0.3.3/bambooai.egg-info/dependency_links.txt
+-rw-rw-rw-   0        0        0       24 2023-06-11 03:18:22.000000 bambooai-0.3.3/bambooai.egg-info/requires.txt
+-rw-rw-rw-   0        0        0        9 2023-06-11 03:18:22.000000 bambooai-0.3.3/bambooai.egg-info/top_level.txt
+-rw-rw-rw-   0        0        0       42 2023-06-11 03:18:22.287845 bambooai-0.3.3/setup.cfg
+-rw-rw-rw-   0        0        0      702 2023-06-11 02:48:50.000000 bambooai-0.3.3/setup.py
```

### Comparing `bambooai-0.3.2/PKG-INFO` & `bambooai-0.3.3/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bambooai
-Version: 0.3.2
+Version: 0.3.3
 Summary: A lightweight library for working with pandas dataframes using natural language queries
 Home-page: UNKNOWN
 Author: Palo Galko
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `bambooai-0.3.2/README.md` & `bambooai-0.3.3/README.md`

 * *Files identical despite different names*

### Comparing `bambooai-0.3.2/bambooai/bambooai.py` & `bambooai-0.3.3/bambooai/bambooai.py`

 * *Files 0% similar despite different names*

```diff
@@ -12,1556 +12,1556 @@
 000000b0: 6f72 6564 2c20 6370 7269 6e74 0d0a 6672  ored, cprint..fr
 000000c0: 6f6d 2049 5079 7468 6f6e 2e64 6973 706c  om IPython.displ
 000000d0: 6179 2069 6d70 6f72 7420 6469 7370 6c61  ay import displa
 000000e0: 792c 2049 6d61 6765 2c20 4854 4d4c 0d0a  y, Image, HTML..
 000000f0: 696d 706f 7274 2077 6172 6e69 6e67 730d  import warnings.
 00000100: 0a77 6172 6e69 6e67 732e 6669 6c74 6572  .warnings.filter
 00000110: 7761 726e 696e 6773 2827 6967 6e6f 7265  warnings('ignore
-00000120: 2729 0d0a 696d 706f 7274 2070 726f 6d70  ')..import promp
-00000130: 7473 0d0a 0d0a 636c 6173 7320 4261 6d62  ts....class Bamb
-00000140: 6f6f 4149 3a0d 0a20 2020 2064 6566 205f  ooAI:..    def _
-00000150: 5f69 6e69 745f 5f28 7365 6c66 2c20 6466  _init__(self, df
-00000160: 3a20 7064 2e44 6174 6146 7261 6d65 2c0d  : pd.DataFrame,.
-00000170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000180: 2020 6d61 785f 636f 6e76 6572 7361 7469    max_conversati
-00000190: 6f6e 733a 2069 6e74 203d 2032 202c 0d0a  ons: int = 2 ,..
-000001a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000001b0: 206c 6c6d 3a20 7374 7220 3d20 2767 7074   llm: str = 'gpt
-000001c0: 2d33 2e35 2d74 7572 626f 272c 0d0a 2020  -3.5-turbo',..  
-000001d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000001e0: 6562 7567 3a20 626f 6f6c 203d 2046 616c  ebug: bool = Fal
-000001f0: 7365 2c20 0d0a 2020 2020 2020 2020 2020  se, ..          
-00000200: 2020 2020 2020 2072 616e 6b3a 2062 6f6f         rank: boo
-00000210: 6c20 3d20 4661 6c73 652c 200d 0a20 2020  l = False, ..   
-00000220: 2020 2020 2020 2020 2020 2020 2020 6c6c                ll
-00000230: 6d5f 7377 6974 6368 3a20 626f 6f6c 203d  m_switch: bool =
-00000240: 2046 616c 7365 2c20 0d0a 2020 2020 2020   False, ..      
-00000250: 2020 2020 2020 2020 2020 2065 7870 6c6f             explo
-00000260: 7261 746f 7279 3a20 626f 6f6c 203d 2054  ratory: bool = T
-00000270: 7275 652c 200d 0a20 2020 2020 2020 2020  rue, ..         
-00000280: 2020 2020 2020 2020 666c 6f77 5f64 6961          flow_dia
-00000290: 6772 616d 3a20 626f 6f6c 203d 2046 616c  gram: bool = Fal
-000002a0: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
-000002b0: 2020 2020 2029 3a0d 0a0d 0a20 2020 2020       ):....     
-000002c0: 2020 2073 656c 662e 4150 495f 4b45 5920     self.API_KEY 
-000002d0: 3d20 6f73 2e65 6e76 6972 6f6e 2e67 6574  = os.environ.get
-000002e0: 2827 4f50 454e 4149 5f41 5049 5f4b 4559  ('OPENAI_API_KEY
-000002f0: 2729 0d0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00000300: 2e4d 4158 5f45 5252 4f52 5f43 4f52 5245  .MAX_ERROR_CORRE
-00000310: 4354 494f 4e53 203d 2035 0d0a 2020 2020  CTIONS = 5..    
-00000320: 2020 2020 2320 5365 7420 7468 6520 6d61      # Set the ma
-00000330: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-00000340: 7175 6573 7469 6f6e 2f61 6e73 7765 7220  question/answer 
-00000350: 7061 6972 7320 746f 2062 6520 6b65 7074  pairs to be kept
-00000360: 2069 6e20 7468 6520 636f 6e76 6572 7361   in the conversa
-00000370: 7469 6f6e 206d 656d 6d6f 7279 0d0a 2020  tion memmory..  
-00000380: 2020 2020 2020 7365 6c66 2e4d 4158 5f43        self.MAX_C
-00000390: 4f4e 5645 5253 4154 494f 4e53 203d 2028  ONVERSATIONS = (
-000003a0: 6d61 785f 636f 6e76 6572 7361 7469 6f6e  max_conversation
-000003b0: 732a 3229 202d 2031 0d0a 2020 2020 2020  s*2) - 1..      
-000003c0: 2020 0d0a 2020 2020 2020 2020 2320 5374    ..        # St
-000003d0: 6f72 6520 7468 6520 6f72 6967 696e 616c  ore the original
-000003e0: 2064 6174 6166 7261 6d65 2e20 5468 6973   dataframe. This
-000003f0: 2077 696c 6c20 6265 2075 7365 6420 746f   will be used to
-00000400: 2072 6573 6574 2074 6865 2064 6174 6166   reset the dataf
-00000410: 7261 6d65 2062 6566 6f72 6520 6578 6563  rame before exec
-00000420: 7574 696e 6720 7468 6520 636f 6465 0d0a  uting the code..
-00000430: 2020 2020 2020 2020 7365 6c66 2e6f 7269          self.ori
-00000440: 6769 6e61 6c5f 6466 203d 2064 660d 0a20  ginal_df = df.. 
-00000450: 2020 2020 2020 2073 656c 662e 6466 203d         self.df =
-00000460: 2064 662e 636f 7079 2829 2020 2320 6d61   df.copy()  # ma
-00000470: 6b65 2061 2063 6f70 7920 6f66 2074 6865  ke a copy of the
-00000480: 2064 6174 6166 7261 6d65 0d0a 2020 2020   dataframe..    
-00000490: 2020 2020 7365 6c66 2e64 665f 6865 6164      self.df_head
-000004a0: 203d 2073 656c 662e 6f72 6967 696e 616c   = self.original
-000004b0: 5f64 662e 6865 6164 2831 290d 0a20 2020  _df.head(1)..   
-000004c0: 200d 0a20 2020 2020 2020 2073 656c 662e   ..        self.
-000004d0: 6c6c 6d20 3d20 6c6c 6d0d 0a20 2020 2020  llm = llm..     
-000004e0: 2020 2023 2053 6574 2074 6865 2064 6562     # Set the deb
-000004f0: 7567 206d 6f64 652e 2054 6869 7320 6d6f  ug mode. This mo
-00000500: 6465 2069 7320 5472 7565 2077 6865 6e20  de is True when 
-00000510: 796f 7520 7761 6e74 2074 6865 206d 6f64  you want the mod
-00000520: 656c 2074 6f20 6465 6275 6720 7468 6520  el to debug the 
-00000530: 636f 6465 2061 6e64 2063 6f72 7265 6374  code and correct
-00000540: 2069 742e 0d0a 2020 2020 2020 2020 7365   it...        se
-00000550: 6c66 2e64 6562 7567 203d 2064 6562 7567  lf.debug = debug
-00000560: 0d0a 2020 2020 2020 2020 2320 5365 7420  ..        # Set 
-00000570: 7468 6520 6c6c 6d5f 7377 6974 6368 206d  the llm_switch m
-00000580: 6f64 652e 2054 6869 7320 6d6f 6465 2069  ode. This mode i
-00000590: 7320 5472 7565 2077 6865 6e20 796f 7520  s True when you 
-000005a0: 7761 6e74 2074 6865 206d 6f64 656c 2074  want the model t
-000005b0: 6f20 7377 6974 6368 2074 6f20 6770 742d  o switch to gpt-
-000005c0: 3420 666f 7220 6465 6275 6767 696e 672c  4 for debugging,
-000005d0: 2065 7272 6f72 2063 6f72 7265 6374 696f   error correctio
-000005e0: 6e20 616e 6420 7261 6e6b 696e 672e 0d0a  n and ranking...
-000005f0: 2020 2020 2020 2020 7365 6c66 2e6c 6c6d          self.llm
-00000600: 5f73 7769 7463 6820 3d20 6c6c 6d5f 7377  _switch = llm_sw
-00000610: 6974 6368 0d0a 2020 2020 2020 2020 2320  itch..        # 
-00000620: 5365 7420 7468 6520 7261 6e6b 206d 6f64  Set the rank mod
-00000630: 652e 2054 6869 7320 6d6f 6465 2069 7320  e. This mode is 
-00000640: 5472 7565 2077 6865 6e20 796f 7520 7761  True when you wa
-00000650: 6e74 2074 6865 206d 6f64 656c 2074 6f20  nt the model to 
-00000660: 7261 6e6b 2074 6865 2067 656e 6572 6174  rank the generat
-00000670: 6564 2063 6f64 652e 0d0a 2020 2020 2020  ed code...      
-00000680: 2020 7365 6c66 2e72 616e 6b20 3d20 7261    self.rank = ra
-00000690: 6e6b 0d0a 0d0a 2020 2020 2020 2020 2320  nk....        # 
-000006a0: 5365 7420 7468 6520 6578 706c 6f72 6174  Set the explorat
-000006b0: 6f72 7920 6d6f 6465 2e20 5468 6973 206d  ory mode. This m
-000006c0: 6f64 6520 6973 2054 7275 6520 7768 656e  ode is True when
-000006d0: 2079 6f75 2077 616e 7420 7468 6520 6d6f   you want the mo
-000006e0: 6465 6c20 746f 2065 7661 6c75 6174 6520  del to evaluate 
-000006f0: 7468 6520 6f72 6967 696e 616c 2070 726f  the original pro
-00000700: 6d70 7420 616e 6420 6272 6561 6b20 6974  mpt and break it
-00000710: 2064 6f77 6e20 696e 2068 6575 7269 7374   down in heurist
-00000720: 6963 2061 6c67 6f72 6974 686d 2e0d 0a20  ic algorithm... 
-00000730: 2020 2020 2020 2073 656c 662e 6578 706c         self.expl
-00000740: 6f72 6174 6f72 7920 3d20 6578 706c 6f72  oratory = explor
-00000750: 6174 6f72 790d 0a0d 0a20 2020 2020 2020  atory....       
-00000760: 2023 2053 6574 2074 6865 2066 6c6f 775f   # Set the flow_
-00000770: 6469 6167 7261 6d20 6d6f 6465 2e20 5468  diagram mode. Th
-00000780: 6973 206d 6f64 6520 6973 2054 7275 6520  is mode is True 
-00000790: 7768 656e 2079 6f75 2077 616e 7420 7468  when you want th
-000007a0: 6520 6d6f 6465 6c20 746f 2067 656e 6572  e model to gener
-000007b0: 6174 6520 6120 666c 6f77 2064 6961 6772  ate a flow diagr
-000007c0: 616d 2e0d 0a20 2020 2020 2020 2073 656c  am...        sel
-000007d0: 662e 666c 6f77 5f64 6961 6772 616d 203d  f.flow_diagram =
-000007e0: 2066 6c6f 775f 6469 6167 7261 6d0d 0a20   flow_diagram.. 
-000007f0: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
-00000800: 2023 2050 726f 6d70 7473 0d0a 2020 2020   # Prompts..    
-00000810: 2020 2020 7365 6c66 2e74 6173 6b5f 6576      self.task_ev
-00000820: 616c 7561 7469 6f6e 203d 2070 726f 6d70  aluation = promp
-00000830: 7473 2e74 6173 6b5f 6576 616c 7561 7469  ts.task_evaluati
-00000840: 6f6e 0d0a 2020 2020 2020 2020 7365 6c66  on..        self
-00000850: 2e73 7973 7465 6d5f 7461 736b 203d 2070  .system_task = p
-00000860: 726f 6d70 7473 2e73 7973 7465 6d5f 7461  rompts.system_ta
-00000870: 736b 0d0a 2020 2020 2020 2020 7365 6c66  sk..        self
-00000880: 2e74 6173 6b20 3d20 7072 6f6d 7074 732e  .task = prompts.
-00000890: 7461 736b 0d0a 2020 2020 2020 2020 7365  task..        se
-000008a0: 6c66 2e65 7272 6f72 5f63 6f72 7265 6374  lf.error_correct
-000008b0: 5f74 6173 6b20 3d20 7072 6f6d 7074 732e  _task = prompts.
-000008c0: 6572 726f 725f 636f 7272 6563 745f 7461  error_correct_ta
-000008d0: 736b 0d0a 2020 2020 2020 2020 7365 6c66  sk..        self
-000008e0: 2e64 6562 7567 5f63 6f64 655f 7461 736b  .debug_code_task
-000008f0: 203d 2070 726f 6d70 7473 2e64 6562 7567   = prompts.debug
-00000900: 5f63 6f64 655f 7461 736b 2020 0d0a 2020  _code_task  ..  
-00000910: 2020 2020 2020 7365 6c66 2e72 616e 6b5f        self.rank_
-00000920: 616e 7377 6572 203d 2070 726f 6d70 7473  answer = prompts
-00000930: 2e72 616e 6b5f 616e 7377 6572 0d0a 2020  .rank_answer..  
-00000940: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
-00000950: 6f70 656e 6169 2e61 7069 5f6b 6579 203d  openai.api_key =
-00000960: 2073 656c 662e 4150 495f 4b45 590d 0a20   self.API_KEY.. 
-00000970: 2020 2020 2020 2023 2049 6e69 7469 616c         # Initial
-00000980: 697a 6520 7468 6520 746f 7461 6c20 746f  ize the total to
-00000990: 6b65 6e73 2075 7365 6420 6c69 7374 2e20  kens used list. 
-000009a0: 5468 6973 206c 6973 7420 7769 6c6c 2062  This list will b
-000009b0: 6520 7573 6564 2074 6f20 6b65 6570 2074  e used to keep t
-000009c0: 7261 636b 206f 6620 7468 6520 746f 7461  rack of the tota
-000009d0: 6c20 746f 6b65 6e73 2075 7365 6420 6279  l tokens used by
-000009e0: 2074 6865 206d 6f64 656c 0d0a 2020 2020   the model..    
-000009f0: 2020 2020 7365 6c66 2e74 6f74 616c 5f74      self.total_t
-00000a00: 6f6b 656e 735f 7573 6564 203d 205b 5d0d  okens_used = [].
-00000a10: 0a0d 0a20 2020 2064 6566 206d 6d28 7365  ...    def mm(se
-00000a20: 6c66 2c20 6772 6170 6829 3a0d 0a20 2020  lf, graph):..   
-00000a30: 2020 2020 2067 7261 7068 6279 7465 7320       graphbytes 
-00000a40: 3d20 6772 6170 682e 656e 636f 6465 2822  = graph.encode("
-00000a50: 6173 6369 6922 290d 0a20 2020 2020 2020  ascii")..       
-00000a60: 2062 6173 6536 345f 6279 7465 7320 3d20   base64_bytes = 
-00000a70: 6261 7365 3634 2e62 3634 656e 636f 6465  base64.b64encode
-00000a80: 2867 7261 7068 6279 7465 7329 0d0a 2020  (graphbytes)..  
-00000a90: 2020 2020 2020 6261 7365 3634 5f73 7472        base64_str
-00000aa0: 696e 6720 3d20 6261 7365 3634 5f62 7974  ing = base64_byt
-00000ab0: 6573 2e64 6563 6f64 6528 2261 7363 6969  es.decode("ascii
-00000ac0: 2229 0d0a 2020 2020 2020 2020 696d 675f  ")..        img_
-00000ad0: 7572 6c20 3d20 2268 7474 7073 3a2f 2f6d  url = "https://m
-00000ae0: 6572 6d61 6964 2e69 6e6b 2f69 6d67 2f22  ermaid.ink/img/"
-00000af0: 202b 2062 6173 6536 345f 7374 7269 6e67   + base64_string
-00000b00: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00000b10: 2069 6d67 5f75 726c 0d0a 0d0a 2020 2020   img_url....    
-00000b20: 6465 6620 6c6c 6d5f 6361 6c6c 2873 656c  def llm_call(sel
-00000b30: 662c 206d 6573 7361 6765 733a 2073 7472  f, messages: str
-00000b40: 2c20 7465 6d70 6572 6174 7572 653a 2066  , temperature: f
-00000b50: 6c6f 6174 203d 2030 2c20 6d61 785f 746f  loat = 0, max_to
-00000b60: 6b65 6e73 3a20 696e 7420 3d20 3230 3030  kens: int = 2000
-00000b70: 293a 0d0a 2020 2020 2020 2020 7265 7370  ):..        resp
-00000b80: 6f6e 7365 203d 206f 7065 6e61 692e 4368  onse = openai.Ch
-00000b90: 6174 436f 6d70 6c65 7469 6f6e 2e63 7265  atCompletion.cre
-00000ba0: 6174 6528 0d0a 2020 2020 2020 2020 2020  ate(..          
-00000bb0: 2020 6d6f 6465 6c3d 7365 6c66 2e6c 6c6d    model=self.llm
-00000bc0: 2c0d 0a20 2020 2020 2020 2020 2020 206d  ,..            m
-00000bd0: 6573 7361 6765 733d 6d65 7373 6167 6573  essages=messages
-00000be0: 2c0d 0a20 2020 2020 2020 2020 2020 2074  ,..            t
-00000bf0: 656d 7065 7261 7475 7265 3d74 656d 7065  emperature=tempe
-00000c00: 7261 7475 7265 2c0d 0a20 2020 2020 2020  rature,..       
-00000c10: 2020 2020 206d 6178 5f74 6f6b 656e 733d       max_tokens=
-00000c20: 6d61 785f 746f 6b65 6e73 2c0d 0a20 2020  max_tokens,..   
-00000c30: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
-00000c40: 2020 636f 6e74 656e 7420 3d20 7265 7370    content = resp
-00000c50: 6f6e 7365 2e63 686f 6963 6573 5b30 5d2e  onse.choices[0].
-00000c60: 6d65 7373 6167 652e 636f 6e74 656e 742e  message.content.
-00000c70: 7374 7269 7028 290d 0a20 2020 2020 2020  strip()..       
-00000c80: 2074 6f6b 656e 735f 7573 6564 203d 2072   tokens_used = r
-00000c90: 6573 706f 6e73 652e 7573 6167 652e 746f  esponse.usage.to
-00000ca0: 7461 6c5f 746f 6b65 6e73 0d0a 0d0a 2020  tal_tokens....  
-00000cb0: 2020 2020 2020 7265 7475 726e 2063 6f6e        return con
-00000cc0: 7465 6e74 2c20 746f 6b65 6e73 5f75 7365  tent, tokens_use
-00000cd0: 640d 0a20 2020 200d 0a20 2020 2023 2046  d..    ..    # F
-00000ce0: 756e 6374 696f 6e73 2074 6f20 7361 6e69  unctions to sani
-00000cf0: 7469 7a65 2074 6865 206f 7574 7075 7420  tize the output 
-00000d00: 6672 6f6d 2074 6865 204c 4c4d 0d0a 2020  from the LLM..  
-00000d10: 2020 6465 6620 5f65 7874 7261 6374 5f63    def _extract_c
-00000d20: 6f64 6528 7365 6c66 2c72 6573 706f 6e73  ode(self,respons
-00000d30: 653a 2073 7472 2c20 7365 7061 7261 746f  e: str, separato
-00000d40: 723a 2073 7472 203d 2022 6060 6022 2920  r: str = "```") 
-00000d50: 2d3e 2073 7472 3a0d 0a0d 0a20 2020 2020  -> str:....     
-00000d60: 2020 2023 2044 6566 696e 6520 6120 626c     # Define a bl
-00000d70: 6163 6b6c 6973 7420 6f66 2050 7974 686f  acklist of Pytho
-00000d80: 6e20 6b65 7977 6f72 6473 2061 6e64 2066  n keywords and f
-00000d90: 756e 6374 696f 6e73 2074 6861 7420 6172  unctions that ar
-00000da0: 6520 6e6f 7420 616c 6c6f 7765 640d 0a20  e not allowed.. 
-00000db0: 2020 2020 2020 2062 6c61 636b 6c69 7374         blacklist
-00000dc0: 203d 205b 276f 7327 2c27 7375 6270 726f   = ['os','subpro
-00000dd0: 6365 7373 272c 2773 7973 272c 2765 7661  cess','sys','eva
-00000de0: 6c27 2c27 6578 6563 272c 2766 696c 6527  l','exec','file'
-00000df0: 2c27 736f 636b 6574 272c 2775 726c 6c69  ,'socket','urlli
-00000e00: 6227 2c0d 0a20 2020 2020 2020 2020 2020  b',..           
-00000e10: 2020 2020 2020 2020 2027 7368 7574 696c           'shutil
-00000e20: 272c 2770 6963 6b6c 6527 2c27 6374 7970  ','pickle','ctyp
-00000e30: 6573 272c 276d 756c 7469 7072 6f63 6573  es','multiproces
-00000e40: 7369 6e67 272c 2774 656d 7066 696c 6527  sing','tempfile'
-00000e50: 2c27 676c 6f62 272c 2763 6f64 6527 2c27  ,'glob','code','
-00000e60: 7074 7927 2c27 636f 6d6d 616e 6473 272c  pty','commands',
-00000e70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00000e80: 2020 2020 2020 2772 6571 7565 7374 7327        'requests'
-00000e90: 2c27 6367 6927 2c27 6367 6974 6227 2c27  ,'cgi','cgitb','
-00000ea0: 786d 6c2e 6574 7265 652e 456c 656d 656e  xml.etree.Elemen
-00000eb0: 7454 7265 6527 2c27 6275 696c 7469 6e73  tTree','builtins
-00000ec0: 270d 0a20 2020 2020 2020 2020 2020 2020  '..             
-00000ed0: 2020 2020 2020 205d 0d0a 2020 2020 2020         ]..      
-00000ee0: 2020 0d0a 2020 2020 2020 2020 2320 5365    ..        # Se
-00000ef0: 6172 6368 2066 6f72 2061 2070 6174 7465  arch for a patte
-00000f00: 726e 2062 6574 7765 656e 203c 7265 666c  rn between <refl
-00000f10: 6563 7469 6f6e 3e20 616e 6420 3c2f 7265  ection> and </re
-00000f20: 666c 6563 7469 6f6e 3e20 696e 2074 6865  flection> in the
-00000f30: 2072 6573 706f 6e73 650d 0a20 2020 2020   response..     
-00000f40: 2020 206d 6174 6368 203d 2072 652e 7365     match = re.se
-00000f50: 6172 6368 2872 223c 7265 666c 6563 7469  arch(r"<reflecti
-00000f60: 6f6e 3e28 2e2a 293c 2f72 6566 6c65 6374  on>(.*)</reflect
-00000f70: 696f 6e3e 222c 2072 6573 706f 6e73 652c  ion>", response,
-00000f80: 2072 652e 444f 5441 4c4c 290d 0a20 2020   re.DOTALL)..   
-00000f90: 2020 2020 2069 6620 6d61 7463 683a 0d0a       if match:..
-00000fa0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00000fb0: 2061 206d 6174 6368 2069 7320 666f 756e   a match is foun
-00000fc0: 642c 2065 7874 7261 6374 2074 6865 2072  d, extract the r
-00000fd0: 6566 6c65 6374 696f 6e20 6265 7477 6565  eflection betwee
-00000fe0: 6e20 3c72 6566 6c65 6374 696f 6e3e 2061  n <reflection> a
-00000ff0: 6e64 203c 2f72 6566 6c65 6374 696f 6e3e  nd </reflection>
-00001000: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00001010: 666c 6563 7469 6f6e 203d 206d 6174 6368  flection = match
-00001020: 2e67 726f 7570 2831 290d 0a20 2020 2020  .group(1)..     
-00001030: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00001040: 2020 2020 2020 7265 666c 6563 7469 6f6e        reflection
-00001050: 203d 2022 220d 0a0d 0a20 2020 2020 2020   = ""....       
-00001060: 2023 2053 6561 7263 6820 666f 7220 6120   # Search for a 
-00001070: 7061 7474 6572 6e20 6265 7477 6565 6e20  pattern between 
-00001080: 3c66 6c6f 773e 2061 6e64 203c 2f66 6c6f  <flow> and </flo
-00001090: 773e 2069 6e20 7468 6520 7265 7370 6f6e  w> in the respon
-000010a0: 7365 0d0a 2020 2020 2020 2020 6d61 7463  se..        matc
-000010b0: 6820 3d20 7265 2e73 6561 7263 6828 7222  h = re.search(r"
-000010c0: 3c66 6c6f 773e 282e 2a29 3c2f 666c 6f77  <flow>(.*)</flow
-000010d0: 3e22 2c20 7265 7370 6f6e 7365 2c20 7265  >", response, re
-000010e0: 2e44 4f54 414c 4c29 0d0a 2020 2020 2020  .DOTALL)..      
-000010f0: 2020 6966 206d 6174 6368 3a0d 0a20 2020    if match:..   
-00001100: 2020 2020 2020 2020 2023 2049 6620 6120           # If a 
-00001110: 6d61 7463 6820 6973 2066 6f75 6e64 2c20  match is found, 
-00001120: 6578 7472 6163 7420 7468 6520 7265 666c  extract the refl
-00001130: 6563 7469 6f6e 2062 6574 7765 656e 203c  ection between <
-00001140: 666c 6f77 3e20 616e 6420 3c2f 666c 6f77  flow> and </flow
-00001150: 3e0d 0a20 2020 2020 2020 2020 2020 2066  >..            f
-00001160: 6c6f 7720 3d20 6d61 7463 682e 6772 6f75  low = match.grou
-00001170: 7028 3129 0d0a 2020 2020 2020 2020 656c  p(1)..        el
-00001180: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00001190: 2066 6c6f 7720 3d20 2222 0d0a 0d0a 2020   flow = ""....  
-000011a0: 2020 2020 2020 2320 5365 6172 6368 2066        # Search f
-000011b0: 6f72 2061 2070 6174 7465 726e 2062 6574  or a pattern bet
-000011c0: 7765 656e 203c 7261 6e6b 3e20 616e 6420  ween <rank> and 
-000011d0: 3c2f 7261 6e6b 3e20 696e 2074 6865 2072  </rank> in the r
-000011e0: 6573 706f 6e73 650d 0a20 2020 2020 2020  esponse..       
-000011f0: 206d 6174 6368 203d 2072 652e 7365 6172   match = re.sear
-00001200: 6368 2872 223c 7261 6e6b 3e28 2e2a 293c  ch(r"<rank>(.*)<
-00001210: 2f72 616e 6b3e 222c 2072 6573 706f 6e73  /rank>", respons
-00001220: 6529 0d0a 2020 2020 2020 2020 6966 206d  e)..        if m
-00001230: 6174 6368 3a0d 0a20 2020 2020 2020 2020  atch:..         
-00001240: 2020 2023 2049 6620 6120 6d61 7463 6820     # If a match 
-00001250: 6973 2066 6f75 6e64 2c20 6578 7472 6163  is found, extrac
-00001260: 7420 7468 6520 7265 666c 6563 7469 6f6e  t the reflection
-00001270: 2062 6574 7765 656e 203c 7261 6e6b 3e20   between <rank> 
-00001280: 616e 6420 3c2f 7261 6e6b 3e0d 0a20 2020  and </rank>..   
-00001290: 2020 2020 2020 2020 2072 616e 6b20 3d20           rank = 
-000012a0: 6d61 7463 682e 6772 6f75 7028 3129 0d0a  match.group(1)..
-000012b0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-000012c0: 2020 2020 2020 2020 2020 2072 616e 6b20             rank 
-000012d0: 3d20 2222 0d0a 0d0a 2020 2020 2020 2020  = ""....        
-000012e0: 2320 5365 6172 6368 2066 6f72 2061 2070  # Search for a p
-000012f0: 6174 7465 726e 2062 6574 7765 656e 203c  attern between <
-00001300: 636f 6465 3e20 616e 6420 3c2f 636f 6465  code> and </code
-00001310: 3e20 696e 2074 6865 2065 7874 7261 6374  > in the extract
-00001320: 6564 2063 6f64 650d 0a20 2020 2020 2020  ed code..       
-00001330: 206d 6174 6368 203d 2072 652e 7365 6172   match = re.sear
-00001340: 6368 2872 223c 636f 6465 3e28 2e2a 293c  ch(r"<code>(.*)<
-00001350: 2f63 6f64 653e 222c 2072 6573 706f 6e73  /code>", respons
-00001360: 652c 2072 652e 444f 5441 4c4c 290d 0a20  e, re.DOTALL).. 
-00001370: 2020 2020 2020 2069 6620 6d61 7463 683a         if match:
-00001380: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00001390: 4966 2061 206d 6174 6368 2069 7320 666f  If a match is fo
-000013a0: 756e 642c 2065 7874 7261 6374 2074 6865  und, extract the
-000013b0: 2063 6f64 6520 6265 7477 6565 6e20 3c63   code between <c
-000013c0: 6f64 653e 2061 6e64 203c 2f63 6f64 653e  ode> and </code>
-000013d0: 0d0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-000013e0: 6465 203d 206d 6174 6368 2e67 726f 7570  de = match.group
-000013f0: 2831 290d 0a20 2020 2020 2020 2020 2020  (1)..           
-00001400: 2023 2049 6620 7468 6520 7265 7370 6f6e   # If the respon
-00001410: 7365 2063 6f6e 7461 696e 7320 7468 6520  se contains the 
-00001420: 7365 7061 7261 746f 722c 2065 7874 7261  separator, extra
-00001430: 6374 2074 6865 2063 6f64 6520 626c 6f63  ct the code bloc
-00001440: 6b20 6265 7477 6565 6e20 7468 6520 7365  k between the se
-00001450: 7061 7261 746f 7273 0d0a 2020 2020 2020  parators..      
-00001460: 2020 2020 2020 6966 206c 656e 2863 6f64        if len(cod
-00001470: 652e 7370 6c69 7428 7365 7061 7261 746f  e.split(separato
-00001480: 7229 2920 3e20 313a 0d0a 2020 2020 2020  r)) > 1:..      
-00001490: 2020 2020 2020 2020 2020 636f 6465 203d            code =
-000014a0: 2063 6f64 652e 7370 6c69 7428 7365 7061   code.split(sepa
-000014b0: 7261 746f 7229 5b31 5d0d 0a0d 0a20 2020  rator)[1]....   
-000014c0: 2020 2020 2023 2049 6620 7468 6520 7265       # If the re
-000014d0: 7370 6f6e 7365 2063 6f6e 7461 696e 7320  sponse contains 
-000014e0: 7468 6520 7365 7061 7261 746f 722c 2065  the separator, e
-000014f0: 7874 7261 6374 2074 6865 2063 6f64 6520  xtract the code 
-00001500: 626c 6f63 6b20 6265 7477 6565 6e20 7468  block between th
-00001510: 6520 7365 7061 7261 746f 7273 0d0a 2020  e separators..  
-00001520: 2020 2020 2020 6966 206c 656e 2872 6573        if len(res
-00001530: 706f 6e73 652e 7370 6c69 7428 7365 7061  ponse.split(sepa
-00001540: 7261 746f 7229 2920 3e20 313a 0d0a 2020  rator)) > 1:..  
-00001550: 2020 2020 2020 2020 2020 636f 6465 203d            code =
-00001560: 2072 6573 706f 6e73 652e 7370 6c69 7428   response.split(
-00001570: 7365 7061 7261 746f 7229 5b31 5d0d 0a20  separator)[1].. 
-00001580: 2020 2020 2020 2020 2020 200d 0a20 2020             ..   
-00001590: 2020 2020 2023 2052 656d 6f76 6520 7468       # Remove th
-000015a0: 6520 2270 7974 686f 6e22 206f 7220 2270  e "python" or "p
-000015b0: 7922 2070 7265 6669 7820 6966 2070 7265  y" prefix if pre
-000015c0: 7365 6e74 0d0a 2020 2020 2020 2020 6966  sent..        if
-000015d0: 2072 652e 6d61 7463 6828 7222 5e28 7079   re.match(r"^(py
-000015e0: 7468 6f6e 7c70 7929 222c 2063 6f64 6529  thon|py)", code)
-000015f0: 3a0d 0a20 2020 2020 2020 2020 2020 2063  :..            c
-00001600: 6f64 6520 3d20 7265 2e73 7562 2872 225e  ode = re.sub(r"^
-00001610: 2870 7974 686f 6e7c 7079 2922 2c20 2222  (python|py)", ""
-00001620: 2c20 636f 6465 290d 0a20 2020 2020 2020  , code)..       
-00001630: 2023 2049 6620 7468 6520 636f 6465 2069   # If the code i
-00001640: 7320 6265 7477 6565 6e20 7369 6e67 6c65  s between single
-00001650: 2062 6163 6b74 6963 6b73 2c20 6578 7472   backticks, extr
-00001660: 6163 7420 7468 6520 636f 6465 2062 6574  act the code bet
-00001670: 7765 656e 2074 6865 6d0d 0a20 2020 2020  ween them..     
-00001680: 2020 2069 6620 7265 2e6d 6174 6368 2872     if re.match(r
-00001690: 225e 602e 2a60 2422 2c20 636f 6465 293a  "^`.*`$", code):
-000016a0: 0d0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-000016b0: 6465 203d 2072 652e 7375 6228 7222 5e60  de = re.sub(r"^`
-000016c0: 282e 2a29 6024 222c 2072 225c 3122 2c20  (.*)`$", r"\1", 
-000016d0: 636f 6465 290d 0a0d 0a20 2020 2020 2020  code)....       
-000016e0: 2023 2052 656d 6f76 6520 616e 7920 696e   # Remove any in
-000016f0: 7374 616e 6365 7320 6f66 2022 6466 203d  stances of "df =
-00001700: 2070 642e 7265 6164 5f63 7376 2827 6669   pd.read_csv('fi
-00001710: 6c65 6e61 6d65 2e63 7376 2729 2220 6672  lename.csv')" fr
-00001720: 6f6d 2074 6865 2063 6f64 650d 0a20 2020  om the code..   
-00001730: 2020 2020 2063 6f64 6520 3d20 7265 2e73       code = re.s
-00001740: 7562 2872 2264 665c 732a 3d5c 732a 7064  ub(r"df\s*=\s*pd
-00001750: 5c2e 7265 6164 5f63 7376 5c28 272e 2a3f  \.read_csv\('.*?
-00001760: 2728 2c2e 2a29 3f5c 2922 2c20 2222 2c20  '(,.*)?\)", "", 
-00001770: 636f 6465 290d 0a0d 0a20 2020 2020 2020  code)....       
-00001780: 2023 2044 6566 696e 6520 7468 6520 7265   # Define the re
-00001790: 6775 6c61 7220 6578 7072 6573 7369 6f6e  gular expression
-000017a0: 2070 6174 7465 726e 2074 6f20 6d61 7463   pattern to matc
-000017b0: 6820 7468 6520 626c 6163 6b6c 6973 7420  h the blacklist 
-000017c0: 6974 656d 730d 0a20 2020 2020 2020 2070  items..        p
-000017d0: 6174 7465 726e 203d 2072 225e 282e 2a5c  attern = r"^(.*\
-000017e0: 6228 2220 2b20 227c 222e 6a6f 696e 2862  b(" + "|".join(b
-000017f0: 6c61 636b 6c69 7374 2920 2b20 7222 295c  lacklist) + r")\
-00001800: 622e 2a29 2422 0d0a 0d0a 2020 2020 2020  b.*)$"....      
-00001810: 2020 2320 5265 706c 6163 6520 7468 6520    # Replace the 
-00001820: 626c 6163 6b6c 6973 7420 6974 656d 7320  blacklist items 
-00001830: 7769 7468 2063 6f6d 6d65 6e74 730d 0a20  with comments.. 
-00001840: 2020 2020 2020 2063 6f64 6520 3d20 7265         code = re
-00001850: 2e73 7562 2870 6174 7465 726e 2c20 7222  .sub(pattern, r"
-00001860: 2320 6e6f 7420 616c 6c6f 7765 6420 5c31  # not allowed \1
-00001870: 222c 2063 6f64 652c 2066 6c61 6773 3d72  ", code, flags=r
-00001880: 652e 4d55 4c54 494c 494e 4529 0d0a 0d0a  e.MULTILINE)....
-00001890: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
-000018a0: 2074 6865 2063 6c65 616e 6564 2061 6e64   the cleaned and
-000018b0: 2065 7874 7261 6374 6564 2063 6f64 650d   extracted code.
-000018c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000018d0: 636f 6465 2e73 7472 6970 2829 2c20 7265  code.strip(), re
-000018e0: 666c 6563 7469 6f6e 2e73 7472 6970 2829  flection.strip()
-000018f0: 2c20 666c 6f77 2e73 7472 6970 2829 0d0a  , flow.strip()..
-00001900: 2020 2020 0d0a 2020 2020 6465 6620 5f65      ..    def _e
-00001910: 7874 7261 6374 5f72 616e 6b28 7365 6c66  xtract_rank(self
-00001920: 2c72 6573 706f 6e73 653a 2073 7472 2920  ,response: str) 
-00001930: 2d3e 2073 7472 3a0d 0a0d 0a20 2020 2020  -> str:....     
-00001940: 2020 2023 2053 6561 7263 6820 666f 7220     # Search for 
-00001950: 6120 7061 7474 6572 6e20 6265 7477 6565  a pattern betwee
-00001960: 6e20 3c72 616e 6b3e 2061 6e64 203c 2f72  n <rank> and </r
-00001970: 616e 6b3e 2069 6e20 7468 6520 7265 7370  ank> in the resp
-00001980: 6f6e 7365 0d0a 2020 2020 2020 2020 6d61  onse..        ma
-00001990: 7463 6820 3d20 7265 2e73 6561 7263 6828  tch = re.search(
-000019a0: 7222 3c72 616e 6b3e 282e 2a29 3c2f 7261  r"<rank>(.*)</ra
-000019b0: 6e6b 3e22 2c20 7265 7370 6f6e 7365 290d  nk>", response).
-000019c0: 0a20 2020 2020 2020 2069 6620 6d61 7463  .        if matc
-000019d0: 683a 0d0a 2020 2020 2020 2020 2020 2020  h:..            
-000019e0: 2320 4966 2061 206d 6174 6368 2069 7320  # If a match is 
-000019f0: 666f 756e 642c 2065 7874 7261 6374 2074  found, extract t
-00001a00: 6865 2072 6566 6c65 6374 696f 6e20 6265  he reflection be
-00001a10: 7477 6565 6e20 3c72 616e 6b3e 2061 6e64  tween <rank> and
-00001a20: 203c 2f72 616e 6b3e 0d0a 2020 2020 2020   </rank>..      
-00001a30: 2020 2020 2020 7261 6e6b 203d 206d 6174        rank = mat
-00001a40: 6368 2e67 726f 7570 2831 290d 0a20 2020  ch.group(1)..   
-00001a50: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00001a60: 2020 2020 2020 2020 7261 6e6b 203d 2022          rank = "
-00001a70: 220d 0a0d 0a20 2020 2020 2020 2023 2052  "....        # R
-00001a80: 6574 7572 6e20 7468 6520 636c 6561 6e65  eturn the cleane
-00001a90: 6420 616e 6420 6578 7472 6163 7465 6420  d and extracted 
-00001aa0: 636f 6465 0d0a 2020 2020 2020 2020 7265  code..        re
-00001ab0: 7475 726e 2072 616e 6b2e 7374 7269 7028  turn rank.strip(
-00001ac0: 290d 0a20 2020 200d 0a20 2020 2064 6566  )..    ..    def
-00001ad0: 2074 6173 6b5f 6576 616c 2873 656c 662c   task_eval(self,
-00001ae0: 2071 7565 7374 696f 6e3d 4e6f 6e65 293a   question=None):
-00001af0: 0d0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
-00001b00: 6961 6c69 7a65 2074 6865 206d 6573 7361  ialize the messa
-00001b10: 6765 7320 6c69 7374 2077 6974 6820 6120  ges list with a 
-00001b20: 7379 7374 656d 206d 6573 7361 6765 2063  system message c
-00001b30: 6f6e 7461 696e 696e 6720 7468 6520 7461  ontaining the ta
-00001b40: 736b 2070 726f 6d70 740d 0a20 2020 2020  sk prompt..     
-00001b50: 2020 2065 7661 6c5f 6d65 7373 6167 6573     eval_messages
-00001b60: 203d 205b 7b22 726f 6c65 223a 2022 7379   = [{"role": "sy
-00001b70: 7374 656d 222c 2022 636f 6e74 656e 7422  stem", "content"
-00001b80: 3a20 7365 6c66 2e74 6173 6b5f 6576 616c  : self.task_eval
-00001b90: 7561 7469 6f6e 2e66 6f72 6d61 7428 7175  uation.format(qu
-00001ba0: 6573 7469 6f6e 2c20 7365 6c66 2e64 665f  estion, self.df_
-00001bb0: 6865 6164 2c29 7d5d 0d0a 0d0a 2020 2020  head,)}]....    
-00001bc0: 2020 2020 6966 2027 6970 796b 6572 6e65      if 'ipykerne
-00001bd0: 6c27 2069 6e20 7379 732e 6d6f 6475 6c65  l' in sys.module
-00001be0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00001bf0: 2320 4a75 7079 7465 7220 6e6f 7465 626f  # Jupyter notebo
-00001c00: 6f6b 206f 7220 6970 7974 686f 6e0d 0a20  ok or ipython.. 
-00001c10: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-00001c20: 6179 2848 544d 4c28 6627 3c70 2073 7479  ay(HTML(f'<p sty
-00001c30: 6c65 3d22 636f 6c6f 723a 6d61 6765 6e74  le="color:magent
-00001c40: 613b 223e 5c6e 4361 6c6c 696e 6720 4d6f  a;">\nCalling Mo
-00001c50: 6465 6c3a 207b 7365 6c66 2e6c 6c6d 7d3c  del: {self.llm}<
-00001c60: 2f70 3e27 2929 0d0a 2020 2020 2020 2020  /p>'))..        
-00001c70: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
-00001c80: 2866 273c 703e 3c62 2073 7479 6c65 3d22  (f'<p><b style="
-00001c90: 636f 6c6f 723a 6d61 6765 6e74 613b 223e  color:magenta;">
-00001ca0: 5472 7969 6e67 2074 6f20 6465 7465 726d  Trying to determ
-00001cb0: 696e 6520 7468 6520 6265 7374 206d 6574  ine the best met
-00001cc0: 686f 6420 746f 2061 6e61 6c79 7365 2079  hod to analyse y
-00001cd0: 6f75 7220 6461 7461 2c20 706c 6561 7365  our data, please
-00001ce0: 2077 6169 742e 2e2e 3c2f 623e 3c2f 703e   wait...</b></p>
-00001cf0: 3c62 723e 2729 290d 0a20 2020 2020 2020  <br>'))..       
-00001d00: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-00001d10: 2020 2020 2320 4f74 6865 7220 656e 7669      # Other envi
-00001d20: 726f 6e6d 656e 7420 286c 696b 6520 7465  ronment (like te
-00001d30: 726d 696e 616c 290d 0a20 2020 2020 2020  rminal)..       
-00001d40: 2020 2020 2070 7269 6e74 2863 6f6c 6f72       print(color
-00001d50: 6564 2866 225c 6e3e 2043 616c 6c69 6e67  ed(f"\n> Calling
-00001d60: 204d 6f64 656c 3a20 7b73 656c 662e 6c6c   Model: {self.ll
-00001d70: 6d7d 222c 2022 6d61 6765 6e74 6122 2929  m}", "magenta"))
-00001d80: 0d0a 2020 2020 2020 2020 2020 2020 6370  ..            cp
-00001d90: 7269 6e74 2866 225c 6e3e 2054 7279 696e  rint(f"\n> Tryin
-00001da0: 6720 746f 2064 6574 6572 6d69 6e65 2074  g to determine t
-00001db0: 6865 2062 6573 7420 6d65 7468 6f64 2074  he best method t
-00001dc0: 6f20 616e 616c 7973 6520 796f 7572 2064  o analyse your d
-00001dd0: 6174 612c 2070 6c65 6173 6520 7761 6974  ata, please wait
-00001de0: 2e2e 2e5c 6e22 2c20 276d 6167 656e 7461  ...\n", 'magenta
-00001df0: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
-00001e00: 5d29 0d0a 0d0a 2020 2020 2020 2020 2320  ])....        # 
-00001e10: 4675 6e63 7469 6f6e 2074 6f20 6469 7370  Function to disp
-00001e20: 6c61 7920 7265 7375 6c74 7320 6e69 6365  lay results nice
-00001e30: 6c79 0d0a 2020 2020 2020 2020 6465 6620  ly..        def 
-00001e40: 6469 7370 6c61 795f 7461 736b 2874 6173  display_task(tas
-00001e50: 6b29 3a0d 0a20 2020 2020 2020 2020 2020  k):..           
-00001e60: 2069 6620 2769 7079 6b65 726e 656c 2720   if 'ipykernel' 
-00001e70: 696e 2073 7973 2e6d 6f64 756c 6573 3a0d  in sys.modules:.
-00001e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001e90: 2023 204a 7570 7974 6572 206e 6f74 6562   # Jupyter noteb
-00001ea0: 6f6f 6b20 6f72 2069 7079 7468 6f6e 0d0a  ook or ipython..
-00001eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ec0: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-00001ed0: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-00001ee0: 723a 626c 7565 3b22 3e49 2068 6176 6520  r:blue;">I have 
-00001ef0: 6372 6561 7465 6420 7468 6520 666f 6c6c  created the foll
-00001f00: 6f77 696e 6720 7461 736b 206c 6973 742c  owing task list,
-00001f10: 2061 6e64 2077 696c 6c20 6e6f 7720 7472   and will now tr
-00001f20: 7920 746f 2065 7870 7265 7373 2069 7420  y to express it 
-00001f30: 696e 2063 6f64 653a 3c2f 623e 3c62 723e  in code:</b><br>
-00001f40: 3c70 7265 2073 7479 6c65 3d22 636f 6c6f  <pre style="colo
-00001f50: 723a 626c 6163 6b3b 223e 3c62 3e7b 7461  r:black;"><b>{ta
-00001f60: 736b 7d3c 2f62 3e3c 2f70 7265 3e3c 2f70  sk}</b></pre></p
-00001f70: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
-00001f80: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00001f90: 2020 2020 2020 2020 2020 2020 2023 204f               # O
-00001fa0: 7468 6572 2065 6e76 6972 6f6e 6d65 6e74  ther environment
-00001fb0: 2028 6c69 6b65 2074 6572 6d69 6e61 6c29   (like terminal)
-00001fc0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00001fd0: 2020 6370 7269 6e74 2866 225c 6e54 6173    cprint(f"\nTas
-00001fe0: 6b3a 5c6e 7b74 6173 6b7d 5c6e 222c 2027  k:\n{task}\n", '
-00001ff0: 6d61 6765 6e74 6127 2c20 6174 7472 733d  magenta', attrs=
-00002000: 5b27 626f 6c64 275d 290d 0a0d 0a20 2020  ['bold'])....   
-00002010: 2020 2020 2023 2043 616c 6c20 7468 6520       # Call the 
-00002020: 4f70 656e 4149 2041 5049 2061 6e64 2068  OpenAI API and h
-00002030: 616e 646c 6520 7261 7465 206c 696d 6974  andle rate limit
-00002040: 2065 7272 6f72 730d 0a20 2020 2020 2020   errors..       
-00002050: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
-00002060: 2020 206c 6c6d 5f72 6573 706f 6e73 652c     llm_response,
-00002070: 2074 6f6b 656e 735f 7573 6564 203d 2073   tokens_used = s
-00002080: 656c 662e 6c6c 6d5f 6361 6c6c 2865 7661  elf.llm_call(eva
-00002090: 6c5f 6d65 7373 6167 6573 2c74 656d 7065  l_messages,tempe
-000020a0: 7261 7475 7265 3d30 2920 2320 6869 6768  rature=0) # high
-000020b0: 6572 2074 656d 7065 7261 7475 7265 2072  er temperature r
-000020c0: 6573 756c 7473 2069 6e20 6d6f 7265 2022  esults in more "
-000020d0: 6372 6561 7469 7665 2220 616e 7377 6572  creative" answer
-000020e0: 7320 2873 6f6d 6574 696d 6573 2074 6f6f  s (sometimes too
-000020f0: 2063 7265 6174 6976 6520 3a2d 2929 0d0a   creative :-))..
-00002100: 2020 2020 2020 2020 2020 2020 0d0a 2020              ..  
-00002110: 2020 2020 2020 6578 6365 7074 206f 7065        except ope
-00002120: 6e61 692e 6572 726f 722e 5261 7465 4c69  nai.error.RateLi
-00002130: 6d69 7445 7272 6f72 3a0d 0a20 2020 2020  mitError:..     
-00002140: 2020 2020 2020 2070 7269 6e74 280d 0a20         print(.. 
-00002150: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00002160: 5468 6520 4f70 656e 4149 2041 5049 2072  The OpenAI API r
-00002170: 6174 6520 6c69 6d69 7420 6861 7320 6265  ate limit has be
-00002180: 656e 2065 7863 6565 6465 642e 2057 6169  en exceeded. Wai
-00002190: 7469 6e67 2031 3020 7365 636f 6e64 7320  ting 10 seconds 
-000021a0: 616e 6420 7472 7969 6e67 2061 6761 696e  and trying again
-000021b0: 2e22 0d0a 2020 2020 2020 2020 2020 2020  ."..            
-000021c0: 290d 0a20 2020 2020 2020 2020 2020 2074  )..            t
-000021d0: 696d 652e 736c 6565 7028 3130 290d 0a20  ime.sleep(10).. 
-000021e0: 2020 2020 2020 2020 2020 206c 6c6d 5f72             llm_r
-000021f0: 6573 706f 6e73 652c 2074 6f6b 656e 735f  esponse, tokens_
-00002200: 7573 6564 203d 2073 656c 662e 6c6c 6d5f  used = self.llm_
-00002210: 6361 6c6c 2865 7661 6c5f 6d65 7373 6167  call(eval_messag
-00002220: 6573 290d 0a0d 0a20 2020 2020 2020 2074  es)....        t
-00002230: 6173 6b20 3d20 6c6c 6d5f 7265 7370 6f6e  ask = llm_respon
-00002240: 7365 0d0a 2020 2020 2020 2020 0d0a 2020  se..        ..  
-00002250: 2020 2020 2020 6469 7370 6c61 795f 7461        display_ta
-00002260: 736b 2874 6173 6b29 0d0a 0d0a 2020 2020  sk(task)....    
-00002270: 2020 2020 7365 6c66 2e74 6f74 616c 5f74      self.total_t
-00002280: 6f6b 656e 735f 7573 6564 2e61 7070 656e  okens_used.appen
-00002290: 6428 746f 6b65 6e73 5f75 7365 6429 0d0a  d(tokens_used)..
-000022a0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000022b0: 2074 6173 6b0d 0a0d 0a20 2020 2064 6566   task....    def
-000022c0: 2064 6562 7567 5f63 6f64 6528 7365 6c66   debug_code(self
-000022d0: 2c63 6f64 652c 7175 6573 7469 6f6e 293a  ,code,question):
-000022e0: 0d0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
-000022f0: 6961 6c69 7a65 2074 6865 206d 6573 7361  ialize the messa
-00002300: 6765 7320 6c69 7374 2077 6974 6820 6120  ges list with a 
-00002310: 7379 7374 656d 206d 6573 7361 6765 2063  system message c
-00002320: 6f6e 7461 696e 696e 6720 7468 6520 7461  ontaining the ta
-00002330: 736b 2070 726f 6d70 740d 0a20 2020 2020  sk prompt..     
-00002340: 2020 2064 6562 7567 5f6d 6573 7361 6765     debug_message
-00002350: 7320 3d20 5b7b 2272 6f6c 6522 3a20 2273  s = [{"role": "s
-00002360: 7973 7465 6d22 2c20 2263 6f6e 7465 6e74  ystem", "content
-00002370: 223a 2073 656c 662e 6465 6275 675f 636f  ": self.debug_co
-00002380: 6465 5f74 6173 6b2e 666f 726d 6174 2863  de_task.format(c
-00002390: 6f64 652c 7175 6573 7469 6f6e 297d 5d0d  ode,question)}].
-000023a0: 0a0d 0a20 2020 2020 2020 2069 6620 2769  ...        if 'i
-000023b0: 7079 6b65 726e 656c 2720 696e 2073 7973  pykernel' in sys
-000023c0: 2e6d 6f64 756c 6573 3a0d 0a20 2020 2020  .modules:..     
-000023d0: 2020 2020 2020 2023 204a 7570 7974 6572         # Jupyter
-000023e0: 206e 6f74 6562 6f6f 6b20 6f72 2069 7079   notebook or ipy
-000023f0: 7468 6f6e 0d0a 2020 2020 2020 2020 2020  thon..          
-00002400: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
-00002410: 273c 7020 7374 796c 653d 2263 6f6c 6f72  '<p style="color
-00002420: 3a6d 6167 656e 7461 3b22 3e5c 6e43 616c  :magenta;">\nCal
-00002430: 6c69 6e67 204d 6f64 656c 3a20 7b73 656c  ling Model: {sel
-00002440: 662e 6c6c 6d7d 3c2f 703e 2729 290d 0a20  f.llm}</p>')).. 
-00002450: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-00002460: 6179 2848 544d 4c28 6627 3c70 3e3c 6220  ay(HTML(f'<p><b 
-00002470: 7374 796c 653d 2263 6f6c 6f72 3a6d 6167  style="color:mag
-00002480: 656e 7461 3b22 3e49 2068 6176 6520 7265  enta;">I have re
-00002490: 6365 6976 6564 2074 6865 2066 6972 7374  ceived the first
-000024a0: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
-000024b0: 636f 6465 2e20 4920 616d 2073 656e 6469  code. I am sendi
-000024c0: 6e67 2069 7420 6261 636b 2074 6f20 4c4c  ng it back to LL
-000024d0: 4d20 746f 2067 6574 2069 7420 6368 6563  M to get it chec
-000024e0: 6b65 6420 666f 7220 616e 7920 6572 726f  ked for any erro
-000024f0: 7273 2c20 6275 6773 206f 7220 696e 636f  rs, bugs or inco
-00002500: 6e73 6973 7465 6e63 6965 732c 2061 6e64  nsistencies, and
-00002510: 2063 6f72 7265 6374 696f 6e20 6966 206e   correction if n
-00002520: 6563 6573 7361 7279 2e20 506c 6561 7365  ecessary. Please
-00002530: 2077 6169 742e 2e2e 3c2f 623e 3c2f 703e   wait...</b></p>
-00002540: 3c62 723e 2729 290d 0a20 2020 2020 2020  <br>'))..       
-00002550: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-00002560: 2020 2020 2320 4f74 6865 7220 656e 7669      # Other envi
-00002570: 726f 6e6d 656e 7420 286c 696b 6520 7465  ronment (like te
-00002580: 726d 696e 616c 290d 0a20 2020 2020 2020  rminal)..       
-00002590: 2020 2020 2070 7269 6e74 2863 6f6c 6f72       print(color
-000025a0: 6564 2866 225c 6e3e 2043 616c 6c69 6e67  ed(f"\n> Calling
-000025b0: 204d 6f64 656c 3a20 7b73 656c 662e 6c6c   Model: {self.ll
-000025c0: 6d7d 222c 2022 6d61 6765 6e74 6122 2929  m}", "magenta"))
-000025d0: 0d0a 2020 2020 2020 2020 2020 2020 6370  ..            cp
-000025e0: 7269 6e74 2866 225c 6e3e 2049 2068 6176  rint(f"\n> I hav
-000025f0: 6520 7265 6365 6976 6564 2074 6865 2066  e received the f
-00002600: 6972 7374 2076 6572 7369 6f6e 206f 6620  irst version of 
-00002610: 7468 6520 636f 6465 2e20 4920 616d 2073  the code. I am s
-00002620: 656e 6469 6e67 2069 7420 6261 636b 2074  ending it back t
-00002630: 6f20 4c4c 4d20 746f 2067 6574 2069 7420  o LLM to get it 
-00002640: 6368 6563 6b65 6420 666f 7220 616e 7920  checked for any 
-00002650: 6572 726f 7273 2c20 6275 6773 206f 7220  errors, bugs or 
-00002660: 696e 636f 6e73 6973 7465 6e63 6965 732c  inconsistencies,
-00002670: 2061 6e64 2063 6f72 7265 6374 696f 6e20   and correction 
-00002680: 6966 206e 6563 6573 7361 7279 2e20 506c  if necessary. Pl
-00002690: 6561 7365 2077 6169 742e 2e2e 5c6e 222c  ease wait...\n",
-000026a0: 2027 6d61 6765 6e74 6127 2c20 6174 7472   'magenta', attr
-000026b0: 733d 5b27 626f 6c64 275d 290d 0a0d 0a20  s=['bold']).... 
-000026c0: 2020 2020 2020 2023 2046 756e 6374 696f         # Functio
-000026d0: 6e20 746f 2064 6973 706c 6179 2072 6573  n to display res
-000026e0: 756c 7473 206e 6963 656c 790d 0a20 2020  ults nicely..   
-000026f0: 2020 2020 2064 6566 2064 6973 706c 6179       def display
-00002700: 5f74 6173 6b28 6465 6275 675f 696e 7369  _task(debug_insi
-00002710: 6768 7429 3a0d 0a20 2020 2020 2020 2020  ght):..         
-00002720: 2020 2069 6620 2769 7079 6b65 726e 656c     if 'ipykernel
-00002730: 2720 696e 2073 7973 2e6d 6f64 756c 6573  ' in sys.modules
-00002740: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00002750: 2020 2023 204a 7570 7974 6572 206e 6f74     # Jupyter not
-00002760: 6562 6f6f 6b20 6f72 2069 7079 7468 6f6e  ebook or ipython
-00002770: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00002780: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
-00002790: 273c 703e 3c62 2073 7479 6c65 3d22 636f  '<p><b style="co
-000027a0: 6c6f 723a 626c 7565 3b22 3e49 2068 6176  lor:blue;">I hav
-000027b0: 6520 6669 6e69 7368 6564 2064 6562 7567  e finished debug
-000027c0: 6769 6e67 2074 6865 2063 6f64 652c 2062  ging the code, b
-000027d0: 656c 6f77 2061 7265 206d 7920 7468 6f75  elow are my thou
-000027e0: 6768 7473 3a3c 2f62 3e3c 6272 3e3c 7072  ghts:</b><br><pr
-000027f0: 6520 7374 796c 653d 2263 6f6c 6f72 3a62  e style="color:b
-00002800: 6c61 636b 3b20 7768 6974 652d 7370 6163  lack; white-spac
-00002810: 653a 2070 7265 2d77 7261 703b 2066 6f6e  e: pre-wrap; fon
-00002820: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-00002830: 3e7b 6465 6275 675f 696e 7369 6768 747d  >{debug_insight}
-00002840: 3c2f 7072 653e 3c2f 703e 3c62 723e 2729  </pre></p><br>')
-00002850: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00002860: 2020 2064 6973 706c 6179 2848 544d 4c28     display(HTML(
-00002870: 6627 3c70 3e3c 6220 7374 796c 653d 2263  f'<p><b style="c
-00002880: 6f6c 6f72 3a6d 6167 656e 7461 3b22 3e49  olor:magenta;">I
-00002890: 2061 6d20 7072 6f63 6565 6469 6e67 2074   am proceeding t
-000028a0: 6f20 7468 6520 6578 6563 7574 696f 6e2e  o the execution.
-000028b0: 2e2e 3c2f 623e 3c2f 703e 3c62 723e 2729  ..</b></p><br>')
-000028c0: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
-000028d0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-000028e0: 2020 2020 2020 2320 4f74 6865 7220 656e        # Other en
-000028f0: 7669 726f 6e6d 656e 7420 286c 696b 6520  vironment (like 
-00002900: 7465 726d 696e 616c 290d 0a20 2020 2020  terminal)..     
-00002910: 2020 2020 2020 2020 2020 2063 7072 696e             cprin
-00002920: 7428 6622 5c6e 3e20 4920 6861 7665 2066  t(f"\n> I have f
-00002930: 696e 6973 6865 6420 6465 6275 6767 696e  inished debuggin
-00002940: 6720 7468 6520 636f 6465 2c20 6265 6c6f  g the code, belo
-00002950: 7720 6172 6520 6d79 2074 686f 7567 6874  w are my thought
-00002960: 733a 5c6e 7b64 6562 7567 5f69 6e73 6967  s:\n{debug_insig
-00002970: 6874 7d5c 6e22 2c20 276d 6167 656e 7461  ht}\n", 'magenta
-00002980: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
-00002990: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
-000029a0: 2020 2020 6370 7269 6e74 2866 225c 6e3e      cprint(f"\n>
-000029b0: 2049 2061 6d20 7072 6f63 6565 6469 6e67   I am proceeding
-000029c0: 2074 6f20 7468 6520 6578 6563 7574 696f   to the executio
-000029d0: 6e2e 2e2e 5c6e 222c 2027 6d61 6765 6e74  n...\n", 'magent
-000029e0: 6127 2c20 6174 7472 733d 5b27 626f 6c64  a', attrs=['bold
-000029f0: 275d 290d 0a0d 0a20 2020 2020 2020 2023  '])....        #
-00002a00: 2043 616c 6c20 7468 6520 4f70 656e 4149   Call the OpenAI
-00002a10: 2041 5049 2061 6e64 2068 616e 646c 6520   API and handle 
-00002a20: 7261 7465 206c 696d 6974 2065 7272 6f72  rate limit error
-00002a30: 730d 0a20 2020 2020 2020 2074 7279 3a0d  s..        try:.
-00002a40: 0a20 2020 2020 2020 2020 2020 206c 6c6d  .            llm
-00002a50: 5f72 6573 706f 6e73 652c 2074 6f6b 656e  _response, token
-00002a60: 735f 7573 6564 203d 2073 656c 662e 6c6c  s_used = self.ll
-00002a70: 6d5f 6361 6c6c 2864 6562 7567 5f6d 6573  m_call(debug_mes
-00002a80: 7361 6765 732c 7465 6d70 6572 6174 7572  sages,temperatur
-00002a90: 653d 3029 2023 2068 6967 6865 7220 7465  e=0) # higher te
-00002aa0: 6d70 6572 6174 7572 6520 7265 7375 6c74  mperature result
-00002ab0: 7320 696e 206d 6f72 6520 2263 7265 6174  s in more "creat
-00002ac0: 6976 6522 2061 6e73 7765 7273 2028 736f  ive" answers (so
-00002ad0: 6d65 7469 6d65 7320 746f 6f20 6372 6561  metimes too crea
-00002ae0: 7469 7665 203a 2d29 290d 0a20 2020 2020  tive :-))..     
-00002af0: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
-00002b00: 2065 7863 6570 7420 6f70 656e 6169 2e65   except openai.e
-00002b10: 7272 6f72 2e52 6174 654c 696d 6974 4572  rror.RateLimitEr
-00002b20: 726f 723a 0d0a 2020 2020 2020 2020 2020  ror:..          
-00002b30: 2020 7072 696e 7428 0d0a 2020 2020 2020    print(..      
-00002b40: 2020 2020 2020 2020 2020 2254 6865 204f            "The O
-00002b50: 7065 6e41 4920 4150 4920 7261 7465 206c  penAI API rate l
-00002b60: 696d 6974 2068 6173 2062 6565 6e20 6578  imit has been ex
-00002b70: 6365 6564 6564 2e20 5761 6974 696e 6720  ceeded. Waiting 
-00002b80: 3130 2073 6563 6f6e 6473 2061 6e64 2074  10 seconds and t
-00002b90: 7279 696e 6720 6167 6169 6e2e 220d 0a20  rying again.".. 
-00002ba0: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
-00002bb0: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-00002bc0: 6c65 6570 2831 3029 0d0a 2020 2020 2020  leep(10)..      
-00002bd0: 2020 2020 2020 6c6c 6d5f 7265 7370 6f6e        llm_respon
-00002be0: 7365 2c20 746f 6b65 6e73 5f75 7365 6420  se, tokens_used 
-00002bf0: 3d20 7365 6c66 2e6c 6c6d 5f63 616c 6c28  = self.llm_call(
-00002c00: 6465 6275 675f 6d65 7373 6167 6573 290d  debug_messages).
-00002c10: 0a20 2020 2020 2020 200d 0a20 2020 2020  .        ..     
-00002c20: 2020 2023 2045 7874 7261 6374 2074 6865     # Extract the
-00002c30: 2063 6f64 6520 6672 6f6d 2074 6865 2041   code from the A
-00002c40: 5049 2072 6573 706f 6e73 650d 0a20 2020  PI response..   
-00002c50: 2020 2020 2064 6562 7567 6765 645f 636f       debugged_co
-00002c60: 6465 2c64 6562 7567 5f69 6e73 6967 6874  de,debug_insight
-00002c70: 2c66 6c6f 7720 3d20 7365 6c66 2e5f 6578  ,flow = self._ex
-00002c80: 7472 6163 745f 636f 6465 286c 6c6d 5f72  tract_code(llm_r
-00002c90: 6573 706f 6e73 6529 2020 2020 2020 200d  esponse)       .
-00002ca0: 0a20 2020 2020 2020 2064 6973 706c 6179  .        display
-00002cb0: 5f74 6173 6b28 6465 6275 675f 696e 7369  _task(debug_insi
-00002cc0: 6768 7429 0d0a 0d0a 2020 2020 2020 2020  ght)....        
-00002cd0: 7365 6c66 2e74 6f74 616c 5f74 6f6b 656e  self.total_token
-00002ce0: 735f 7573 6564 2e61 7070 656e 6428 746f  s_used.append(to
-00002cf0: 6b65 6e73 5f75 7365 6429 0d0a 0d0a 2020  kens_used)....  
-00002d00: 2020 2020 2020 7265 7475 726e 2064 6562        return deb
-00002d10: 7567 6765 645f 636f 6465 0d0a 0d0a 2020  ugged_code....  
-00002d20: 2020 6465 6620 7261 6e6b 5f63 6f64 6528    def rank_code(
-00002d30: 7365 6c66 2c63 6f64 652c 7175 6573 7469  self,code,questi
-00002d40: 6f6e 293a 0d0a 2020 2020 2020 2020 2320  on):..        # 
-00002d50: 496e 6974 6961 6c69 7a65 2074 6865 206d  Initialize the m
-00002d60: 6573 7361 6765 7320 6c69 7374 2077 6974  essages list wit
-00002d70: 6820 6120 7379 7374 656d 206d 6573 7361  h a system messa
-00002d80: 6765 2063 6f6e 7461 696e 696e 6720 7468  ge containing th
-00002d90: 6520 7461 736b 2070 726f 6d70 740d 0a20  e task prompt.. 
-00002da0: 2020 2020 2020 2072 616e 6b5f 6d65 7373         rank_mess
-00002db0: 6167 6573 203d 205b 7b22 726f 6c65 223a  ages = [{"role":
-00002dc0: 2022 7379 7374 656d 222c 2022 636f 6e74   "system", "cont
-00002dd0: 656e 7422 3a20 7365 6c66 2e72 616e 6b5f  ent": self.rank_
-00002de0: 616e 7377 6572 2e66 6f72 6d61 7428 636f  answer.format(co
-00002df0: 6465 2c71 7565 7374 696f 6e29 7d5d 0d0a  de,question)}]..
-00002e00: 0d0a 2020 2020 2020 2020 6966 2027 6970  ..        if 'ip
-00002e10: 796b 6572 6e65 6c27 2069 6e20 7379 732e  ykernel' in sys.
-00002e20: 6d6f 6475 6c65 733a 0d0a 2020 2020 2020  modules:..      
-00002e30: 2020 2020 2020 2320 4a75 7079 7465 7220        # Jupyter 
-00002e40: 6e6f 7465 626f 6f6b 206f 7220 6970 7974  notebook or ipyt
-00002e50: 686f 6e0d 0a20 2020 2020 2020 2020 2020  hon..           
-00002e60: 2064 6973 706c 6179 2848 544d 4c28 6627   display(HTML(f'
-00002e70: 3c70 2073 7479 6c65 3d22 636f 6c6f 723a  <p style="color:
-00002e80: 6d61 6765 6e74 613b 223e 5c6e 4361 6c6c  magenta;">\nCall
-00002e90: 696e 6720 4d6f 6465 6c3a 207b 7365 6c66  ing Model: {self
-00002ea0: 2e6c 6c6d 7d3c 2f70 3e27 2929 0d0a 2020  .llm}</p>'))..  
-00002eb0: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
-00002ec0: 7928 4854 4d4c 2866 273c 703e 3c62 2073  y(HTML(f'<p><b s
-00002ed0: 7479 6c65 3d22 636f 6c6f 723a 6d61 6765  tyle="color:mage
-00002ee0: 6e74 613b 223e 4920 616d 2067 6f69 6e67  nta;">I am going
-00002ef0: 2074 6f20 6576 616c 7561 7465 2061 6e64   to evaluate and
-00002f00: 2072 616e 6b20 7468 6520 616e 7377 6572   rank the answer
-00002f10: 2e20 506c 6561 7365 2077 6169 742e 2e2e  . Please wait...
-00002f20: 3c2f 623e 3c2f 703e 3c62 723e 2729 290d  </b></p><br>')).
-00002f30: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
-00002f40: 2020 2020 2020 2020 2020 2020 2320 4f74              # Ot
-00002f50: 6865 7220 656e 7669 726f 6e6d 656e 7420  her environment 
-00002f60: 286c 696b 6520 7465 726d 696e 616c 290d  (like terminal).
-00002f70: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00002f80: 6e74 2863 6f6c 6f72 6564 2866 225c 6e3e  nt(colored(f"\n>
-00002f90: 2043 616c 6c69 6e67 204d 6f64 656c 3a20   Calling Model: 
-00002fa0: 7b73 656c 662e 6c6c 6d7d 222c 2022 6d61  {self.llm}", "ma
-00002fb0: 6765 6e74 6122 2929 0d0a 2020 2020 2020  genta"))..      
-00002fc0: 2020 2020 2020 6370 7269 6e74 2866 225c        cprint(f"\
-00002fd0: 6e3e 2049 2061 6d20 676f 696e 6720 746f  n> I am going to
-00002fe0: 2065 7661 6c75 6174 6520 616e 6420 7261   evaluate and ra
-00002ff0: 6e6b 2074 6865 2061 6e73 7765 722e 2050  nk the answer. P
-00003000: 6c65 6173 6520 7761 6974 2e2e 5c6e 222c  lease wait..\n",
-00003010: 2027 6d61 6765 6e74 6127 2c20 6174 7472   'magenta', attr
-00003020: 733d 5b27 626f 6c64 275d 290d 0a0d 0a20  s=['bold']).... 
-00003030: 2020 2020 2020 2023 2043 616c 6c20 7468         # Call th
-00003040: 6520 4f70 656e 4149 2041 5049 2061 6e64  e OpenAI API and
-00003050: 2068 616e 646c 6520 7261 7465 206c 696d   handle rate lim
-00003060: 6974 2065 7272 6f72 730d 0a20 2020 2020  it errors..     
-00003070: 2020 2074 7279 3a0d 0a20 2020 2020 2020     try:..       
-00003080: 2020 2020 206c 6c6d 5f72 6573 706f 6e73       llm_respons
-00003090: 652c 2074 6f6b 656e 735f 7573 6564 203d  e, tokens_used =
-000030a0: 2073 656c 662e 6c6c 6d5f 6361 6c6c 2872   self.llm_call(r
-000030b0: 616e 6b5f 6d65 7373 6167 6573 290d 0a20  ank_messages).. 
-000030c0: 2020 2020 2020 2020 2020 200d 0a20 2020             ..   
-000030d0: 2020 2020 2065 7863 6570 7420 6f70 656e       except open
-000030e0: 6169 2e65 7272 6f72 2e52 6174 654c 696d  ai.error.RateLim
-000030f0: 6974 4572 726f 723a 0d0a 2020 2020 2020  itError:..      
-00003100: 2020 2020 2020 7072 696e 7428 0d0a 2020        print(..  
-00003110: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-00003120: 6865 204f 7065 6e41 4920 4150 4920 7261  he OpenAI API ra
-00003130: 7465 206c 696d 6974 2068 6173 2062 6565  te limit has bee
-00003140: 6e20 6578 6365 6564 6564 2e20 5761 6974  n exceeded. Wait
-00003150: 696e 6720 3130 2073 6563 6f6e 6473 2061  ing 10 seconds a
-00003160: 6e64 2074 7279 696e 6720 6167 6169 6e2e  nd trying again.
-00003170: 220d 0a20 2020 2020 2020 2020 2020 2029  "..            )
-00003180: 0d0a 2020 2020 2020 2020 2020 2020 7469  ..            ti
-00003190: 6d65 2e73 6c65 6570 2831 3029 0d0a 2020  me.sleep(10)..  
-000031a0: 2020 2020 2020 2020 2020 6c6c 6d5f 7265            llm_re
-000031b0: 7370 6f6e 7365 2c20 746f 6b65 6e73 5f75  sponse, tokens_u
-000031c0: 7365 6420 3d20 7365 6c66 2e6c 6c6d 5f63  sed = self.llm_c
-000031d0: 616c 6c28 7261 6e6b 5f6d 6573 7361 6765  all(rank_message
-000031e0: 7329 0d0a 2020 2020 2020 2020 0d0a 2020  s)..        ..  
-000031f0: 2020 2020 2020 2320 4578 7472 6163 7420        # Extract 
-00003200: 7468 6520 636f 6465 2066 726f 6d20 7468  the code from th
-00003210: 6520 4150 4920 7265 7370 6f6e 7365 0d0a  e API response..
-00003220: 2020 2020 2020 2020 7261 6e6b 203d 2073          rank = s
-00003230: 656c 662e 5f65 7874 7261 6374 5f72 616e  elf._extract_ran
-00003240: 6b28 6c6c 6d5f 7265 7370 6f6e 7365 2920  k(llm_response) 
-00003250: 2020 2020 2020 0d0a 0d0a 2020 2020 2020        ....      
-00003260: 2020 7365 6c66 2e74 6f74 616c 5f74 6f6b    self.total_tok
-00003270: 656e 735f 7573 6564 2e61 7070 656e 6428  ens_used.append(
-00003280: 746f 6b65 6e73 5f75 7365 6429 0d0a 0d0a  tokens_used)....
-00003290: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-000032a0: 616e 6b0d 0a0d 0a20 2020 2064 6566 2070  ank....    def p
-000032b0: 645f 6167 656e 745f 636f 6e76 6572 7365  d_agent_converse
-000032c0: 2873 656c 662c 2071 7565 7374 696f 6e3d  (self, question=
-000032d0: 4e6f 6e65 293a 0d0a 2020 2020 2020 2020  None):..        
-000032e0: 2320 4675 6e63 7469 6f6e 2074 6f20 6469  # Function to di
-000032f0: 7370 6c61 7920 7265 7375 6c74 7320 6e69  splay results ni
-00003300: 6365 6c79 0d0a 2020 2020 2020 2020 6465  cely..        de
-00003310: 6620 6469 7370 6c61 795f 7265 7375 6c74  f display_result
-00003320: 7328 616e 7377 6572 2c20 636f 6465 2c20  s(answer, code, 
-00003330: 7265 666c 6563 7469 6f6e 2c20 666c 6f77  reflection, flow
-00003340: 2c20 7261 6e6b 2c20 746f 7461 6c5f 746f  , rank, total_to
-00003350: 6b65 6e73 5f75 7365 645f 7375 6d29 3a0d  kens_used_sum):.
-00003360: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00003370: 2769 7079 6b65 726e 656c 2720 696e 2073  'ipykernel' in s
-00003380: 7973 2e6d 6f64 756c 6573 3a0d 0a20 2020  ys.modules:..   
-00003390: 2020 2020 2020 2020 2020 2020 2023 204a               # J
-000033a0: 7570 7974 6572 206e 6f74 6562 6f6f 6b20  upyter notebook 
-000033b0: 6f72 2069 7079 7468 6f6e 0d0a 2020 2020  or ipython..    
-000033c0: 2020 2020 2020 2020 2020 2020 6469 7370              disp
-000033d0: 6c61 7928 4854 4d4c 2866 273c 703e 3c62  lay(HTML(f'<p><b
-000033e0: 2073 7479 6c65 3d22 636f 6c6f 723a 626c   style="color:bl
-000033f0: 7565 3b22 3e41 6e73 7765 723a 3c2f 623e  ue;">Answer:</b>
-00003400: 3c62 723e 3c70 7265 2073 7479 6c65 3d22  <br><pre style="
-00003410: 636f 6c6f 723a 626c 6163 6b3b 223e 3c62  color:black;"><b
-00003420: 3e7b 616e 7377 6572 7d3c 2f62 3e3c 2f70  >{answer}</b></p
-00003430: 7265 3e3c 2f70 3e3c 6272 3e27 2929 0d0a  re></p><br>'))..
-00003440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003450: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-00003460: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-00003470: 723a 626c 7565 3b22 3e48 6572 6520 6973  r:blue;">Here is
-00003480: 2074 6865 2066 696e 616c 2063 6f64 6520   the final code 
-00003490: 7468 6174 2061 6363 6f6d 706c 6973 6865  that accomplishe
-000034a0: 7320 7468 6520 7461 736b 3a3c 2f62 3e3c  s the task:</b><
-000034b0: 6272 3e3c 7072 6520 7374 796c 653d 2263  br><pre style="c
-000034c0: 6f6c 6f72 3a23 3535 3535 3535 3b22 3e7b  olor:#555555;">{
-000034d0: 636f 6465 7d3c 2f70 7265 3e3c 2f70 3e3c  code}</pre></p><
-000034e0: 6272 3e27 2929 0d0a 2020 2020 2020 2020  br>'))..        
-000034f0: 2020 2020 2020 2020 6469 7370 6c61 7928          display(
-00003500: 4854 4d4c 2866 273c 703e 3c62 2073 7479  HTML(f'<p><b sty
-00003510: 6c65 3d22 636f 6c6f 723a 626c 7565 3b22  le="color:blue;"
-00003520: 3e46 696e 616c 2054 686f 7567 6874 733a  >Final Thoughts:
-00003530: 3c2f 623e 3c62 723e 3c70 7265 2073 7479  </b><br><pre sty
-00003540: 6c65 3d22 636f 6c6f 723a 626c 6163 6b3b  le="color:black;
-00003550: 2077 6869 7465 2d73 7061 6365 3a20 7072   white-space: pr
-00003560: 652d 7772 6170 3b20 666f 6e74 2d77 6569  e-wrap; font-wei
-00003570: 6768 743a 2062 6f6c 643b 223e 7b72 6566  ght: bold;">{ref
-00003580: 6c65 6374 696f 6e7d 3c2f 7072 653e 3c2f  lection}</pre></
-00003590: 703e 3c62 723e 2729 290d 0a20 2020 2020  p><br>'))..     
-000035a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000035b0: 6c66 2e66 6c6f 775f 6469 6167 7261 6d3a  lf.flow_diagram:
-000035c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000035d0: 2020 2020 2020 6469 7370 6c61 7928 4854        display(HT
-000035e0: 4d4c 2866 273c 703e 3c62 2073 7479 6c65  ML(f'<p><b style
-000035f0: 3d22 636f 6c6f 723a 626c 7565 3b22 3e42  ="color:blue;">B
-00003600: 656c 6f77 2069 7320 6d79 2061 7070 726f  elow is my appro
-00003610: 6368 2061 7320 6120 466c 6f77 2063 6861  ch as a Flow cha
-00003620: 7274 3a3c 2f62 3e3c 6272 3e3c 696d 6720  rt:</b><br><img 
-00003630: 7372 633d 227b 7365 6c66 2e6d 6d28 666c  src="{self.mm(fl
-00003640: 6f77 297d 2220 616c 743d 2241 6e61 6c79  ow)}" alt="Analy
-00003650: 7369 7320 466c 6f77 223e 3c2f 696d 673e  sis Flow"></img>
-00003660: 3c2f 703e 3c62 723e 2729 290d 0a20 2020  </p><br>'))..   
-00003670: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00003680: 7365 6c66 2e72 616e 6b3a 0d0a 2020 2020  self.rank:..    
-00003690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036a0: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-000036b0: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-000036c0: 723a 626c 7565 3b22 3e52 616e 6b3a 3c2f  r:blue;">Rank:</
-000036d0: 623e 3c62 723e 3c73 7061 6e20 7374 796c  b><br><span styl
-000036e0: 653d 2263 6f6c 6f72 3a62 6c61 636b 3b22  e="color:black;"
-000036f0: 3e7b 7261 6e6b 7d3c 2f73 7061 6e3e 3c2f  >{rank}</span></
-00003700: 703e 3c62 723e 2729 290d 0a20 2020 2020  p><br>'))..     
-00003710: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-00003720: 6179 2848 544d 4c28 6627 3c70 3e3c 6220  ay(HTML(f'<p><b 
-00003730: 7374 796c 653d 2263 6f6c 6f72 3a62 6c75  style="color:blu
-00003740: 653b 223e 546f 7461 6c20 546f 6b65 6e73  e;">Total Tokens
-00003750: 2055 7365 643a 3c2f 623e 3c62 723e 3c73   Used:</b><br><s
-00003760: 7061 6e20 7374 796c 653d 2263 6f6c 6f72  pan style="color
-00003770: 3a62 6c61 636b 3b22 3e7b 746f 7461 6c5f  :black;">{total_
-00003780: 746f 6b65 6e73 5f75 7365 645f 7375 6d7d  tokens_used_sum}
-00003790: 3c2f 7370 616e 3e3c 2f70 3e3c 6272 3e27  </span></p><br>'
-000037a0: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-000037b0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-000037c0: 2020 2020 2020 2023 204f 7468 6572 2065         # Other e
-000037d0: 6e76 6972 6f6e 6d65 6e74 2028 6c69 6b65  nvironment (like
-000037e0: 2074 6572 6d69 6e61 6c29 0d0a 2020 2020   terminal)..    
-000037f0: 2020 2020 2020 2020 2020 2020 6370 7269              cpri
-00003800: 6e74 2866 225c 6e3e 2041 6e73 7765 723a  nt(f"\n> Answer:
-00003810: 5c6e 7b61 6e73 7765 727d 5c6e 222c 2027  \n{answer}\n", '
-00003820: 6772 6565 6e27 2c20 6174 7472 733d 5b27  green', attrs=['
-00003830: 626f 6c64 275d 290d 0a20 2020 2020 2020  bold'])..       
-00003840: 2020 2020 2020 2020 2063 7072 696e 7428           cprint(
-00003850: 6622 3e20 4865 7265 2069 7320 7468 6520  f"> Here is the 
-00003860: 6669 6e61 6c20 636f 6465 2074 6861 7420  final code that 
-00003870: 6163 636f 6d70 6c69 7368 6573 2074 6865  accomplishes the
-00003880: 2074 6173 6b3a 5c6e 7b63 6f64 657d 5c6e   task:\n{code}\n
-00003890: 222c 2027 6772 6565 6e27 2c20 6174 7472  ", 'green', attr
-000038a0: 733d 5b27 626f 6c64 275d 290d 0a20 2020  s=['bold'])..   
-000038b0: 2020 2020 2020 2020 2020 2020 2063 7072               cpr
-000038c0: 696e 7428 6622 3e20 4669 6e61 6c20 5468  int(f"> Final Th
-000038d0: 6f75 6768 7473 3a5c 6e7b 7265 666c 6563  oughts:\n{reflec
-000038e0: 7469 6f6e 7d5c 6e22 2c20 2767 7265 656e  tion}\n", 'green
-000038f0: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
-00003900: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
-00003910: 2020 2020 6966 2073 656c 662e 7261 6e6b      if self.rank
-00003920: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00003930: 2020 2020 2020 2063 7072 696e 7428 6622         cprint(f"
-00003940: 3e20 5261 6e6b 3a5c 6e7b 7261 6e6b 7d5c  > Rank:\n{rank}\
-00003950: 6e22 2c20 2767 7265 656e 272c 2061 7474  n", 'green', att
-00003960: 7273 3d5b 2762 6f6c 6427 5d29 0d0a 2020  rs=['bold'])..  
-00003970: 2020 2020 2020 2020 2020 2020 2020 6370                cp
-00003980: 7269 6e74 2866 223e 2054 6f74 616c 2074  rint(f"> Total t
-00003990: 6f6b 656e 7320 7573 6564 3a5c 6e7b 746f  okens used:\n{to
-000039a0: 7461 6c5f 746f 6b65 6e73 5f75 7365 645f  tal_tokens_used_
-000039b0: 7375 6d7d 5c6e 222c 2027 7965 6c6c 6f77  sum}\n", 'yellow
-000039c0: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
-000039d0: 5d29 0d0a 2020 2020 2020 2020 0d0a 2020  ])..        ..  
-000039e0: 2020 2020 2020 2320 4966 2061 2071 7565        # If a que
-000039f0: 7374 696f 6e20 6973 2070 726f 7669 6465  stion is provide
-00003a00: 642c 2073 6b69 7020 7468 6520 696e 7075  d, skip the inpu
-00003a10: 7420 7072 6f6d 7074 0d0a 2020 2020 2020  t prompt..      
-00003a20: 2020 6966 2071 7565 7374 696f 6e20 6973    if question is
-00003a30: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
-00003a40: 2020 2020 2020 2020 2320 496e 6974 6961          # Initia
-00003a50: 6c69 7a65 2074 6865 206d 6573 7361 6765  lize the message
-00003a60: 7320 6c69 7374 2077 6974 6820 6120 7379  s list with a sy
-00003a70: 7374 656d 206d 6573 7361 6765 2063 6f6e  stem message con
-00003a80: 7461 696e 696e 6720 7468 6520 7461 736b  taining the task
-00003a90: 2070 726f 6d70 740d 0a20 2020 2020 2020   prompt..       
-00003aa0: 2020 2020 206d 6573 7361 6765 7320 3d20       messages = 
-00003ab0: 5b7b 2272 6f6c 6522 3a20 2273 7973 7465  [{"role": "syste
-00003ac0: 6d22 2c20 2263 6f6e 7465 6e74 223a 2073  m", "content": s
-00003ad0: 656c 662e 7379 7374 656d 5f74 6173 6b2e  elf.system_task.
-00003ae0: 666f 726d 6174 2871 7565 7374 696f 6e29  format(question)
-00003af0: 7d5d 0d0a 2020 2020 2020 2020 2020 2020  }]..            
-00003b00: 2320 4361 6c6c 2074 6865 2074 6173 6b5f  # Call the task_
-00003b10: 6576 616c 206d 6574 686f 6420 7769 7468  eval method with
-00003b20: 2074 6865 2075 7365 7227 7320 7175 6573   the user's ques
-00003b30: 7469 6f6e 2069 6620 7468 6520 6578 706c  tion if the expl
-00003b40: 6f72 6174 6f72 7920 6d6f 6465 2069 7320  oratory mode is 
-00003b50: 5472 7565 0d0a 2020 2020 2020 2020 2020  True..          
-00003b60: 2020 6966 2073 656c 662e 6578 706c 6f72    if self.explor
-00003b70: 6174 6f72 7920 6973 2054 7275 653a 0d0a  atory is True:..
-00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b90: 7461 736b 203d 2073 656c 662e 7461 736b  task = self.task
-00003ba0: 5f65 7661 6c28 7175 6573 7469 6f6e 290d  _eval(question).
-00003bb0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00003bc0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00003bd0: 2020 2020 7461 736b 203d 2071 7565 7374      task = quest
-00003be0: 696f 6e0d 0a20 2020 2020 2020 2020 2020  ion..           
-00003bf0: 2023 2043 616c 6c20 7468 6520 7064 5f61   # Call the pd_a
-00003c00: 6765 6e74 206d 6574 686f 6420 7769 7468  gent method with
-00003c10: 2074 6865 2075 7365 7227 7320 7175 6573   the user's ques
-00003c20: 7469 6f6e 2c20 7468 6520 6d65 7373 6167  tion, the messag
-00003c30: 6573 206c 6973 742c 2061 6e64 2074 6865  es list, and the
-00003c40: 2064 6174 6166 7261 6d65 0d0a 2020 2020   dataframe..    
-00003c50: 2020 2020 2020 2020 616e 7377 6572 2c20          answer, 
-00003c60: 636f 6465 2c20 7265 666c 6563 7469 6f6e  code, reflection
-00003c70: 2c20 666c 6f77 2c20 746f 7461 6c5f 746f  , flow, total_to
-00003c80: 6b65 6e73 5f75 7365 645f 7375 6d20 3d20  kens_used_sum = 
-00003c90: 7365 6c66 2e70 645f 6167 656e 7428 7461  self.pd_agent(ta
-00003ca0: 736b 2c20 6d65 7373 6167 6573 2c20 7365  sk, messages, se
-00003cb0: 6c66 2e64 6629 0d0a 0d0a 2020 2020 2020  lf.df)....      
-00003cc0: 2020 2020 2020 2320 5374 6f72 6520 7468        # Store th
-00003cd0: 6520 6f72 6967 696e 616c 206c 6c6d 2076  e original llm v
-00003ce0: 616c 7565 0d0a 2020 2020 2020 2020 2020  alue..          
-00003cf0: 2020 6f72 6967 696e 616c 5f6c 6c6d 203d    original_llm =
-00003d00: 2073 656c 662e 6c6c 6d0d 0a0d 0a20 2020   self.llm....   
-00003d10: 2020 2020 2020 2020 2023 2052 616e 6b20           # Rank 
-00003d20: 7468 6520 4c4c 4d20 7265 7370 6f6e 7365  the LLM response
-00003d30: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00003d40: 2073 656c 662e 7261 6e6b 3a0d 0a20 2020   self.rank:..   
-00003d50: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-00003d60: 7769 7463 6820 746f 2067 7074 2d34 2069  witch to gpt-4 i
-00003d70: 6620 6c6c 6d5f 7377 6974 6368 2070 6172  f llm_switch par
-00003d80: 616d 6574 6572 2069 7320 7365 7420 746f  ameter is set to
-00003d90: 2054 7275 652e 2054 6869 7320 7769 6c6c   True. This will
-00003da0: 2069 6e63 7265 6173 6520 7468 6520 7072   increase the pr
-00003db0: 6f63 6573 7369 6e67 2074 696d 6520 616e  ocessing time an
-00003dc0: 6420 636f 7374 0d0a 2020 2020 2020 2020  d cost..        
-00003dd0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00003de0: 6c6c 6d5f 7377 6974 6368 3a0d 0a20 2020  llm_switch:..   
-00003df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e00: 2073 656c 662e 6c6c 6d20 3d20 2767 7074   self.llm = 'gpt
-00003e10: 2d34 270d 0a20 2020 2020 2020 2020 2020  -4'..           
-00003e20: 2020 2020 2072 616e 6b20 3d20 7365 6c66       rank = self
-00003e30: 2e72 616e 6b5f 636f 6465 2863 6f64 652c  .rank_code(code,
-00003e40: 7175 6573 7469 6f6e 290d 0a20 2020 2020  question)..     
-00003e50: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00003e60: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00003e70: 6e6b 203d 2022 220d 0a0d 0a20 2020 2020  nk = ""....     
-00003e80: 2020 2020 2020 2023 2053 7769 7463 6820         # Switch 
-00003e90: 6261 636b 2074 6f20 7468 6520 6f72 6967  back to the orig
-00003ea0: 696e 616c 206c 6c6d 2062 6566 6f72 6520  inal llm before 
-00003eb0: 7468 6520 6675 6e63 7469 6f6e 2066 696e  the function fin
-00003ec0: 6973 6865 730d 0a20 2020 2020 2020 2020  ishes..         
-00003ed0: 2020 2073 656c 662e 6c6c 6d20 3d20 6f72     self.llm = or
-00003ee0: 6967 696e 616c 5f6c 6c6d 0d0a 0d0a 2020  iginal_llm....  
-00003ef0: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
-00003f00: 795f 7265 7375 6c74 7328 616e 7377 6572  y_results(answer
-00003f10: 2c20 636f 6465 2c20 7265 666c 6563 7469  , code, reflecti
-00003f20: 6f6e 2c20 666c 6f77 2c20 7261 6e6b 2c20  on, flow, rank, 
-00003f30: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
-00003f40: 645f 7375 6d29 0d0a 2020 2020 2020 2020  d_sum)..        
-00003f50: 2020 2020 7265 7475 726e 0d0a 0d0a 2020      return....  
-00003f60: 2020 2020 2020 2320 5374 6172 7420 616e        # Start an
-00003f70: 2069 6e66 696e 6974 6520 6c6f 6f70 2074   infinite loop t
-00003f80: 6f20 6b65 6570 2061 736b 696e 6720 7468  o keep asking th
-00003f90: 6520 7573 6572 2066 6f72 2071 7565 7374  e user for quest
-00003fa0: 696f 6e73 0d0a 2020 2020 2020 2020 6669  ions..        fi
-00003fb0: 7273 745f 6974 6572 6174 696f 6e20 3d20  rst_iteration = 
-00003fc0: 5472 7565 2020 2320 466c 6167 2066 6f72  True  # Flag for
-00003fd0: 2074 6865 2066 6972 7374 2069 7465 7261   the first itera
-00003fe0: 7469 6f6e 206f 6620 7468 6520 6c6f 6f70  tion of the loop
-00003ff0: 0d0a 2020 2020 2020 2020 7768 696c 6520  ..        while 
-00004000: 5472 7565 3a0d 0a20 2020 2020 2020 2020  True:..         
-00004010: 2020 2023 2050 726f 6d70 7420 7468 6520     # Prompt the 
-00004020: 7573 6572 2074 6f20 656e 7465 7220 6120  user to enter a 
-00004030: 7175 6573 7469 6f6e 206f 7220 7479 7065  question or type
-00004040: 2027 6578 6974 2720 746f 2071 7569 740d   'exit' to quit.
-00004050: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00004060: 2769 7079 6b65 726e 656c 2720 696e 2073  'ipykernel' in s
-00004070: 7973 2e6d 6f64 756c 6573 3a0d 0a20 2020  ys.modules:..   
-00004080: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-00004090: 706c 6179 2848 544d 4c28 273c 6220 7374  play(HTML('<b st
-000040a0: 796c 653d 2263 6f6c 6f72 3a62 6c75 653b  yle="color:blue;
-000040b0: 223e 456e 7465 7220 796f 7572 2071 7565  ">Enter your que
-000040c0: 7374 696f 6e20 6f72 2074 7970 6520 5c27  stion or type \'
-000040d0: 6578 6974 5c27 2074 6f20 7175 6974 3a3c  exit\' to quit:<
-000040e0: 2f62 3e27 2929 0d0a 2020 2020 2020 2020  /b>'))..        
-000040f0: 2020 2020 2020 2020 7175 6573 7469 6f6e          question
-00004100: 203d 2069 6e70 7574 2829 0d0a 2020 2020   = input()..    
-00004110: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00004120: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00004130: 7072 696e 7428 225c 6e45 6e74 6572 2079  print("\nEnter y
-00004140: 6f75 7220 7175 6573 7469 6f6e 206f 7220  our question or 
-00004150: 7479 7065 2027 6578 6974 2720 746f 2071  type 'exit' to q
-00004160: 7569 743a 222c 2027 626c 7565 272c 2061  uit:", 'blue', a
-00004170: 7474 7273 3d5b 2762 6f6c 6427 5d29 0d0a  ttrs=['bold'])..
-00004180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004190: 7175 6573 7469 6f6e 203d 2069 6e70 7574  question = input
-000041a0: 2829 0d0a 0d0a 2020 2020 2020 2020 2020  ()....          
-000041b0: 2020 2320 5265 6d65 6d62 6572 7420 7468    # Remembert th
-000041c0: 6520 6f72 6967 696e 616c 2071 7565 7374  e original quest
-000041d0: 696f 6e20 666f 7220 7261 6e6b 696e 670d  ion for ranking.
-000041e0: 0a20 2020 2020 2020 2020 2020 206f 7269  .            ori
-000041f0: 6769 6e61 6c5f 7175 6573 7469 6f6e 203d  ginal_question =
-00004200: 2071 7565 7374 696f 6e0d 0a0d 0a20 2020   question....   
-00004210: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
-00004220: 6520 7573 6572 2074 7970 6573 2027 6578  e user types 'ex
-00004230: 6974 272c 2062 7265 616b 206f 7574 206f  it', break out o
-00004240: 6620 7468 6520 6c6f 6f70 0d0a 2020 2020  f the loop..    
-00004250: 2020 2020 2020 2020 6966 2071 7565 7374          if quest
-00004260: 696f 6e2e 7374 7269 7028 292e 6c6f 7765  ion.strip().lowe
-00004270: 7228 2920 3d3d 2027 6578 6974 273a 0d0a  r() == 'exit':..
-00004280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004290: 6272 6561 6b0d 0a0d 0a20 2020 2020 2020  break....       
-000042a0: 2020 2020 2069 6620 6669 7273 745f 6974       if first_it
-000042b0: 6572 6174 696f 6e3a 0d0a 2020 2020 2020  eration:..      
-000042c0: 2020 2020 2020 2020 2020 2320 496e 6974            # Init
-000042d0: 6961 6c69 7a65 2074 6865 206d 6573 7361  ialize the messa
-000042e0: 6765 7320 6c69 7374 2077 6974 6820 6120  ges list with a 
-000042f0: 7379 7374 656d 206d 6573 7361 6765 2063  system message c
-00004300: 6f6e 7461 696e 696e 6720 7468 6520 7461  ontaining the ta
-00004310: 736b 2070 726f 6d70 740d 0a20 2020 2020  sk prompt..     
-00004320: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-00004330: 6765 7320 3d20 5b7b 2272 6f6c 6522 3a20  ges = [{"role": 
-00004340: 2273 7973 7465 6d22 2c20 2263 6f6e 7465  "system", "conte
-00004350: 6e74 223a 2073 656c 662e 7379 7374 656d  nt": self.system
-00004360: 5f74 6173 6b2e 666f 726d 6174 2871 7565  _task.format(que
-00004370: 7374 696f 6e2c 7175 6573 7469 6f6e 297d  stion,question)}
-00004380: 5d0d 0a20 2020 2020 2020 2020 2020 2020  ]..             
-00004390: 2020 2023 2043 616c 6c20 7468 6520 7461     # Call the ta
-000043a0: 736b 5f65 7661 6c20 6d65 7468 6f64 2077  sk_eval method w
-000043b0: 6974 6820 7468 6520 7573 6572 2773 2071  ith the user's q
-000043c0: 7565 7374 696f 6e20 6966 2074 6865 2065  uestion if the e
-000043d0: 7870 6c6f 7261 746f 7279 206d 6f64 6520  xploratory mode 
-000043e0: 6973 2054 7275 650d 0a20 2020 2020 2020  is True..       
-000043f0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00004400: 2e65 7870 6c6f 7261 746f 7279 2069 7320  .exploratory is 
-00004410: 5472 7565 3a0d 0a20 2020 2020 2020 2020  True:..         
-00004420: 2020 2020 2020 2020 2020 2074 6173 6b20             task 
-00004430: 3d20 7365 6c66 2e74 6173 6b5f 6576 616c  = self.task_eval
-00004440: 2871 7565 7374 696f 6e29 0d0a 2020 2020  (question)..    
-00004450: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004460: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00004470: 2020 2020 2020 2074 6173 6b20 3d20 7175         task = qu
-00004480: 6573 7469 6f6e 0d0a 2020 2020 2020 2020  estion..        
-00004490: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-000044a0: 2020 2020 2020 2020 2020 2074 6173 6b20             task 
-000044b0: 3d20 7175 6573 7469 6f6e 0d0a 0d0a 2020  = question....  
-000044c0: 2020 2020 2020 2020 2020 2320 4361 6c6c            # Call
-000044d0: 2074 6865 2070 645f 6167 656e 7420 6d65   the pd_agent me
-000044e0: 7468 6f64 2077 6974 6820 7468 6520 7573  thod with the us
-000044f0: 6572 2773 2071 7565 7374 696f 6e2c 2074  er's question, t
-00004500: 6865 206d 6573 7361 6765 7320 6c69 7374  he messages list
-00004510: 2c20 616e 6420 7468 6520 6461 7461 6672  , and the datafr
-00004520: 616d 650d 0a20 2020 2020 2020 2020 2020  ame..           
-00004530: 2061 6e73 7765 722c 2063 6f64 652c 2072   answer, code, r
-00004540: 6566 6c65 6374 696f 6e2c 2066 6c6f 772c  eflection, flow,
-00004550: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
-00004560: 6564 5f73 756d 203d 2073 656c 662e 7064  ed_sum = self.pd
-00004570: 5f61 6765 6e74 2874 6173 6b2c 206d 6573  _agent(task, mes
-00004580: 7361 6765 732c 2073 656c 662e 6466 290d  sages, self.df).
-00004590: 0a0d 0a20 2020 2020 2020 2020 2020 2023  ...            #
-000045a0: 2053 746f 7265 2074 6865 206f 7269 6769   Store the origi
-000045b0: 6e61 6c20 6c6c 6d20 7661 6c75 650d 0a20  nal llm value.. 
-000045c0: 2020 2020 2020 2020 2020 206f 7269 6769             origi
-000045d0: 6e61 6c5f 6c6c 6d20 3d20 7365 6c66 2e6c  nal_llm = self.l
-000045e0: 6c6d 0d0a 0d0a 2020 2020 2020 2020 2020  lm....          
-000045f0: 2020 2320 5261 6e6b 2074 6865 204c 4c4d    # Rank the LLM
-00004600: 2072 6573 706f 6e73 650d 0a20 2020 2020   response..     
-00004610: 2020 2020 2020 2069 6620 7365 6c66 2e72         if self.r
-00004620: 616e 6b3a 0d0a 2020 2020 2020 2020 2020  ank:..          
-00004630: 2020 2020 2020 2320 5377 6974 6368 2074        # Switch t
-00004640: 6f20 6770 742d 3420 6966 206c 6c6d 5f73  o gpt-4 if llm_s
-00004650: 7769 7463 6820 7061 7261 6d65 7465 7220  witch parameter 
-00004660: 6973 2073 6574 2074 6f20 5472 7565 2e20  is set to True. 
-00004670: 5468 6973 2077 696c 6c20 696e 6372 6561  This will increa
-00004680: 7365 2074 6865 2070 726f 6365 7373 696e  se the processin
-00004690: 6720 7469 6d65 2061 6e64 2063 6f73 740d  g time and cost.
-000046a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000046b0: 2069 6620 7365 6c66 2e6c 6c6d 5f73 7769   if self.llm_swi
-000046c0: 7463 683a 0d0a 2020 2020 2020 2020 2020  tch:..          
-000046d0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-000046e0: 6c6d 203d 2027 6770 742d 3427 0d0a 2020  lm = 'gpt-4'..  
-000046f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00004700: 6e6b 203d 2073 656c 662e 7261 6e6b 5f63  nk = self.rank_c
-00004710: 6f64 6528 636f 6465 2c6f 7269 6769 6e61  ode(code,origina
-00004720: 6c5f 7175 6573 7469 6f6e 290d 0a20 2020  l_question)..   
-00004730: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
-00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004750: 7261 6e6b 203d 2022 220d 0a0d 0a20 2020  rank = ""....   
-00004760: 2020 2020 2020 2020 2023 2053 7769 7463           # Switc
-00004770: 6820 6261 636b 2074 6f20 7468 6520 6f72  h back to the or
-00004780: 6967 696e 616c 206c 6c6d 2062 6566 6f72  iginal llm befor
-00004790: 6520 7468 6520 6675 6e63 7469 6f6e 2066  e the function f
-000047a0: 696e 6973 6865 730d 0a20 2020 2020 2020  inishes..       
-000047b0: 2020 2020 2073 656c 662e 6c6c 6d20 3d20       self.llm = 
-000047c0: 6f72 6967 696e 616c 5f6c 6c6d 0d0a 0d0a  original_llm....
-000047d0: 2020 2020 2020 2020 2020 2020 6469 7370              disp
-000047e0: 6c61 795f 7265 7375 6c74 7328 616e 7377  lay_results(answ
-000047f0: 6572 2c20 636f 6465 2c20 7265 666c 6563  er, code, reflec
-00004800: 7469 6f6e 2c66 6c6f 772c 7261 6e6b 2c74  tion,flow,rank,t
-00004810: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00004820: 5f73 756d 290d 0a0d 0a20 2020 2020 2020  _sum)....       
-00004830: 2020 2020 2023 2041 6674 6572 2074 6865       # After the
-00004840: 2066 6972 7374 2069 7465 7261 7469 6f6e   first iteration
-00004850: 2c20 7365 7420 7468 6520 666c 6167 2074  , set the flag t
-00004860: 6f20 4661 6c73 650d 0a20 2020 2020 2020  o False..       
-00004870: 2020 2020 2066 6972 7374 5f69 7465 7261       first_itera
-00004880: 7469 6f6e 203d 2046 616c 7365 0d0a 0d0a  tion = False....
-00004890: 2020 2020 6465 6620 7064 5f61 6765 6e74      def pd_agent
-000048a0: 2873 656c 662c 2071 7565 7374 696f 6e2c  (self, question,
-000048b0: 206d 6573 7361 6765 732c 2064 663d 4e6f   messages, df=No
-000048c0: 6e65 293a 0d0a 2020 2020 2020 2020 2320  ne):..        # 
-000048d0: 4164 6420 6120 7573 6572 206d 6573 7361  Add a user messa
-000048e0: 6765 2077 6974 6820 7468 6520 7570 6461  ge with the upda
-000048f0: 7465 6420 7461 736b 2070 726f 6d70 7420  ted task prompt 
-00004900: 746f 2074 6865 206d 6573 7361 6765 7320  to the messages 
-00004910: 6c69 7374 0d0a 2020 2020 2020 2020 6d65  list..        me
-00004920: 7373 6167 6573 2e61 7070 656e 6428 7b22  ssages.append({"
-00004930: 726f 6c65 223a 2022 7573 6572 222c 2022  role": "user", "
-00004940: 636f 6e74 656e 7422 3a20 7365 6c66 2e74  content": self.t
-00004950: 6173 6b2e 666f 726d 6174 2873 656c 662e  ask.format(self.
-00004960: 6466 5f68 6561 642c 2071 7565 7374 696f  df_head, questio
-00004970: 6e29 7d29 0d0a 0d0a 2020 2020 2020 2020  n)})....        
-00004980: 6966 2027 6970 796b 6572 6e65 6c27 2069  if 'ipykernel' i
-00004990: 6e20 7379 732e 6d6f 6475 6c65 733a 0d0a  n sys.modules:..
-000049a0: 2020 2020 2020 2020 2020 2020 2320 4a75              # Ju
-000049b0: 7079 7465 7220 6e6f 7465 626f 6f6b 206f  pyter notebook o
-000049c0: 7220 6970 7974 686f 6e0d 0a20 2020 2020  r ipython..     
-000049d0: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
-000049e0: 544d 4c28 6627 3c70 2073 7479 6c65 3d22  TML(f'<p style="
-000049f0: 636f 6c6f 723a 6d61 6765 6e74 613b 223e  color:magenta;">
-00004a00: 5c6e 4361 6c6c 696e 6720 4d6f 6465 6c3a  \nCalling Model:
-00004a10: 207b 7365 6c66 2e6c 6c6d 7d3c 2f70 3e27   {self.llm}</p>'
-00004a20: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-00004a30: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-00004a40: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-00004a50: 723a 6d61 6765 6e74 613b 223e 4920 6861  r:magenta;">I ha
-00004a60: 7665 2073 656e 7420 796f 7572 2072 6571  ve sent your req
-00004a70: 7565 7374 2074 6f20 7468 6520 4c4c 4d20  uest to the LLM 
-00004a80: 616e 6420 6177 6169 7469 6e67 2072 6573  and awaiting res
-00004a90: 706f 6e73 652c 2070 6c65 6173 6520 7761  ponse, please wa
-00004aa0: 6974 2e2e 2e3c 2f62 3e3c 2f70 3e3c 6272  it...</b></p><br
-00004ab0: 3e27 2929 0d0a 2020 2020 2020 2020 656c  >'))..        el
-00004ac0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00004ad0: 2023 204f 7468 6572 2065 6e76 6972 6f6e   # Other environ
-00004ae0: 6d65 6e74 2028 6c69 6b65 2074 6572 6d69  ment (like termi
-00004af0: 6e61 6c29 0d0a 2020 2020 2020 2020 2020  nal)..          
-00004b00: 2020 7072 696e 7428 636f 6c6f 7265 6428    print(colored(
-00004b10: 6622 5c6e 3e20 4361 6c6c 696e 6720 4d6f  f"\n> Calling Mo
-00004b20: 6465 6c3a 207b 7365 6c66 2e6c 6c6d 7d22  del: {self.llm}"
-00004b30: 2c20 226d 6167 656e 7461 2229 290d 0a20  , "magenta")).. 
-00004b40: 2020 2020 2020 2020 2020 2063 7072 696e             cprin
-00004b50: 7428 6622 5c6e 3e20 4920 6861 7665 2073  t(f"\n> I have s
-00004b60: 656e 7420 796f 7572 2072 6571 7565 7374  ent your request
-00004b70: 2074 6f20 7468 6520 4c4c 4d20 616e 6420   to the LLM and 
-00004b80: 6177 6169 7469 6e67 2072 6573 706f 6e73  awaiting respons
-00004b90: 652c 2070 6c65 6173 6520 7761 6974 2e2e  e, please wait..
-00004ba0: 2e5c 6e22 2c20 276d 6167 656e 7461 272c  .\n", 'magenta',
-00004bb0: 2061 7474 7273 3d5b 2762 6f6c 6427 5d29   attrs=['bold'])
-00004bc0: 0d0a 0d0a 2020 2020 2020 2020 2320 4361  ....        # Ca
-00004bd0: 6c6c 2074 6865 204f 7065 6e41 4920 4150  ll the OpenAI AP
-00004be0: 4920 616e 6420 6861 6e64 6c65 2072 6174  I and handle rat
-00004bf0: 6520 6c69 6d69 7420 6572 726f 7273 0d0a  e limit errors..
-00004c00: 2020 2020 2020 2020 7472 793a 0d0a 2020          try:..  
-00004c10: 2020 2020 2020 2020 2020 6c6c 6d5f 7265            llm_re
-00004c20: 7370 6f6e 7365 2c20 746f 6b65 6e73 5f75  sponse, tokens_u
-00004c30: 7365 6420 3d20 7365 6c66 2e6c 6c6d 5f63  sed = self.llm_c
-00004c40: 616c 6c28 6d65 7373 6167 6573 290d 0a0d  all(messages)...
-00004c50: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00004c60: 6f70 656e 6169 2e65 7272 6f72 2e52 6174  openai.error.Rat
-00004c70: 654c 696d 6974 4572 726f 723a 0d0a 2020  eLimitError:..  
-00004c80: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00004c90: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00004ca0: 2020 2254 6865 204f 7065 6e41 4920 4150    "The OpenAI AP
-00004cb0: 4920 7261 7465 206c 696d 6974 2068 6173  I rate limit has
-00004cc0: 2062 6565 6e20 6578 6365 6564 6564 2e20   been exceeded. 
-00004cd0: 5761 6974 696e 6720 3130 2073 6563 6f6e  Waiting 10 secon
-00004ce0: 6473 2061 6e64 2074 7279 696e 6720 6167  ds and trying ag
-00004cf0: 6169 6e2e 220d 0a20 2020 2020 2020 2020  ain."..         
-00004d00: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
-00004d10: 2020 7469 6d65 2e73 6c65 6570 2831 3029    time.sleep(10)
-00004d20: 0d0a 2020 2020 2020 2020 2020 2020 6c6c  ..            ll
-00004d30: 6d5f 7265 7370 6f6e 7365 2c20 746f 6b65  m_response, toke
-00004d40: 6e73 5f75 7365 6420 3d20 7365 6c66 2e6c  ns_used = self.l
-00004d50: 6c6d 5f63 616c 6c28 6d65 7373 6167 6573  lm_call(messages
-00004d60: 290d 0a0d 0a20 2020 2020 2020 2023 2045  )....        # E
-00004d70: 7874 7261 6374 2074 6865 2063 6f64 6520  xtract the code 
-00004d80: 6672 6f6d 2074 6865 2041 5049 2072 6573  from the API res
-00004d90: 706f 6e73 650d 0a20 2020 2020 2020 2063  ponse..        c
-00004da0: 6f64 652c 7265 666c 6563 7469 6f6e 2c66  ode,reflection,f
-00004db0: 6c6f 773d 2073 656c 662e 5f65 7874 7261  low= self._extra
-00004dc0: 6374 5f63 6f64 6528 6c6c 6d5f 7265 7370  ct_code(llm_resp
-00004dd0: 6f6e 7365 290d 0a0d 0a20 2020 2020 2020  onse)....       
-00004de0: 2023 2055 7064 6174 6520 7468 6520 746f   # Update the to
-00004df0: 7461 6c20 746f 6b65 6e73 2075 7365 640d  tal tokens used.
-00004e00: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-00004e10: 7461 6c5f 746f 6b65 6e73 5f75 7365 642e  tal_tokens_used.
-00004e20: 6170 7065 6e64 2874 6f6b 656e 735f 7573  append(tokens_us
-00004e30: 6564 290d 0a20 2020 2020 2020 2074 6f74  ed)..        tot
-00004e40: 616c 5f74 6f6b 656e 735f 7573 6564 5f73  al_tokens_used_s
-00004e50: 756d 203d 2073 756d 2873 656c 662e 746f  um = sum(self.to
-00004e60: 7461 6c5f 746f 6b65 6e73 5f75 7365 6429  tal_tokens_used)
-00004e70: 0d0a 0d0a 2020 2020 2020 2020 2320 496e  ....        # In
-00004e80: 6974 6961 6c69 7a65 2065 7272 6f72 2063  itialize error c
-00004e90: 6f72 7265 6374 696f 6e20 636f 756e 7465  orrection counte
-00004ea0: 720d 0a20 2020 2020 2020 2065 7272 6f72  r..        error
-00004eb0: 5f63 6f72 7265 6374 696f 6e73 203d 2030  _corrections = 0
-00004ec0: 0d0a 0d0a 2020 2020 2020 2020 2320 5374  ....        # St
-00004ed0: 6f72 6520 7468 6520 6f72 6967 696e 616c  ore the original
-00004ee0: 206c 6c6d 2076 616c 7565 0d0a 2020 2020   llm value..    
-00004ef0: 2020 2020 6f72 6967 696e 616c 5f6c 6c6d      original_llm
-00004f00: 203d 2073 656c 662e 6c6c 6d0d 0a0d 0a20   = self.llm.... 
-00004f10: 2020 2020 2020 2023 2044 6562 7567 2063         # Debug c
-00004f20: 6f64 6520 6966 2064 6562 7567 2070 6172  ode if debug par
-00004f30: 616d 6574 6572 2069 7320 7365 7420 746f  ameter is set to
-00004f40: 2054 7275 650d 0a20 2020 2020 2020 2069   True..        i
-00004f50: 6620 7365 6c66 2e64 6562 7567 3a0d 0a20  f self.debug:.. 
-00004f60: 2020 2020 2020 2020 2020 2023 2053 7769             # Swi
-00004f70: 7463 6820 746f 2067 7074 2d34 2069 6620  tch to gpt-4 if 
-00004f80: 6c6c 6d5f 7377 6974 6368 2070 6172 616d  llm_switch param
-00004f90: 6574 6572 2069 7320 7365 7420 746f 2054  eter is set to T
-00004fa0: 7275 652e 2054 6869 7320 7769 6c6c 2069  rue. This will i
-00004fb0: 6e63 7265 6173 6520 7468 6520 7072 6f63  ncrease the proc
-00004fc0: 6573 7369 6e67 2074 696d 6520 616e 6420  essing time and 
-00004fd0: 636f 7374 0d0a 2020 2020 2020 2020 2020  cost..          
-00004fe0: 2020 6966 2073 656c 662e 6c6c 6d5f 7377    if self.llm_sw
-00004ff0: 6974 6368 3a0d 0a20 2020 2020 2020 2020  itch:..         
-00005000: 2020 2020 2020 2073 656c 662e 6c6c 6d20         self.llm 
-00005010: 3d20 2767 7074 2d34 270d 0a20 2020 2020  = 'gpt-4'..     
-00005020: 2020 2020 2020 2020 2020 2069 6620 2769             if 'i
-00005030: 7079 6b65 726e 656c 2720 696e 2073 7973  pykernel' in sys
-00005040: 2e6d 6f64 756c 6573 3a0d 0a20 2020 2020  .modules:..     
-00005050: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005060: 204a 7570 7974 6572 206e 6f74 6562 6f6f   Jupyter noteboo
-00005070: 6b0d 0a20 2020 2020 2020 2020 2020 2020  k..             
-00005080: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
-00005090: 544d 4c28 273c 7370 616e 2073 7479 6c65  TML('<span style
-000050a0: 3d22 636f 6c6f 723a 206d 6167 656e 7461  ="color: magenta
-000050b0: 3b22 3e53 7769 7463 6869 6e67 206d 6f64  ;">Switching mod
-000050c0: 656c 2074 6f20 6770 742d 3420 746f 2064  el to gpt-4 to d
-000050d0: 6562 7567 2074 6865 2063 6f64 652e 3c2f  ebug the code.</
-000050e0: 7370 616e 3e27 2929 0d0a 2020 2020 2020  span>'))..      
-000050f0: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-00005100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005110: 2020 2020 2023 2043 4c49 0d0a 2020 2020       # CLI..    
-00005120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005130: 7072 696e 7428 636f 6c6f 7265 6428 225c  print(colored("\
-00005140: 6e3e 2053 7769 7463 6869 6e67 206d 6f64  n> Switching mod
-00005150: 656c 2074 6f20 4750 542d 3420 746f 2064  el to GPT-4 to d
-00005160: 6562 7567 2074 6865 2063 6f64 652e 222c  ebug the code.",
-00005170: 2022 6d61 6765 6e74 6122 2929 0d0a 2020   "magenta"))..  
-00005180: 2020 2020 2020 2020 2020 636f 6465 203d            code =
-00005190: 2073 656c 662e 6465 6275 675f 636f 6465   self.debug_code
-000051a0: 2863 6f64 652c 2071 7565 7374 696f 6e29  (code, question)
-000051b0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-000051c0: 2320 5377 6974 6368 2062 6163 6b20 746f  # Switch back to
-000051d0: 2074 6865 206f 7269 6769 6e61 6c20 6c6c   the original ll
-000051e0: 6d20 6265 666f 7265 2074 6865 2066 756e  m before the fun
-000051f0: 6374 696f 6e20 6669 6e69 7368 6573 0d0a  ction finishes..
-00005200: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005210: 2e6c 6c6d 203d 206f 7269 6769 6e61 6c5f  .llm = original_
-00005220: 6c6c 6d0d 0a0d 0a20 2020 2020 2020 2023  llm....        #
-00005230: 2052 6564 6972 6563 7420 7374 616e 6461   Redirect standa
-00005240: 7264 206f 7574 7075 7420 746f 2061 2053  rd output to a S
-00005250: 7472 696e 6749 4f20 6275 6666 6572 0d0a  tringIO buffer..
-00005260: 2020 2020 2020 2020 7769 7468 2072 6564          with red
-00005270: 6972 6563 745f 7374 646f 7574 2869 6f2e  irect_stdout(io.
-00005280: 5374 7269 6e67 494f 2829 2920 6173 206f  StringIO()) as o
-00005290: 7574 7075 743a 0d0a 2020 2020 2020 2020  utput:..        
-000052a0: 2020 2020 2320 5472 7920 746f 2065 7865      # Try to exe
-000052b0: 6375 7465 2074 6865 2063 6f64 6520 616e  cute the code an
-000052c0: 6420 6861 6e64 6c65 2065 7272 6f72 730d  d handle errors.
-000052d0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-000052e0: 6c65 2065 7272 6f72 5f63 6f72 7265 6374  le error_correct
-000052f0: 696f 6e73 203c 2073 656c 662e 4d41 585f  ions < self.MAX_
-00005300: 4552 524f 525f 434f 5252 4543 5449 4f4e  ERROR_CORRECTION
-00005310: 533a 0d0a 2020 2020 2020 2020 2020 2020  S:..            
-00005320: 2020 2020 7472 793a 0d0a 2020 2020 2020      try:..      
-00005330: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00005340: 7373 6167 6573 2e61 7070 656e 6428 7b22  ssages.append({"
-00005350: 726f 6c65 223a 2022 6173 7369 7374 616e  role": "assistan
-00005360: 7422 2c20 2263 6f6e 7465 6e74 223a 206c  t", "content": l
-00005370: 6c6d 5f72 6573 706f 6e73 657d 290d 0a20  lm_response}).. 
-00005380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005390: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
-000053a0: 6f6c 6465 7374 2063 6f6e 7665 7273 6174  oldest conversat
-000053b0: 696f 6e20 6672 6f6d 2074 6865 206d 6573  ion from the mes
-000053c0: 7361 6765 7320 6c69 7374 0d0a 2020 2020  sages list..    
-000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053e0: 6966 206c 656e 286d 6573 7361 6765 7329  if len(messages)
-000053f0: 203e 2073 656c 662e 4d41 585f 434f 4e56   > self.MAX_CONV
-00005400: 4552 5341 5449 4f4e 533a 0d0a 2020 2020  ERSATIONS:..    
-00005410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005420: 2020 2020 6d65 7373 6167 6573 2e70 6f70      messages.pop
-00005430: 2831 290d 0a20 2020 2020 2020 2020 2020  (1)..           
-00005440: 2020 2020 2020 2020 2020 2020 206d 6573               mes
-00005450: 7361 6765 732e 706f 7028 3129 0d0a 2020  sages.pop(1)..  
-00005460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005470: 2020 2320 5265 7365 7420 6466 2074 6f20    # Reset df to 
-00005480: 7468 6520 6f72 6967 696e 616c 2073 7461  the original sta
-00005490: 7465 2062 6566 6f72 6520 6578 6563 7574  te before execut
-000054a0: 696e 6720 7468 6520 636f 6465 0d0a 2020  ing the code..  
-000054b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054c0: 2020 7365 6c66 2e64 6620 3d20 7365 6c66    self.df = self
-000054d0: 2e6f 7269 6769 6e61 6c5f 6466 2e63 6f70  .original_df.cop
-000054e0: 7928 290d 0a20 2020 2020 2020 2020 2020  y()..           
-000054f0: 2020 2020 2020 2020 2023 2045 7865 6375           # Execu
-00005500: 7465 2074 6865 2063 6f64 650d 0a20 2020  te the code..   
-00005510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005520: 2069 6620 636f 6465 2069 7320 6e6f 7420   if code is not 
-00005530: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00005540: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00005550: 7865 6328 636f 6465 2c20 7b27 6466 273a  xec(code, {'df':
-00005560: 2073 656c 662e 6466 7d29 0d0a 2020 2020   self.df})..    
-00005570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005580: 6272 6561 6b0d 0a20 2020 2020 2020 2020  break..         
-00005590: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-000055a0: 6365 7074 696f 6e20 6173 2065 3a0d 0a20  ception as e:.. 
-000055b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055c0: 2020 2023 2050 7269 6e74 2074 6865 2065     # Print the e
-000055d0: 7272 6f72 206d 6573 7361 6765 0d0a 2020  rror message..  
-000055e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055f0: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
-00005600: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
-00005610: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005620: 2020 2020 2020 2020 2020 2320 4a75 7079            # Jupy
-00005630: 7465 7220 6e6f 7465 626f 6f6b 0d0a 2020  ter notebook..  
-00005640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005650: 2020 2020 2020 6469 7370 6c61 7928 4854        display(HT
-00005660: 4d4c 2866 273c 6272 3e3c 623e 3c73 7061  ML(f'<br><b><spa
-00005670: 6e20 7374 796c 653d 2263 6f6c 6f72 3a20  n style="color: 
-00005680: 2364 3836 6330 303b 223e 4920 7261 6e20  #d86c00;">I ran 
-00005690: 696e 746f 2061 6e20 6973 7375 653a 3c2f  into an issue:</
-000056a0: 7370 616e 3e3c 2f62 3e3c 6272 3e3c 7072  span></b><br><pr
-000056b0: 6520 7374 796c 653d 2263 6f6c 6f72 3a20  e style="color: 
-000056c0: 2364 3836 6330 303b 223e 7b65 7d3c 2f70  #d86c00;">{e}</p
-000056d0: 7265 3e3c 6272 3e3c 623e 3c73 7061 6e20  re><br><b><span 
-000056e0: 7374 796c 653d 2263 6f6c 6f72 3a20 2364  style="color: #d
-000056f0: 3836 6330 303b 223e 4920 7769 6c6c 2065  86c00;">I will e
-00005700: 7861 6d69 6e65 2069 742c 2061 6e64 2074  xamine it, and t
-00005710: 7279 2061 6761 696e 2077 6974 6820 616e  ry again with an
-00005720: 2061 646a 7573 7465 6420 636f 6465 2e3c   adjusted code.<
-00005730: 2f73 7061 6e3e 3c2f 623e 3c62 723e 2729  /span></b><br>')
-00005740: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00005750: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00005760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005770: 2020 2020 2020 2320 434c 490d 0a20 2020        # CLI..   
-00005780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005790: 2020 2020 2023 7072 696e 7428 636f 6c6f       #print(colo
-000057a0: 7265 6428 6627 4920 7261 6e20 696e 746f  red(f'I ran into
-000057b0: 2061 6e20 6973 7375 653a 207b 657d 2e20   an issue: {e}. 
-000057c0: 3e20 4920 7769 6c6c 2065 7861 6d69 6e65  > I will examine
-000057d0: 2069 742c 2061 6e64 2074 7279 2061 6761   it, and try aga
-000057e0: 696e 2077 6974 6820 616e 2061 646a 7573  in with an adjus
-000057f0: 7465 6420 636f 6465 2e27 2c20 2772 6564  ted code.', 'red
-00005800: 2729 290d 0a20 2020 2020 2020 2020 2020  '))..           
-00005810: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-00005820: 2e73 7464 6572 722e 7772 6974 6528 275c  .stderr.write('\
-00005830: 3033 335b 3331 6d27 202b 2066 273e 2049  033[31m' + f'> I
-00005840: 2072 616e 2069 6e74 6f20 616e 2069 7373   ran into an iss
-00005850: 7565 3a20 7b65 7d2e 205c 6e3e 2049 2077  ue: {e}. \n> I w
-00005860: 696c 6c20 6578 616d 696e 6520 6974 2c20  ill examine it, 
-00005870: 616e 6420 7472 7920 6167 6169 6e20 7769  and try again wi
-00005880: 7468 2061 6e20 6164 6a75 7374 6564 2063  th an adjusted c
-00005890: 6f64 652e 2720 2b20 275c 3033 335b 306d  ode.' + '\033[0m
-000058a0: 2720 2b20 275c 6e27 290d 0a20 2020 2020  ' + '\n')..     
-000058b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058c0: 2020 2073 7973 2e73 7464 6572 722e 666c     sys.stderr.fl
-000058d0: 7573 6828 290d 0a0d 0a20 2020 2020 2020  ush()....       
-000058e0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-000058f0: 6e63 7265 6d65 6e74 2074 6865 2065 7272  ncrement the err
-00005900: 6f72 2063 6f72 7265 6374 696f 6e20 636f  or correction co
-00005910: 756e 7465 7220 616e 6420 7570 6461 7465  unter and update
-00005920: 2074 6865 206d 6573 7361 6765 7320 6c69   the messages li
-00005930: 7374 2077 6974 6820 7468 6520 6572 726f  st with the erro
-00005940: 720d 0a20 2020 2020 2020 2020 2020 2020  r..             
-00005950: 2020 2020 2020 2065 7272 6f72 5f63 6f72         error_cor
-00005960: 7265 6374 696f 6e73 202b 3d20 310d 0a20  rections += 1.. 
-00005970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005980: 2020 206d 6573 7361 6765 732e 6170 7065     messages.appe
-00005990: 6e64 287b 2272 6f6c 6522 3a20 2275 7365  nd({"role": "use
-000059a0: 7222 2c20 2263 6f6e 7465 6e74 223a 2073  r", "content": s
-000059b0: 656c 662e 6572 726f 725f 636f 7272 6563  elf.error_correc
-000059c0: 745f 7461 736b 2e66 6f72 6d61 7428 6529  t_task.format(e)
-000059d0: 7d29 0d0a 0d0a 2020 2020 2020 2020 2020  })....          
-000059e0: 2020 2020 2020 2020 2020 2320 5377 6974            # Swit
-000059f0: 6368 2074 6f20 6770 742d 3420 6966 206c  ch to gpt-4 if l
-00005a00: 6c6d 5f73 7769 7463 6820 7061 7261 6d65  lm_switch parame
-00005a10: 7465 7220 6973 2073 6574 2074 6f20 5472  ter is set to Tr
-00005a20: 7565 2e20 5468 6973 2077 696c 6c20 696e  ue. This will in
-00005a30: 6372 6561 7365 2074 6865 2070 726f 6365  crease the proce
-00005a40: 7373 696e 6720 7469 6d65 2061 6e64 2063  ssing time and c
-00005a50: 6f73 742e 0d0a 2020 2020 2020 2020 2020  ost...          
-00005a60: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00005a70: 662e 6c6c 6d5f 7377 6974 6368 3a0d 0a20  f.llm_switch:.. 
-00005a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a90: 2020 2020 2020 2073 656c 662e 6c6c 6d20         self.llm 
-00005aa0: 3d20 2767 7074 2d34 270d 0a20 2020 2020  = 'gpt-4'..     
-00005ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ac0: 2020 2069 6620 2769 7079 6b65 726e 656c     if 'ipykernel
-00005ad0: 2720 696e 2073 7973 2e6d 6f64 756c 6573  ' in sys.modules
-00005ae0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00005af0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005b00: 204a 7570 7974 6572 206e 6f74 6562 6f6f   Jupyter noteboo
-00005b10: 6b0d 0a20 2020 2020 2020 2020 2020 2020  k..             
-00005b20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00005b30: 6973 706c 6179 2848 544d 4c28 273c 7370  isplay(HTML('<sp
-00005b40: 616e 2073 7479 6c65 3d22 636f 6c6f 723a  an style="color:
-00005b50: 2023 6438 3663 3030 3b22 3e53 7769 7463   #d86c00;">Switc
-00005b60: 6869 6e67 206d 6f64 656c 2074 6f20 6770  hing model to gp
-00005b70: 742d 3420 746f 2074 7279 2074 6f20 696d  t-4 to try to im
-00005b80: 7072 6f76 6520 7468 6520 6f75 7463 6f6d  prove the outcom
-00005b90: 652e 3c2f 7370 616e 3e27 2929 0d0a 2020  e.</span>'))..  
-00005ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bb0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00005bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bd0: 2020 2020 2020 2020 2023 2043 4c49 0d0a           # CLI..
-00005be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bf0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-00005c00: 7374 6465 7272 2e77 7269 7465 2827 5c30  stderr.write('\0
-00005c10: 3333 5b33 316d 2720 2b20 6627 3e20 5377  33[31m' + f'> Sw
-00005c20: 6974 6368 696e 6720 6d6f 6465 6c20 746f  itching model to
-00005c30: 2067 7074 2d34 2074 6f20 7472 7920 746f   gpt-4 to try to
-00005c40: 2069 6d70 726f 7665 2074 6865 206f 7574   improve the out
-00005c50: 636f 6d65 2e27 202b 2027 5c30 3333 5b30  come.' + '\033[0
-00005c60: 6d27 202b 2027 5c6e 2729 0d0a 2020 2020  m' + '\n')..    
-00005c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c80: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-00005c90: 7272 2e66 6c75 7368 2829 0d0a 0d0a 2020  rr.flush()....  
-00005ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cb0: 2020 2320 4174 7465 6d70 7420 746f 2063    # Attempt to c
-00005cc0: 6f72 7265 6374 2074 6865 2063 6f64 6520  orrect the code 
-00005cd0: 616e 6420 6861 6e64 6c65 2072 6174 6520  and handle rate 
-00005ce0: 6c69 6d69 7420 6572 726f 7273 0d0a 2020  limit errors..  
-00005cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d00: 2020 7472 793a 0d0a 2020 2020 2020 2020    try:..        
+00000120: 2729 0d0a 6672 6f6d 202e 2069 6d70 6f72  ')..from . impor
+00000130: 7420 7072 6f6d 7074 730d 0a0d 0a63 6c61  t prompts....cla
+00000140: 7373 2042 616d 626f 6f41 493a 0d0a 2020  ss BambooAI:..  
+00000150: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00000160: 656c 662c 2064 663a 2070 642e 4461 7461  elf, df: pd.Data
+00000170: 4672 616d 652c 0d0a 2020 2020 2020 2020  Frame,..        
+00000180: 2020 2020 2020 2020 206d 6178 5f63 6f6e           max_con
+00000190: 7665 7273 6174 696f 6e73 3a20 696e 7420  versations: int 
+000001a0: 3d20 3220 2c0d 0a20 2020 2020 2020 2020  = 2 ,..         
+000001b0: 2020 2020 2020 2020 6c6c 6d3a 2073 7472          llm: str
+000001c0: 203d 2027 6770 742d 332e 352d 7475 7262   = 'gpt-3.5-turb
+000001d0: 6f27 2c0d 0a20 2020 2020 2020 2020 2020  o',..           
+000001e0: 2020 2020 2020 6465 6275 673a 2062 6f6f        debug: boo
+000001f0: 6c20 3d20 4661 6c73 652c 200d 0a20 2020  l = False, ..   
+00000200: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00000210: 6e6b 3a20 626f 6f6c 203d 2046 616c 7365  nk: bool = False
+00000220: 2c20 0d0a 2020 2020 2020 2020 2020 2020  , ..            
+00000230: 2020 2020 206c 6c6d 5f73 7769 7463 683a       llm_switch:
+00000240: 2062 6f6f 6c20 3d20 4661 6c73 652c 200d   bool = False, .
+00000250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000260: 2020 6578 706c 6f72 6174 6f72 793a 2062    exploratory: b
+00000270: 6f6f 6c20 3d20 5472 7565 2c20 0d0a 2020  ool = True, ..  
+00000280: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00000290: 6c6f 775f 6469 6167 7261 6d3a 2062 6f6f  low_diagram: boo
+000002a0: 6c20 3d20 4661 6c73 650d 0a20 2020 2020  l = False..     
+000002b0: 2020 2020 2020 2020 2020 2020 293a 0d0a              ):..
+000002c0: 0d0a 2020 2020 2020 2020 7365 6c66 2e41  ..        self.A
+000002d0: 5049 5f4b 4559 203d 206f 732e 656e 7669  PI_KEY = os.envi
+000002e0: 726f 6e2e 6765 7428 274f 5045 4e41 495f  ron.get('OPENAI_
+000002f0: 4150 495f 4b45 5927 290d 0a20 2020 2020  API_KEY')..     
+00000300: 2020 2073 656c 662e 4d41 585f 4552 524f     self.MAX_ERRO
+00000310: 525f 434f 5252 4543 5449 4f4e 5320 3d20  R_CORRECTIONS = 
+00000320: 350d 0a20 2020 2020 2020 2023 2053 6574  5..        # Set
+00000330: 2074 6865 206d 6178 696d 756d 206e 756d   the maximum num
+00000340: 6265 7220 6f66 2071 7565 7374 696f 6e2f  ber of question/
+00000350: 616e 7377 6572 2070 6169 7273 2074 6f20  answer pairs to 
+00000360: 6265 206b 6570 7420 696e 2074 6865 2063  be kept in the c
+00000370: 6f6e 7665 7273 6174 696f 6e20 6d65 6d6d  onversation memm
+00000380: 6f72 790d 0a20 2020 2020 2020 2073 656c  ory..        sel
+00000390: 662e 4d41 585f 434f 4e56 4552 5341 5449  f.MAX_CONVERSATI
+000003a0: 4f4e 5320 3d20 286d 6178 5f63 6f6e 7665  ONS = (max_conve
+000003b0: 7273 6174 696f 6e73 2a32 2920 2d20 310d  rsations*2) - 1.
+000003c0: 0a20 2020 2020 2020 200d 0a20 2020 2020  .        ..     
+000003d0: 2020 2023 2053 746f 7265 2074 6865 206f     # Store the o
+000003e0: 7269 6769 6e61 6c20 6461 7461 6672 616d  riginal datafram
+000003f0: 652e 2054 6869 7320 7769 6c6c 2062 6520  e. This will be 
+00000400: 7573 6564 2074 6f20 7265 7365 7420 7468  used to reset th
+00000410: 6520 6461 7461 6672 616d 6520 6265 666f  e dataframe befo
+00000420: 7265 2065 7865 6375 7469 6e67 2074 6865  re executing the
+00000430: 2063 6f64 650d 0a20 2020 2020 2020 2073   code..        s
+00000440: 656c 662e 6f72 6967 696e 616c 5f64 6620  elf.original_df 
+00000450: 3d20 6466 0d0a 2020 2020 2020 2020 7365  = df..        se
+00000460: 6c66 2e64 6620 3d20 6466 2e63 6f70 7928  lf.df = df.copy(
+00000470: 2920 2023 206d 616b 6520 6120 636f 7079  )  # make a copy
+00000480: 206f 6620 7468 6520 6461 7461 6672 616d   of the datafram
+00000490: 650d 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+000004a0: 6466 5f68 6561 6420 3d20 7365 6c66 2e6f  df_head = self.o
+000004b0: 7269 6769 6e61 6c5f 6466 2e68 6561 6428  riginal_df.head(
+000004c0: 3129 0d0a 2020 2020 0d0a 2020 2020 2020  1)..    ..      
+000004d0: 2020 7365 6c66 2e6c 6c6d 203d 206c 6c6d    self.llm = llm
+000004e0: 0d0a 2020 2020 2020 2020 2320 5365 7420  ..        # Set 
+000004f0: 7468 6520 6465 6275 6720 6d6f 6465 2e20  the debug mode. 
+00000500: 5468 6973 206d 6f64 6520 6973 2054 7275  This mode is Tru
+00000510: 6520 7768 656e 2079 6f75 2077 616e 7420  e when you want 
+00000520: 7468 6520 6d6f 6465 6c20 746f 2064 6562  the model to deb
+00000530: 7567 2074 6865 2063 6f64 6520 616e 6420  ug the code and 
+00000540: 636f 7272 6563 7420 6974 2e0d 0a20 2020  correct it...   
+00000550: 2020 2020 2073 656c 662e 6465 6275 6720       self.debug 
+00000560: 3d20 6465 6275 670d 0a20 2020 2020 2020  = debug..       
+00000570: 2023 2053 6574 2074 6865 206c 6c6d 5f73   # Set the llm_s
+00000580: 7769 7463 6820 6d6f 6465 2e20 5468 6973  witch mode. This
+00000590: 206d 6f64 6520 6973 2054 7275 6520 7768   mode is True wh
+000005a0: 656e 2079 6f75 2077 616e 7420 7468 6520  en you want the 
+000005b0: 6d6f 6465 6c20 746f 2073 7769 7463 6820  model to switch 
+000005c0: 746f 2067 7074 2d34 2066 6f72 2064 6562  to gpt-4 for deb
+000005d0: 7567 6769 6e67 2c20 6572 726f 7220 636f  ugging, error co
+000005e0: 7272 6563 7469 6f6e 2061 6e64 2072 616e  rrection and ran
+000005f0: 6b69 6e67 2e0d 0a20 2020 2020 2020 2073  king...        s
+00000600: 656c 662e 6c6c 6d5f 7377 6974 6368 203d  elf.llm_switch =
+00000610: 206c 6c6d 5f73 7769 7463 680d 0a20 2020   llm_switch..   
+00000620: 2020 2020 2023 2053 6574 2074 6865 2072       # Set the r
+00000630: 616e 6b20 6d6f 6465 2e20 5468 6973 206d  ank mode. This m
+00000640: 6f64 6520 6973 2054 7275 6520 7768 656e  ode is True when
+00000650: 2079 6f75 2077 616e 7420 7468 6520 6d6f   you want the mo
+00000660: 6465 6c20 746f 2072 616e 6b20 7468 6520  del to rank the 
+00000670: 6765 6e65 7261 7465 6420 636f 6465 2e0d  generated code..
+00000680: 0a20 2020 2020 2020 2073 656c 662e 7261  .        self.ra
+00000690: 6e6b 203d 2072 616e 6b0d 0a0d 0a20 2020  nk = rank....   
+000006a0: 2020 2020 2023 2053 6574 2074 6865 2065       # Set the e
+000006b0: 7870 6c6f 7261 746f 7279 206d 6f64 652e  xploratory mode.
+000006c0: 2054 6869 7320 6d6f 6465 2069 7320 5472   This mode is Tr
+000006d0: 7565 2077 6865 6e20 796f 7520 7761 6e74  ue when you want
+000006e0: 2074 6865 206d 6f64 656c 2074 6f20 6576   the model to ev
+000006f0: 616c 7561 7465 2074 6865 206f 7269 6769  aluate the origi
+00000700: 6e61 6c20 7072 6f6d 7074 2061 6e64 2062  nal prompt and b
+00000710: 7265 616b 2069 7420 646f 776e 2069 6e20  reak it down in 
+00000720: 6865 7572 6973 7469 6320 616c 676f 7269  heuristic algori
+00000730: 7468 6d2e 0d0a 2020 2020 2020 2020 7365  thm...        se
+00000740: 6c66 2e65 7870 6c6f 7261 746f 7279 203d  lf.exploratory =
+00000750: 2065 7870 6c6f 7261 746f 7279 0d0a 0d0a   exploratory....
+00000760: 2020 2020 2020 2020 2320 5365 7420 7468          # Set th
+00000770: 6520 666c 6f77 5f64 6961 6772 616d 206d  e flow_diagram m
+00000780: 6f64 652e 2054 6869 7320 6d6f 6465 2069  ode. This mode i
+00000790: 7320 5472 7565 2077 6865 6e20 796f 7520  s True when you 
+000007a0: 7761 6e74 2074 6865 206d 6f64 656c 2074  want the model t
+000007b0: 6f20 6765 6e65 7261 7465 2061 2066 6c6f  o generate a flo
+000007c0: 7720 6469 6167 7261 6d2e 0d0a 2020 2020  w diagram...    
+000007d0: 2020 2020 7365 6c66 2e66 6c6f 775f 6469      self.flow_di
+000007e0: 6167 7261 6d20 3d20 666c 6f77 5f64 6961  agram = flow_dia
+000007f0: 6772 616d 0d0a 2020 2020 2020 2020 0d0a  gram..        ..
+00000800: 2020 2020 2020 2020 2320 5072 6f6d 7074          # Prompt
+00000810: 730d 0a20 2020 2020 2020 2073 656c 662e  s..        self.
+00000820: 7461 736b 5f65 7661 6c75 6174 696f 6e20  task_evaluation 
+00000830: 3d20 7072 6f6d 7074 732e 7461 736b 5f65  = prompts.task_e
+00000840: 7661 6c75 6174 696f 6e0d 0a20 2020 2020  valuation..     
+00000850: 2020 2073 656c 662e 7379 7374 656d 5f74     self.system_t
+00000860: 6173 6b20 3d20 7072 6f6d 7074 732e 7379  ask = prompts.sy
+00000870: 7374 656d 5f74 6173 6b0d 0a20 2020 2020  stem_task..     
+00000880: 2020 2073 656c 662e 7461 736b 203d 2070     self.task = p
+00000890: 726f 6d70 7473 2e74 6173 6b0d 0a20 2020  rompts.task..   
+000008a0: 2020 2020 2073 656c 662e 6572 726f 725f       self.error_
+000008b0: 636f 7272 6563 745f 7461 736b 203d 2070  correct_task = p
+000008c0: 726f 6d70 7473 2e65 7272 6f72 5f63 6f72  rompts.error_cor
+000008d0: 7265 6374 5f74 6173 6b0d 0a20 2020 2020  rect_task..     
+000008e0: 2020 2073 656c 662e 6465 6275 675f 636f     self.debug_co
+000008f0: 6465 5f74 6173 6b20 3d20 7072 6f6d 7074  de_task = prompt
+00000900: 732e 6465 6275 675f 636f 6465 5f74 6173  s.debug_code_tas
+00000910: 6b20 200d 0a20 2020 2020 2020 2073 656c  k  ..        sel
+00000920: 662e 7261 6e6b 5f61 6e73 7765 7220 3d20  f.rank_answer = 
+00000930: 7072 6f6d 7074 732e 7261 6e6b 5f61 6e73  prompts.rank_ans
+00000940: 7765 720d 0a20 2020 2020 2020 200d 0a20  wer..        .. 
+00000950: 2020 2020 2020 206f 7065 6e61 692e 6170         openai.ap
+00000960: 695f 6b65 7920 3d20 7365 6c66 2e41 5049  i_key = self.API
+00000970: 5f4b 4559 0d0a 2020 2020 2020 2020 2320  _KEY..        # 
+00000980: 496e 6974 6961 6c69 7a65 2074 6865 2074  Initialize the t
+00000990: 6f74 616c 2074 6f6b 656e 7320 7573 6564  otal tokens used
+000009a0: 206c 6973 742e 2054 6869 7320 6c69 7374   list. This list
+000009b0: 2077 696c 6c20 6265 2075 7365 6420 746f   will be used to
+000009c0: 206b 6565 7020 7472 6163 6b20 6f66 2074   keep track of t
+000009d0: 6865 2074 6f74 616c 2074 6f6b 656e 7320  he total tokens 
+000009e0: 7573 6564 2062 7920 7468 6520 6d6f 6465  used by the mode
+000009f0: 6c0d 0a20 2020 2020 2020 2073 656c 662e  l..        self.
+00000a00: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
+00000a10: 6420 3d20 5b5d 0d0a 0d0a 2020 2020 6465  d = []....    de
+00000a20: 6620 6d6d 2873 656c 662c 2067 7261 7068  f mm(self, graph
+00000a30: 293a 0d0a 2020 2020 2020 2020 6772 6170  ):..        grap
+00000a40: 6862 7974 6573 203d 2067 7261 7068 2e65  hbytes = graph.e
+00000a50: 6e63 6f64 6528 2261 7363 6969 2229 0d0a  ncode("ascii")..
+00000a60: 2020 2020 2020 2020 6261 7365 3634 5f62          base64_b
+00000a70: 7974 6573 203d 2062 6173 6536 342e 6236  ytes = base64.b6
+00000a80: 3465 6e63 6f64 6528 6772 6170 6862 7974  4encode(graphbyt
+00000a90: 6573 290d 0a20 2020 2020 2020 2062 6173  es)..        bas
+00000aa0: 6536 345f 7374 7269 6e67 203d 2062 6173  e64_string = bas
+00000ab0: 6536 345f 6279 7465 732e 6465 636f 6465  e64_bytes.decode
+00000ac0: 2822 6173 6369 6922 290d 0a20 2020 2020  ("ascii")..     
+00000ad0: 2020 2069 6d67 5f75 726c 203d 2022 6874     img_url = "ht
+00000ae0: 7470 733a 2f2f 6d65 726d 6169 642e 696e  tps://mermaid.in
+00000af0: 6b2f 696d 672f 2220 2b20 6261 7365 3634  k/img/" + base64
+00000b00: 5f73 7472 696e 670d 0a20 2020 2020 2020  _string..       
+00000b10: 2072 6574 7572 6e20 696d 675f 7572 6c0d   return img_url.
+00000b20: 0a0d 0a20 2020 2064 6566 206c 6c6d 5f63  ...    def llm_c
+00000b30: 616c 6c28 7365 6c66 2c20 6d65 7373 6167  all(self, messag
+00000b40: 6573 3a20 7374 722c 2074 656d 7065 7261  es: str, tempera
+00000b50: 7475 7265 3a20 666c 6f61 7420 3d20 302c  ture: float = 0,
+00000b60: 206d 6178 5f74 6f6b 656e 733a 2069 6e74   max_tokens: int
+00000b70: 203d 2032 3030 3029 3a0d 0a20 2020 2020   = 2000):..     
+00000b80: 2020 2072 6573 706f 6e73 6520 3d20 6f70     response = op
+00000b90: 656e 6169 2e43 6861 7443 6f6d 706c 6574  enai.ChatComplet
+00000ba0: 696f 6e2e 6372 6561 7465 280d 0a20 2020  ion.create(..   
+00000bb0: 2020 2020 2020 2020 206d 6f64 656c 3d73           model=s
+00000bc0: 656c 662e 6c6c 6d2c 0d0a 2020 2020 2020  elf.llm,..      
+00000bd0: 2020 2020 2020 6d65 7373 6167 6573 3d6d        messages=m
+00000be0: 6573 7361 6765 732c 0d0a 2020 2020 2020  essages,..      
+00000bf0: 2020 2020 2020 7465 6d70 6572 6174 7572        temperatur
+00000c00: 653d 7465 6d70 6572 6174 7572 652c 0d0a  e=temperature,..
+00000c10: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00000c20: 746f 6b65 6e73 3d6d 6178 5f74 6f6b 656e  tokens=max_token
+00000c30: 732c 0d0a 2020 2020 2020 2020 290d 0a0d  s,..        )...
+00000c40: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+00000c50: 203d 2072 6573 706f 6e73 652e 6368 6f69   = response.choi
+00000c60: 6365 735b 305d 2e6d 6573 7361 6765 2e63  ces[0].message.c
+00000c70: 6f6e 7465 6e74 2e73 7472 6970 2829 0d0a  ontent.strip()..
+00000c80: 2020 2020 2020 2020 746f 6b65 6e73 5f75          tokens_u
+00000c90: 7365 6420 3d20 7265 7370 6f6e 7365 2e75  sed = response.u
+00000ca0: 7361 6765 2e74 6f74 616c 5f74 6f6b 656e  sage.total_token
+00000cb0: 730d 0a0d 0a20 2020 2020 2020 2072 6574  s....        ret
+00000cc0: 7572 6e20 636f 6e74 656e 742c 2074 6f6b  urn content, tok
+00000cd0: 656e 735f 7573 6564 0d0a 2020 2020 0d0a  ens_used..    ..
+00000ce0: 2020 2020 2320 4675 6e63 7469 6f6e 7320      # Functions 
+00000cf0: 746f 2073 616e 6974 697a 6520 7468 6520  to sanitize the 
+00000d00: 6f75 7470 7574 2066 726f 6d20 7468 6520  output from the 
+00000d10: 4c4c 4d0d 0a20 2020 2064 6566 205f 6578  LLM..    def _ex
+00000d20: 7472 6163 745f 636f 6465 2873 656c 662c  tract_code(self,
+00000d30: 7265 7370 6f6e 7365 3a20 7374 722c 2073  response: str, s
+00000d40: 6570 6172 6174 6f72 3a20 7374 7220 3d20  eparator: str = 
+00000d50: 2260 6060 2229 202d 3e20 7374 723a 0d0a  "```") -> str:..
+00000d60: 0d0a 2020 2020 2020 2020 2320 4465 6669  ..        # Defi
+00000d70: 6e65 2061 2062 6c61 636b 6c69 7374 206f  ne a blacklist o
+00000d80: 6620 5079 7468 6f6e 206b 6579 776f 7264  f Python keyword
+00000d90: 7320 616e 6420 6675 6e63 7469 6f6e 7320  s and functions 
+00000da0: 7468 6174 2061 7265 206e 6f74 2061 6c6c  that are not all
+00000db0: 6f77 6564 0d0a 2020 2020 2020 2020 626c  owed..        bl
+00000dc0: 6163 6b6c 6973 7420 3d20 5b27 6f73 272c  acklist = ['os',
+00000dd0: 2773 7562 7072 6f63 6573 7327 2c27 7379  'subprocess','sy
+00000de0: 7327 2c27 6576 616c 272c 2765 7865 6327  s','eval','exec'
+00000df0: 2c27 6669 6c65 272c 2773 6f63 6b65 7427  ,'file','socket'
+00000e00: 2c27 7572 6c6c 6962 272c 0d0a 2020 2020  ,'urllib',..    
+00000e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000e20: 2773 6875 7469 6c27 2c27 7069 636b 6c65  'shutil','pickle
+00000e30: 272c 2763 7479 7065 7327 2c27 6d75 6c74  ','ctypes','mult
+00000e40: 6970 726f 6365 7373 696e 6727 2c27 7465  iprocessing','te
+00000e50: 6d70 6669 6c65 272c 2767 6c6f 6227 2c27  mpfile','glob','
+00000e60: 636f 6465 272c 2770 7479 272c 2763 6f6d  code','pty','com
+00000e70: 6d61 6e64 7327 2c0d 0a20 2020 2020 2020  mands',..       
+00000e80: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00000e90: 7175 6573 7473 272c 2763 6769 272c 2763  quests','cgi','c
+00000ea0: 6769 7462 272c 2778 6d6c 2e65 7472 6565  gitb','xml.etree
+00000eb0: 2e45 6c65 6d65 6e74 5472 6565 272c 2762  .ElementTree','b
+00000ec0: 7569 6c74 696e 7327 0d0a 2020 2020 2020  uiltins'..      
+00000ed0: 2020 2020 2020 2020 2020 2020 2020 5d0d                ].
+00000ee0: 0a20 2020 2020 2020 200d 0a20 2020 2020  .        ..     
+00000ef0: 2020 2023 2053 6561 7263 6820 666f 7220     # Search for 
+00000f00: 6120 7061 7474 6572 6e20 6265 7477 6565  a pattern betwee
+00000f10: 6e20 3c72 6566 6c65 6374 696f 6e3e 2061  n <reflection> a
+00000f20: 6e64 203c 2f72 6566 6c65 6374 696f 6e3e  nd </reflection>
+00000f30: 2069 6e20 7468 6520 7265 7370 6f6e 7365   in the response
+00000f40: 0d0a 2020 2020 2020 2020 6d61 7463 6820  ..        match 
+00000f50: 3d20 7265 2e73 6561 7263 6828 7222 3c72  = re.search(r"<r
+00000f60: 6566 6c65 6374 696f 6e3e 282e 2a29 3c2f  eflection>(.*)</
+00000f70: 7265 666c 6563 7469 6f6e 3e22 2c20 7265  reflection>", re
+00000f80: 7370 6f6e 7365 2c20 7265 2e44 4f54 414c  sponse, re.DOTAL
+00000f90: 4c29 0d0a 2020 2020 2020 2020 6966 206d  L)..        if m
+00000fa0: 6174 6368 3a0d 0a20 2020 2020 2020 2020  atch:..         
+00000fb0: 2020 2023 2049 6620 6120 6d61 7463 6820     # If a match 
+00000fc0: 6973 2066 6f75 6e64 2c20 6578 7472 6163  is found, extrac
+00000fd0: 7420 7468 6520 7265 666c 6563 7469 6f6e  t the reflection
+00000fe0: 2062 6574 7765 656e 203c 7265 666c 6563   between <reflec
+00000ff0: 7469 6f6e 3e20 616e 6420 3c2f 7265 666c  tion> and </refl
+00001000: 6563 7469 6f6e 3e0d 0a20 2020 2020 2020  ection>..       
+00001010: 2020 2020 2072 6566 6c65 6374 696f 6e20       reflection 
+00001020: 3d20 6d61 7463 682e 6772 6f75 7028 3129  = match.group(1)
+00001030: 0d0a 2020 2020 2020 2020 656c 7365 3a0d  ..        else:.
+00001040: 0a20 2020 2020 2020 2020 2020 2072 6566  .            ref
+00001050: 6c65 6374 696f 6e20 3d20 2222 0d0a 0d0a  lection = ""....
+00001060: 2020 2020 2020 2020 2320 5365 6172 6368          # Search
+00001070: 2066 6f72 2061 2070 6174 7465 726e 2062   for a pattern b
+00001080: 6574 7765 656e 203c 666c 6f77 3e20 616e  etween <flow> an
+00001090: 6420 3c2f 666c 6f77 3e20 696e 2074 6865  d </flow> in the
+000010a0: 2072 6573 706f 6e73 650d 0a20 2020 2020   response..     
+000010b0: 2020 206d 6174 6368 203d 2072 652e 7365     match = re.se
+000010c0: 6172 6368 2872 223c 666c 6f77 3e28 2e2a  arch(r"<flow>(.*
+000010d0: 293c 2f66 6c6f 773e 222c 2072 6573 706f  )</flow>", respo
+000010e0: 6e73 652c 2072 652e 444f 5441 4c4c 290d  nse, re.DOTALL).
+000010f0: 0a20 2020 2020 2020 2069 6620 6d61 7463  .        if matc
+00001100: 683a 0d0a 2020 2020 2020 2020 2020 2020  h:..            
+00001110: 2320 4966 2061 206d 6174 6368 2069 7320  # If a match is 
+00001120: 666f 756e 642c 2065 7874 7261 6374 2074  found, extract t
+00001130: 6865 2072 6566 6c65 6374 696f 6e20 6265  he reflection be
+00001140: 7477 6565 6e20 3c66 6c6f 773e 2061 6e64  tween <flow> and
+00001150: 203c 2f66 6c6f 773e 0d0a 2020 2020 2020   </flow>..      
+00001160: 2020 2020 2020 666c 6f77 203d 206d 6174        flow = mat
+00001170: 6368 2e67 726f 7570 2831 290d 0a20 2020  ch.group(1)..   
+00001180: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00001190: 2020 2020 2020 2020 666c 6f77 203d 2022          flow = "
+000011a0: 220d 0a0d 0a20 2020 2020 2020 2023 2053  "....        # S
+000011b0: 6561 7263 6820 666f 7220 6120 7061 7474  earch for a patt
+000011c0: 6572 6e20 6265 7477 6565 6e20 3c72 616e  ern between <ran
+000011d0: 6b3e 2061 6e64 203c 2f72 616e 6b3e 2069  k> and </rank> i
+000011e0: 6e20 7468 6520 7265 7370 6f6e 7365 0d0a  n the response..
+000011f0: 2020 2020 2020 2020 6d61 7463 6820 3d20          match = 
+00001200: 7265 2e73 6561 7263 6828 7222 3c72 616e  re.search(r"<ran
+00001210: 6b3e 282e 2a29 3c2f 7261 6e6b 3e22 2c20  k>(.*)</rank>", 
+00001220: 7265 7370 6f6e 7365 290d 0a20 2020 2020  response)..     
+00001230: 2020 2069 6620 6d61 7463 683a 0d0a 2020     if match:..  
+00001240: 2020 2020 2020 2020 2020 2320 4966 2061            # If a
+00001250: 206d 6174 6368 2069 7320 666f 756e 642c   match is found,
+00001260: 2065 7874 7261 6374 2074 6865 2072 6566   extract the ref
+00001270: 6c65 6374 696f 6e20 6265 7477 6565 6e20  lection between 
+00001280: 3c72 616e 6b3e 2061 6e64 203c 2f72 616e  <rank> and </ran
+00001290: 6b3e 0d0a 2020 2020 2020 2020 2020 2020  k>..            
+000012a0: 7261 6e6b 203d 206d 6174 6368 2e67 726f  rank = match.gro
+000012b0: 7570 2831 290d 0a20 2020 2020 2020 2065  up(1)..        e
+000012c0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+000012d0: 2020 7261 6e6b 203d 2022 220d 0a0d 0a20    rank = "".... 
+000012e0: 2020 2020 2020 2023 2053 6561 7263 6820         # Search 
+000012f0: 666f 7220 6120 7061 7474 6572 6e20 6265  for a pattern be
+00001300: 7477 6565 6e20 3c63 6f64 653e 2061 6e64  tween <code> and
+00001310: 203c 2f63 6f64 653e 2069 6e20 7468 6520   </code> in the 
+00001320: 6578 7472 6163 7465 6420 636f 6465 0d0a  extracted code..
+00001330: 2020 2020 2020 2020 6d61 7463 6820 3d20          match = 
+00001340: 7265 2e73 6561 7263 6828 7222 3c63 6f64  re.search(r"<cod
+00001350: 653e 282e 2a29 3c2f 636f 6465 3e22 2c20  e>(.*)</code>", 
+00001360: 7265 7370 6f6e 7365 2c20 7265 2e44 4f54  response, re.DOT
+00001370: 414c 4c29 0d0a 2020 2020 2020 2020 6966  ALL)..        if
+00001380: 206d 6174 6368 3a0d 0a20 2020 2020 2020   match:..       
+00001390: 2020 2020 2023 2049 6620 6120 6d61 7463       # If a matc
+000013a0: 6820 6973 2066 6f75 6e64 2c20 6578 7472  h is found, extr
+000013b0: 6163 7420 7468 6520 636f 6465 2062 6574  act the code bet
+000013c0: 7765 656e 203c 636f 6465 3e20 616e 6420  ween <code> and 
+000013d0: 3c2f 636f 6465 3e0d 0a20 2020 2020 2020  </code>..       
+000013e0: 2020 2020 2063 6f64 6520 3d20 6d61 7463       code = matc
+000013f0: 682e 6772 6f75 7028 3129 0d0a 2020 2020  h.group(1)..    
+00001400: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+00001410: 2072 6573 706f 6e73 6520 636f 6e74 6169   response contai
+00001420: 6e73 2074 6865 2073 6570 6172 6174 6f72  ns the separator
+00001430: 2c20 6578 7472 6163 7420 7468 6520 636f  , extract the co
+00001440: 6465 2062 6c6f 636b 2062 6574 7765 656e  de block between
+00001450: 2074 6865 2073 6570 6172 6174 6f72 730d   the separators.
+00001460: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00001470: 6c65 6e28 636f 6465 2e73 706c 6974 2873  len(code.split(s
+00001480: 6570 6172 6174 6f72 2929 203e 2031 3a0d  eparator)) > 1:.
+00001490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000014a0: 2063 6f64 6520 3d20 636f 6465 2e73 706c   code = code.spl
+000014b0: 6974 2873 6570 6172 6174 6f72 295b 315d  it(separator)[1]
+000014c0: 0d0a 0d0a 2020 2020 2020 2020 2320 4966  ....        # If
+000014d0: 2074 6865 2072 6573 706f 6e73 6520 636f   the response co
+000014e0: 6e74 6169 6e73 2074 6865 2073 6570 6172  ntains the separ
+000014f0: 6174 6f72 2c20 6578 7472 6163 7420 7468  ator, extract th
+00001500: 6520 636f 6465 2062 6c6f 636b 2062 6574  e code block bet
+00001510: 7765 656e 2074 6865 2073 6570 6172 6174  ween the separat
+00001520: 6f72 730d 0a20 2020 2020 2020 2069 6620  ors..        if 
+00001530: 6c65 6e28 7265 7370 6f6e 7365 2e73 706c  len(response.spl
+00001540: 6974 2873 6570 6172 6174 6f72 2929 203e  it(separator)) >
+00001550: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
+00001560: 2063 6f64 6520 3d20 7265 7370 6f6e 7365   code = response
+00001570: 2e73 706c 6974 2873 6570 6172 6174 6f72  .split(separator
+00001580: 295b 315d 0d0a 2020 2020 2020 2020 2020  )[1]..          
+00001590: 2020 0d0a 2020 2020 2020 2020 2320 5265    ..        # Re
+000015a0: 6d6f 7665 2074 6865 2022 7079 7468 6f6e  move the "python
+000015b0: 2220 6f72 2022 7079 2220 7072 6566 6978  " or "py" prefix
+000015c0: 2069 6620 7072 6573 656e 740d 0a20 2020   if present..   
+000015d0: 2020 2020 2069 6620 7265 2e6d 6174 6368       if re.match
+000015e0: 2872 225e 2870 7974 686f 6e7c 7079 2922  (r"^(python|py)"
+000015f0: 2c20 636f 6465 293a 0d0a 2020 2020 2020  , code):..      
+00001600: 2020 2020 2020 636f 6465 203d 2072 652e        code = re.
+00001610: 7375 6228 7222 5e28 7079 7468 6f6e 7c70  sub(r"^(python|p
+00001620: 7929 222c 2022 222c 2063 6f64 6529 0d0a  y)", "", code)..
+00001630: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+00001640: 2063 6f64 6520 6973 2062 6574 7765 656e   code is between
+00001650: 2073 696e 676c 6520 6261 636b 7469 636b   single backtick
+00001660: 732c 2065 7874 7261 6374 2074 6865 2063  s, extract the c
+00001670: 6f64 6520 6265 7477 6565 6e20 7468 656d  ode between them
+00001680: 0d0a 2020 2020 2020 2020 6966 2072 652e  ..        if re.
+00001690: 6d61 7463 6828 7222 5e60 2e2a 6024 222c  match(r"^`.*`$",
+000016a0: 2063 6f64 6529 3a0d 0a20 2020 2020 2020   code):..       
+000016b0: 2020 2020 2063 6f64 6520 3d20 7265 2e73       code = re.s
+000016c0: 7562 2872 225e 6028 2e2a 2960 2422 2c20  ub(r"^`(.*)`$", 
+000016d0: 7222 5c31 222c 2063 6f64 6529 0d0a 0d0a  r"\1", code)....
+000016e0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+000016f0: 2061 6e79 2069 6e73 7461 6e63 6573 206f   any instances o
+00001700: 6620 2264 6620 3d20 7064 2e72 6561 645f  f "df = pd.read_
+00001710: 6373 7628 2766 696c 656e 616d 652e 6373  csv('filename.cs
+00001720: 7627 2922 2066 726f 6d20 7468 6520 636f  v')" from the co
+00001730: 6465 0d0a 2020 2020 2020 2020 636f 6465  de..        code
+00001740: 203d 2072 652e 7375 6228 7222 6466 5c73   = re.sub(r"df\s
+00001750: 2a3d 5c73 2a70 645c 2e72 6561 645f 6373  *=\s*pd\.read_cs
+00001760: 765c 2827 2e2a 3f27 282c 2e2a 293f 5c29  v\('.*?'(,.*)?\)
+00001770: 222c 2022 222c 2063 6f64 6529 0d0a 0d0a  ", "", code)....
+00001780: 2020 2020 2020 2020 2320 4465 6669 6e65          # Define
+00001790: 2074 6865 2072 6567 756c 6172 2065 7870   the regular exp
+000017a0: 7265 7373 696f 6e20 7061 7474 6572 6e20  ression pattern 
+000017b0: 746f 206d 6174 6368 2074 6865 2062 6c61  to match the bla
+000017c0: 636b 6c69 7374 2069 7465 6d73 0d0a 2020  cklist items..  
+000017d0: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+000017e0: 7222 5e28 2e2a 5c62 2822 202b 2022 7c22  r"^(.*\b(" + "|"
+000017f0: 2e6a 6f69 6e28 626c 6163 6b6c 6973 7429  .join(blacklist)
+00001800: 202b 2072 2229 5c62 2e2a 2924 220d 0a0d   + r")\b.*)$"...
+00001810: 0a20 2020 2020 2020 2023 2052 6570 6c61  .        # Repla
+00001820: 6365 2074 6865 2062 6c61 636b 6c69 7374  ce the blacklist
+00001830: 2069 7465 6d73 2077 6974 6820 636f 6d6d   items with comm
+00001840: 656e 7473 0d0a 2020 2020 2020 2020 636f  ents..        co
+00001850: 6465 203d 2072 652e 7375 6228 7061 7474  de = re.sub(patt
+00001860: 6572 6e2c 2072 2223 206e 6f74 2061 6c6c  ern, r"# not all
+00001870: 6f77 6564 205c 3122 2c20 636f 6465 2c20  owed \1", code, 
+00001880: 666c 6167 733d 7265 2e4d 554c 5449 4c49  flags=re.MULTILI
+00001890: 4e45 290d 0a0d 0a20 2020 2020 2020 2023  NE)....        #
+000018a0: 2052 6574 7572 6e20 7468 6520 636c 6561   Return the clea
+000018b0: 6e65 6420 616e 6420 6578 7472 6163 7465  ned and extracte
+000018c0: 6420 636f 6465 0d0a 2020 2020 2020 2020  d code..        
+000018d0: 7265 7475 726e 2063 6f64 652e 7374 7269  return code.stri
+000018e0: 7028 292c 2072 6566 6c65 6374 696f 6e2e  p(), reflection.
+000018f0: 7374 7269 7028 292c 2066 6c6f 772e 7374  strip(), flow.st
+00001900: 7269 7028 290d 0a20 2020 200d 0a20 2020  rip()..    ..   
+00001910: 2064 6566 205f 6578 7472 6163 745f 7261   def _extract_ra
+00001920: 6e6b 2873 656c 662c 7265 7370 6f6e 7365  nk(self,response
+00001930: 3a20 7374 7229 202d 3e20 7374 723a 0d0a  : str) -> str:..
+00001940: 0d0a 2020 2020 2020 2020 2320 5365 6172  ..        # Sear
+00001950: 6368 2066 6f72 2061 2070 6174 7465 726e  ch for a pattern
+00001960: 2062 6574 7765 656e 203c 7261 6e6b 3e20   between <rank> 
+00001970: 616e 6420 3c2f 7261 6e6b 3e20 696e 2074  and </rank> in t
+00001980: 6865 2072 6573 706f 6e73 650d 0a20 2020  he response..   
+00001990: 2020 2020 206d 6174 6368 203d 2072 652e       match = re.
+000019a0: 7365 6172 6368 2872 223c 7261 6e6b 3e28  search(r"<rank>(
+000019b0: 2e2a 293c 2f72 616e 6b3e 222c 2072 6573  .*)</rank>", res
+000019c0: 706f 6e73 6529 0d0a 2020 2020 2020 2020  ponse)..        
+000019d0: 6966 206d 6174 6368 3a0d 0a20 2020 2020  if match:..     
+000019e0: 2020 2020 2020 2023 2049 6620 6120 6d61         # If a ma
+000019f0: 7463 6820 6973 2066 6f75 6e64 2c20 6578  tch is found, ex
+00001a00: 7472 6163 7420 7468 6520 7265 666c 6563  tract the reflec
+00001a10: 7469 6f6e 2062 6574 7765 656e 203c 7261  tion between <ra
+00001a20: 6e6b 3e20 616e 6420 3c2f 7261 6e6b 3e0d  nk> and </rank>.
+00001a30: 0a20 2020 2020 2020 2020 2020 2072 616e  .            ran
+00001a40: 6b20 3d20 6d61 7463 682e 6772 6f75 7028  k = match.group(
+00001a50: 3129 0d0a 2020 2020 2020 2020 656c 7365  1)..        else
+00001a60: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00001a70: 616e 6b20 3d20 2222 0d0a 0d0a 2020 2020  ank = ""....    
+00001a80: 2020 2020 2320 5265 7475 726e 2074 6865      # Return the
+00001a90: 2063 6c65 616e 6564 2061 6e64 2065 7874   cleaned and ext
+00001aa0: 7261 6374 6564 2063 6f64 650d 0a20 2020  racted code..   
+00001ab0: 2020 2020 2072 6574 7572 6e20 7261 6e6b       return rank
+00001ac0: 2e73 7472 6970 2829 0d0a 2020 2020 0d0a  .strip()..    ..
+00001ad0: 2020 2020 6465 6620 7461 736b 5f65 7661      def task_eva
+00001ae0: 6c28 7365 6c66 2c20 7175 6573 7469 6f6e  l(self, question
+00001af0: 3d4e 6f6e 6529 3a0d 0a20 2020 2020 2020  =None):..       
+00001b00: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
+00001b10: 6520 6d65 7373 6167 6573 206c 6973 7420  e messages list 
+00001b20: 7769 7468 2061 2073 7973 7465 6d20 6d65  with a system me
+00001b30: 7373 6167 6520 636f 6e74 6169 6e69 6e67  ssage containing
+00001b40: 2074 6865 2074 6173 6b20 7072 6f6d 7074   the task prompt
+00001b50: 0d0a 2020 2020 2020 2020 6576 616c 5f6d  ..        eval_m
+00001b60: 6573 7361 6765 7320 3d20 5b7b 2272 6f6c  essages = [{"rol
+00001b70: 6522 3a20 2273 7973 7465 6d22 2c20 2263  e": "system", "c
+00001b80: 6f6e 7465 6e74 223a 2073 656c 662e 7461  ontent": self.ta
+00001b90: 736b 5f65 7661 6c75 6174 696f 6e2e 666f  sk_evaluation.fo
+00001ba0: 726d 6174 2871 7565 7374 696f 6e2c 2073  rmat(question, s
+00001bb0: 656c 662e 6466 5f68 6561 642c 297d 5d0d  elf.df_head,)}].
+00001bc0: 0a0d 0a20 2020 2020 2020 2069 6620 2769  ...        if 'i
+00001bd0: 7079 6b65 726e 656c 2720 696e 2073 7973  pykernel' in sys
+00001be0: 2e6d 6f64 756c 6573 3a0d 0a20 2020 2020  .modules:..     
+00001bf0: 2020 2020 2020 2023 204a 7570 7974 6572         # Jupyter
+00001c00: 206e 6f74 6562 6f6f 6b20 6f72 2069 7079   notebook or ipy
+00001c10: 7468 6f6e 0d0a 2020 2020 2020 2020 2020  thon..          
+00001c20: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+00001c30: 273c 7020 7374 796c 653d 2263 6f6c 6f72  '<p style="color
+00001c40: 3a6d 6167 656e 7461 3b22 3e5c 6e43 616c  :magenta;">\nCal
+00001c50: 6c69 6e67 204d 6f64 656c 3a20 7b73 656c  ling Model: {sel
+00001c60: 662e 6c6c 6d7d 3c2f 703e 2729 290d 0a20  f.llm}</p>')).. 
+00001c70: 2020 2020 2020 2020 2020 2064 6973 706c             displ
+00001c80: 6179 2848 544d 4c28 6627 3c70 3e3c 6220  ay(HTML(f'<p><b 
+00001c90: 7374 796c 653d 2263 6f6c 6f72 3a6d 6167  style="color:mag
+00001ca0: 656e 7461 3b22 3e54 7279 696e 6720 746f  enta;">Trying to
+00001cb0: 2064 6574 6572 6d69 6e65 2074 6865 2062   determine the b
+00001cc0: 6573 7420 6d65 7468 6f64 2074 6f20 616e  est method to an
+00001cd0: 616c 7973 6520 796f 7572 2064 6174 612c  alyse your data,
+00001ce0: 2070 6c65 6173 6520 7761 6974 2e2e 2e3c   please wait...<
+00001cf0: 2f62 3e3c 2f70 3e3c 6272 3e27 2929 0d0a  /b></p><br>'))..
+00001d00: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00001d10: 2020 2020 2020 2020 2020 2023 204f 7468             # Oth
+00001d20: 6572 2065 6e76 6972 6f6e 6d65 6e74 2028  er environment (
+00001d30: 6c69 6b65 2074 6572 6d69 6e61 6c29 0d0a  like terminal)..
+00001d40: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00001d50: 7428 636f 6c6f 7265 6428 6622 5c6e 3e20  t(colored(f"\n> 
+00001d60: 4361 6c6c 696e 6720 4d6f 6465 6c3a 207b  Calling Model: {
+00001d70: 7365 6c66 2e6c 6c6d 7d22 2c20 226d 6167  self.llm}", "mag
+00001d80: 656e 7461 2229 290d 0a20 2020 2020 2020  enta"))..       
+00001d90: 2020 2020 2063 7072 696e 7428 6622 5c6e       cprint(f"\n
+00001da0: 3e20 5472 7969 6e67 2074 6f20 6465 7465  > Trying to dete
+00001db0: 726d 696e 6520 7468 6520 6265 7374 206d  rmine the best m
+00001dc0: 6574 686f 6420 746f 2061 6e61 6c79 7365  ethod to analyse
+00001dd0: 2079 6f75 7220 6461 7461 2c20 706c 6561   your data, plea
+00001de0: 7365 2077 6169 742e 2e2e 5c6e 222c 2027  se wait...\n", '
+00001df0: 6d61 6765 6e74 6127 2c20 6174 7472 733d  magenta', attrs=
+00001e00: 5b27 626f 6c64 275d 290d 0a0d 0a20 2020  ['bold'])....   
+00001e10: 2020 2020 2023 2046 756e 6374 696f 6e20       # Function 
+00001e20: 746f 2064 6973 706c 6179 2072 6573 756c  to display resul
+00001e30: 7473 206e 6963 656c 790d 0a20 2020 2020  ts nicely..     
+00001e40: 2020 2064 6566 2064 6973 706c 6179 5f74     def display_t
+00001e50: 6173 6b28 7461 736b 293a 0d0a 2020 2020  ask(task):..    
+00001e60: 2020 2020 2020 2020 6966 2027 6970 796b          if 'ipyk
+00001e70: 6572 6e65 6c27 2069 6e20 7379 732e 6d6f  ernel' in sys.mo
+00001e80: 6475 6c65 733a 0d0a 2020 2020 2020 2020  dules:..        
+00001e90: 2020 2020 2020 2020 2320 4a75 7079 7465          # Jupyte
+00001ea0: 7220 6e6f 7465 626f 6f6b 206f 7220 6970  r notebook or ip
+00001eb0: 7974 686f 6e0d 0a20 2020 2020 2020 2020  ython..         
+00001ec0: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
+00001ed0: 544d 4c28 6627 3c70 3e3c 6220 7374 796c  TML(f'<p><b styl
+00001ee0: 653d 2263 6f6c 6f72 3a62 6c75 653b 223e  e="color:blue;">
+00001ef0: 4920 6861 7665 2063 7265 6174 6564 2074  I have created t
+00001f00: 6865 2066 6f6c 6c6f 7769 6e67 2074 6173  he following tas
+00001f10: 6b20 6c69 7374 2c20 616e 6420 7769 6c6c  k list, and will
+00001f20: 206e 6f77 2074 7279 2074 6f20 6578 7072   now try to expr
+00001f30: 6573 7320 6974 2069 6e20 636f 6465 3a3c  ess it in code:<
+00001f40: 2f62 3e3c 6272 3e3c 7072 6520 7374 796c  /b><br><pre styl
+00001f50: 653d 2263 6f6c 6f72 3a62 6c61 636b 3b22  e="color:black;"
+00001f60: 3e3c 623e 7b74 6173 6b7d 3c2f 623e 3c2f  ><b>{task}</b></
+00001f70: 7072 653e 3c2f 703e 3c62 723e 2729 290d  pre></p><br>')).
+00001f80: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00001f90: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00001fa0: 2020 2020 2320 4f74 6865 7220 656e 7669      # Other envi
+00001fb0: 726f 6e6d 656e 7420 286c 696b 6520 7465  ronment (like te
+00001fc0: 726d 696e 616c 290d 0a20 2020 2020 2020  rminal)..       
+00001fd0: 2020 2020 2020 2020 2063 7072 696e 7428           cprint(
+00001fe0: 6622 5c6e 5461 736b 3a5c 6e7b 7461 736b  f"\nTask:\n{task
+00001ff0: 7d5c 6e22 2c20 276d 6167 656e 7461 272c  }\n", 'magenta',
+00002000: 2061 7474 7273 3d5b 2762 6f6c 6427 5d29   attrs=['bold'])
+00002010: 0d0a 0d0a 2020 2020 2020 2020 2320 4361  ....        # Ca
+00002020: 6c6c 2074 6865 204f 7065 6e41 4920 4150  ll the OpenAI AP
+00002030: 4920 616e 6420 6861 6e64 6c65 2072 6174  I and handle rat
+00002040: 6520 6c69 6d69 7420 6572 726f 7273 0d0a  e limit errors..
+00002050: 2020 2020 2020 2020 7472 793a 0d0a 2020          try:..  
+00002060: 2020 2020 2020 2020 2020 6c6c 6d5f 7265            llm_re
+00002070: 7370 6f6e 7365 2c20 746f 6b65 6e73 5f75  sponse, tokens_u
+00002080: 7365 6420 3d20 7365 6c66 2e6c 6c6d 5f63  sed = self.llm_c
+00002090: 616c 6c28 6576 616c 5f6d 6573 7361 6765  all(eval_message
+000020a0: 732c 7465 6d70 6572 6174 7572 653d 3029  s,temperature=0)
+000020b0: 2023 2068 6967 6865 7220 7465 6d70 6572   # higher temper
+000020c0: 6174 7572 6520 7265 7375 6c74 7320 696e  ature results in
+000020d0: 206d 6f72 6520 2263 7265 6174 6976 6522   more "creative"
+000020e0: 2061 6e73 7765 7273 2028 736f 6d65 7469   answers (someti
+000020f0: 6d65 7320 746f 6f20 6372 6561 7469 7665  mes too creative
+00002100: 203a 2d29 290d 0a20 2020 2020 2020 2020   :-))..         
+00002110: 2020 200d 0a20 2020 2020 2020 2065 7863     ..        exc
+00002120: 6570 7420 6f70 656e 6169 2e65 7272 6f72  ept openai.error
+00002130: 2e52 6174 654c 696d 6974 4572 726f 723a  .RateLimitError:
+00002140: 0d0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
+00002150: 696e 7428 0d0a 2020 2020 2020 2020 2020  int(..          
+00002160: 2020 2020 2020 2254 6865 204f 7065 6e41        "The OpenA
+00002170: 4920 4150 4920 7261 7465 206c 696d 6974  I API rate limit
+00002180: 2068 6173 2062 6565 6e20 6578 6365 6564   has been exceed
+00002190: 6564 2e20 5761 6974 696e 6720 3130 2073  ed. Waiting 10 s
+000021a0: 6563 6f6e 6473 2061 6e64 2074 7279 696e  econds and tryin
+000021b0: 6720 6167 6169 6e2e 220d 0a20 2020 2020  g again."..     
+000021c0: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+000021d0: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
+000021e0: 2831 3029 0d0a 2020 2020 2020 2020 2020  (10)..          
+000021f0: 2020 6c6c 6d5f 7265 7370 6f6e 7365 2c20    llm_response, 
+00002200: 746f 6b65 6e73 5f75 7365 6420 3d20 7365  tokens_used = se
+00002210: 6c66 2e6c 6c6d 5f63 616c 6c28 6576 616c  lf.llm_call(eval
+00002220: 5f6d 6573 7361 6765 7329 0d0a 0d0a 2020  _messages)....  
+00002230: 2020 2020 2020 7461 736b 203d 206c 6c6d        task = llm
+00002240: 5f72 6573 706f 6e73 650d 0a20 2020 2020  _response..     
+00002250: 2020 200d 0a20 2020 2020 2020 2064 6973     ..        dis
+00002260: 706c 6179 5f74 6173 6b28 7461 736b 290d  play_task(task).
+00002270: 0a0d 0a20 2020 2020 2020 2073 656c 662e  ...        self.
+00002280: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
+00002290: 642e 6170 7065 6e64 2874 6f6b 656e 735f  d.append(tokens_
+000022a0: 7573 6564 290d 0a0d 0a20 2020 2020 2020  used)....       
+000022b0: 2072 6574 7572 6e20 7461 736b 0d0a 0d0a   return task....
+000022c0: 2020 2020 6465 6620 6465 6275 675f 636f      def debug_co
+000022d0: 6465 2873 656c 662c 636f 6465 2c71 7565  de(self,code,que
+000022e0: 7374 696f 6e29 3a0d 0a20 2020 2020 2020  stion):..       
+000022f0: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
+00002300: 6520 6d65 7373 6167 6573 206c 6973 7420  e messages list 
+00002310: 7769 7468 2061 2073 7973 7465 6d20 6d65  with a system me
+00002320: 7373 6167 6520 636f 6e74 6169 6e69 6e67  ssage containing
+00002330: 2074 6865 2074 6173 6b20 7072 6f6d 7074   the task prompt
+00002340: 0d0a 2020 2020 2020 2020 6465 6275 675f  ..        debug_
+00002350: 6d65 7373 6167 6573 203d 205b 7b22 726f  messages = [{"ro
+00002360: 6c65 223a 2022 7379 7374 656d 222c 2022  le": "system", "
+00002370: 636f 6e74 656e 7422 3a20 7365 6c66 2e64  content": self.d
+00002380: 6562 7567 5f63 6f64 655f 7461 736b 2e66  ebug_code_task.f
+00002390: 6f72 6d61 7428 636f 6465 2c71 7565 7374  ormat(code,quest
+000023a0: 696f 6e29 7d5d 0d0a 0d0a 2020 2020 2020  ion)}]....      
+000023b0: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
+000023c0: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
+000023d0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000023e0: 4a75 7079 7465 7220 6e6f 7465 626f 6f6b  Jupyter notebook
+000023f0: 206f 7220 6970 7974 686f 6e0d 0a20 2020   or ipython..   
+00002400: 2020 2020 2020 2020 2064 6973 706c 6179           display
+00002410: 2848 544d 4c28 6627 3c70 2073 7479 6c65  (HTML(f'<p style
+00002420: 3d22 636f 6c6f 723a 6d61 6765 6e74 613b  ="color:magenta;
+00002430: 223e 5c6e 4361 6c6c 696e 6720 4d6f 6465  ">\nCalling Mode
+00002440: 6c3a 207b 7365 6c66 2e6c 6c6d 7d3c 2f70  l: {self.llm}</p
+00002450: 3e27 2929 0d0a 2020 2020 2020 2020 2020  >'))..          
+00002460: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+00002470: 273c 703e 3c62 2073 7479 6c65 3d22 636f  '<p><b style="co
+00002480: 6c6f 723a 6d61 6765 6e74 613b 223e 4920  lor:magenta;">I 
+00002490: 6861 7665 2072 6563 6569 7665 6420 7468  have received th
+000024a0: 6520 6669 7273 7420 7665 7273 696f 6e20  e first version 
+000024b0: 6f66 2074 6865 2063 6f64 652e 2049 2061  of the code. I a
+000024c0: 6d20 7365 6e64 696e 6720 6974 2062 6163  m sending it bac
+000024d0: 6b20 746f 204c 4c4d 2074 6f20 6765 7420  k to LLM to get 
+000024e0: 6974 2063 6865 636b 6564 2066 6f72 2061  it checked for a
+000024f0: 6e79 2065 7272 6f72 732c 2062 7567 7320  ny errors, bugs 
+00002500: 6f72 2069 6e63 6f6e 7369 7374 656e 6369  or inconsistenci
+00002510: 6573 2c20 616e 6420 636f 7272 6563 7469  es, and correcti
+00002520: 6f6e 2069 6620 6e65 6365 7373 6172 792e  on if necessary.
+00002530: 2050 6c65 6173 6520 7761 6974 2e2e 2e3c   Please wait...<
+00002540: 2f62 3e3c 2f70 3e3c 6272 3e27 2929 0d0a  /b></p><br>'))..
+00002550: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00002560: 2020 2020 2020 2020 2020 2023 204f 7468             # Oth
+00002570: 6572 2065 6e76 6972 6f6e 6d65 6e74 2028  er environment (
+00002580: 6c69 6b65 2074 6572 6d69 6e61 6c29 0d0a  like terminal)..
+00002590: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000025a0: 7428 636f 6c6f 7265 6428 6622 5c6e 3e20  t(colored(f"\n> 
+000025b0: 4361 6c6c 696e 6720 4d6f 6465 6c3a 207b  Calling Model: {
+000025c0: 7365 6c66 2e6c 6c6d 7d22 2c20 226d 6167  self.llm}", "mag
+000025d0: 656e 7461 2229 290d 0a20 2020 2020 2020  enta"))..       
+000025e0: 2020 2020 2063 7072 696e 7428 6622 5c6e       cprint(f"\n
+000025f0: 3e20 4920 6861 7665 2072 6563 6569 7665  > I have receive
+00002600: 6420 7468 6520 6669 7273 7420 7665 7273  d the first vers
+00002610: 696f 6e20 6f66 2074 6865 2063 6f64 652e  ion of the code.
+00002620: 2049 2061 6d20 7365 6e64 696e 6720 6974   I am sending it
+00002630: 2062 6163 6b20 746f 204c 4c4d 2074 6f20   back to LLM to 
+00002640: 6765 7420 6974 2063 6865 636b 6564 2066  get it checked f
+00002650: 6f72 2061 6e79 2065 7272 6f72 732c 2062  or any errors, b
+00002660: 7567 7320 6f72 2069 6e63 6f6e 7369 7374  ugs or inconsist
+00002670: 656e 6369 6573 2c20 616e 6420 636f 7272  encies, and corr
+00002680: 6563 7469 6f6e 2069 6620 6e65 6365 7373  ection if necess
+00002690: 6172 792e 2050 6c65 6173 6520 7761 6974  ary. Please wait
+000026a0: 2e2e 2e5c 6e22 2c20 276d 6167 656e 7461  ...\n", 'magenta
+000026b0: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
+000026c0: 5d29 0d0a 0d0a 2020 2020 2020 2020 2320  ])....        # 
+000026d0: 4675 6e63 7469 6f6e 2074 6f20 6469 7370  Function to disp
+000026e0: 6c61 7920 7265 7375 6c74 7320 6e69 6365  lay results nice
+000026f0: 6c79 0d0a 2020 2020 2020 2020 6465 6620  ly..        def 
+00002700: 6469 7370 6c61 795f 7461 736b 2864 6562  display_task(deb
+00002710: 7567 5f69 6e73 6967 6874 293a 0d0a 2020  ug_insight):..  
+00002720: 2020 2020 2020 2020 2020 6966 2027 6970            if 'ip
+00002730: 796b 6572 6e65 6c27 2069 6e20 7379 732e  ykernel' in sys.
+00002740: 6d6f 6475 6c65 733a 0d0a 2020 2020 2020  modules:..      
+00002750: 2020 2020 2020 2020 2020 2320 4a75 7079            # Jupy
+00002760: 7465 7220 6e6f 7465 626f 6f6b 206f 7220  ter notebook or 
+00002770: 6970 7974 686f 6e0d 0a20 2020 2020 2020  ipython..       
+00002780: 2020 2020 2020 2020 2064 6973 706c 6179           display
+00002790: 2848 544d 4c28 6627 3c70 3e3c 6220 7374  (HTML(f'<p><b st
+000027a0: 796c 653d 2263 6f6c 6f72 3a62 6c75 653b  yle="color:blue;
+000027b0: 223e 4920 6861 7665 2066 696e 6973 6865  ">I have finishe
+000027c0: 6420 6465 6275 6767 696e 6720 7468 6520  d debugging the 
+000027d0: 636f 6465 2c20 6265 6c6f 7720 6172 6520  code, below are 
+000027e0: 6d79 2074 686f 7567 6874 733a 3c2f 623e  my thoughts:</b>
+000027f0: 3c62 723e 3c70 7265 2073 7479 6c65 3d22  <br><pre style="
+00002800: 636f 6c6f 723a 626c 6163 6b3b 2077 6869  color:black; whi
+00002810: 7465 2d73 7061 6365 3a20 7072 652d 7772  te-space: pre-wr
+00002820: 6170 3b20 666f 6e74 2d77 6569 6768 743a  ap; font-weight:
+00002830: 2062 6f6c 643b 223e 7b64 6562 7567 5f69   bold;">{debug_i
+00002840: 6e73 6967 6874 7d3c 2f70 7265 3e3c 2f70  nsight}</pre></p
+00002850: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+00002860: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
+00002870: 7928 4854 4d4c 2866 273c 703e 3c62 2073  y(HTML(f'<p><b s
+00002880: 7479 6c65 3d22 636f 6c6f 723a 6d61 6765  tyle="color:mage
+00002890: 6e74 613b 223e 4920 616d 2070 726f 6365  nta;">I am proce
+000028a0: 6564 696e 6720 746f 2074 6865 2065 7865  eding to the exe
+000028b0: 6375 7469 6f6e 2e2e 2e3c 2f62 3e3c 2f70  cution...</b></p
+000028c0: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+000028d0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+000028e0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
+000028f0: 7468 6572 2065 6e76 6972 6f6e 6d65 6e74  ther environment
+00002900: 2028 6c69 6b65 2074 6572 6d69 6e61 6c29   (like terminal)
+00002910: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002920: 2020 6370 7269 6e74 2866 225c 6e3e 2049    cprint(f"\n> I
+00002930: 2068 6176 6520 6669 6e69 7368 6564 2064   have finished d
+00002940: 6562 7567 6769 6e67 2074 6865 2063 6f64  ebugging the cod
+00002950: 652c 2062 656c 6f77 2061 7265 206d 7920  e, below are my 
+00002960: 7468 6f75 6768 7473 3a5c 6e7b 6465 6275  thoughts:\n{debu
+00002970: 675f 696e 7369 6768 747d 5c6e 222c 2027  g_insight}\n", '
+00002980: 6d61 6765 6e74 6127 2c20 6174 7472 733d  magenta', attrs=
+00002990: 5b27 626f 6c64 275d 290d 0a20 2020 2020  ['bold'])..     
+000029a0: 2020 2020 2020 2020 2020 2063 7072 696e             cprin
+000029b0: 7428 6622 5c6e 3e20 4920 616d 2070 726f  t(f"\n> I am pro
+000029c0: 6365 6564 696e 6720 746f 2074 6865 2065  ceeding to the e
+000029d0: 7865 6375 7469 6f6e 2e2e 2e5c 6e22 2c20  xecution...\n", 
+000029e0: 276d 6167 656e 7461 272c 2061 7474 7273  'magenta', attrs
+000029f0: 3d5b 2762 6f6c 6427 5d29 0d0a 0d0a 2020  =['bold'])....  
+00002a00: 2020 2020 2020 2320 4361 6c6c 2074 6865        # Call the
+00002a10: 204f 7065 6e41 4920 4150 4920 616e 6420   OpenAI API and 
+00002a20: 6861 6e64 6c65 2072 6174 6520 6c69 6d69  handle rate limi
+00002a30: 7420 6572 726f 7273 0d0a 2020 2020 2020  t errors..      
+00002a40: 2020 7472 793a 0d0a 2020 2020 2020 2020    try:..        
+00002a50: 2020 2020 6c6c 6d5f 7265 7370 6f6e 7365      llm_response
+00002a60: 2c20 746f 6b65 6e73 5f75 7365 6420 3d20  , tokens_used = 
+00002a70: 7365 6c66 2e6c 6c6d 5f63 616c 6c28 6465  self.llm_call(de
+00002a80: 6275 675f 6d65 7373 6167 6573 2c74 656d  bug_messages,tem
+00002a90: 7065 7261 7475 7265 3d30 2920 2320 6869  perature=0) # hi
+00002aa0: 6768 6572 2074 656d 7065 7261 7475 7265  gher temperature
+00002ab0: 2072 6573 756c 7473 2069 6e20 6d6f 7265   results in more
+00002ac0: 2022 6372 6561 7469 7665 2220 616e 7377   "creative" answ
+00002ad0: 6572 7320 2873 6f6d 6574 696d 6573 2074  ers (sometimes t
+00002ae0: 6f6f 2063 7265 6174 6976 6520 3a2d 2929  oo creative :-))
+00002af0: 0d0a 2020 2020 2020 2020 2020 2020 0d0a  ..            ..
+00002b00: 2020 2020 2020 2020 6578 6365 7074 206f          except o
+00002b10: 7065 6e61 692e 6572 726f 722e 5261 7465  penai.error.Rate
+00002b20: 4c69 6d69 7445 7272 6f72 3a0d 0a20 2020  LimitError:..   
+00002b30: 2020 2020 2020 2020 2070 7269 6e74 280d           print(.
+00002b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002b50: 2022 5468 6520 4f70 656e 4149 2041 5049   "The OpenAI API
+00002b60: 2072 6174 6520 6c69 6d69 7420 6861 7320   rate limit has 
+00002b70: 6265 656e 2065 7863 6565 6465 642e 2057  been exceeded. W
+00002b80: 6169 7469 6e67 2031 3020 7365 636f 6e64  aiting 10 second
+00002b90: 7320 616e 6420 7472 7969 6e67 2061 6761  s and trying aga
+00002ba0: 696e 2e22 0d0a 2020 2020 2020 2020 2020  in."..          
+00002bb0: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
+00002bc0: 2074 696d 652e 736c 6565 7028 3130 290d   time.sleep(10).
+00002bd0: 0a20 2020 2020 2020 2020 2020 206c 6c6d  .            llm
+00002be0: 5f72 6573 706f 6e73 652c 2074 6f6b 656e  _response, token
+00002bf0: 735f 7573 6564 203d 2073 656c 662e 6c6c  s_used = self.ll
+00002c00: 6d5f 6361 6c6c 2864 6562 7567 5f6d 6573  m_call(debug_mes
+00002c10: 7361 6765 7329 0d0a 2020 2020 2020 2020  sages)..        
+00002c20: 0d0a 2020 2020 2020 2020 2320 4578 7472  ..        # Extr
+00002c30: 6163 7420 7468 6520 636f 6465 2066 726f  act the code fro
+00002c40: 6d20 7468 6520 4150 4920 7265 7370 6f6e  m the API respon
+00002c50: 7365 0d0a 2020 2020 2020 2020 6465 6275  se..        debu
+00002c60: 6767 6564 5f63 6f64 652c 6465 6275 675f  gged_code,debug_
+00002c70: 696e 7369 6768 742c 666c 6f77 203d 2073  insight,flow = s
+00002c80: 656c 662e 5f65 7874 7261 6374 5f63 6f64  elf._extract_cod
+00002c90: 6528 6c6c 6d5f 7265 7370 6f6e 7365 2920  e(llm_response) 
+00002ca0: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
+00002cb0: 6469 7370 6c61 795f 7461 736b 2864 6562  display_task(deb
+00002cc0: 7567 5f69 6e73 6967 6874 290d 0a0d 0a20  ug_insight).... 
+00002cd0: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
+00002ce0: 6c5f 746f 6b65 6e73 5f75 7365 642e 6170  l_tokens_used.ap
+00002cf0: 7065 6e64 2874 6f6b 656e 735f 7573 6564  pend(tokens_used
+00002d00: 290d 0a0d 0a20 2020 2020 2020 2072 6574  )....        ret
+00002d10: 7572 6e20 6465 6275 6767 6564 5f63 6f64  urn debugged_cod
+00002d20: 650d 0a0d 0a20 2020 2064 6566 2072 616e  e....    def ran
+00002d30: 6b5f 636f 6465 2873 656c 662c 636f 6465  k_code(self,code
+00002d40: 2c71 7565 7374 696f 6e29 3a0d 0a20 2020  ,question):..   
+00002d50: 2020 2020 2023 2049 6e69 7469 616c 697a       # Initializ
+00002d60: 6520 7468 6520 6d65 7373 6167 6573 206c  e the messages l
+00002d70: 6973 7420 7769 7468 2061 2073 7973 7465  ist with a syste
+00002d80: 6d20 6d65 7373 6167 6520 636f 6e74 6169  m message contai
+00002d90: 6e69 6e67 2074 6865 2074 6173 6b20 7072  ning the task pr
+00002da0: 6f6d 7074 0d0a 2020 2020 2020 2020 7261  ompt..        ra
+00002db0: 6e6b 5f6d 6573 7361 6765 7320 3d20 5b7b  nk_messages = [{
+00002dc0: 2272 6f6c 6522 3a20 2273 7973 7465 6d22  "role": "system"
+00002dd0: 2c20 2263 6f6e 7465 6e74 223a 2073 656c  , "content": sel
+00002de0: 662e 7261 6e6b 5f61 6e73 7765 722e 666f  f.rank_answer.fo
+00002df0: 726d 6174 2863 6f64 652c 7175 6573 7469  rmat(code,questi
+00002e00: 6f6e 297d 5d0d 0a0d 0a20 2020 2020 2020  on)}]....       
+00002e10: 2069 6620 2769 7079 6b65 726e 656c 2720   if 'ipykernel' 
+00002e20: 696e 2073 7973 2e6d 6f64 756c 6573 3a0d  in sys.modules:.
+00002e30: 0a20 2020 2020 2020 2020 2020 2023 204a  .            # J
+00002e40: 7570 7974 6572 206e 6f74 6562 6f6f 6b20  upyter notebook 
+00002e50: 6f72 2069 7079 7468 6f6e 0d0a 2020 2020  or ipython..    
+00002e60: 2020 2020 2020 2020 6469 7370 6c61 7928          display(
+00002e70: 4854 4d4c 2866 273c 7020 7374 796c 653d  HTML(f'<p style=
+00002e80: 2263 6f6c 6f72 3a6d 6167 656e 7461 3b22  "color:magenta;"
+00002e90: 3e5c 6e43 616c 6c69 6e67 204d 6f64 656c  >\nCalling Model
+00002ea0: 3a20 7b73 656c 662e 6c6c 6d7d 3c2f 703e  : {self.llm}</p>
+00002eb0: 2729 290d 0a20 2020 2020 2020 2020 2020  '))..           
+00002ec0: 2064 6973 706c 6179 2848 544d 4c28 6627   display(HTML(f'
+00002ed0: 3c70 3e3c 6220 7374 796c 653d 2263 6f6c  <p><b style="col
+00002ee0: 6f72 3a6d 6167 656e 7461 3b22 3e49 2061  or:magenta;">I a
+00002ef0: 6d20 676f 696e 6720 746f 2065 7661 6c75  m going to evalu
+00002f00: 6174 6520 616e 6420 7261 6e6b 2074 6865  ate and rank the
+00002f10: 2061 6e73 7765 722e 2050 6c65 6173 6520   answer. Please 
+00002f20: 7761 6974 2e2e 2e3c 2f62 3e3c 2f70 3e3c  wait...</b></p><
+00002f30: 6272 3e27 2929 0d0a 2020 2020 2020 2020  br>'))..        
+00002f40: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00002f50: 2020 2023 204f 7468 6572 2065 6e76 6972     # Other envir
+00002f60: 6f6e 6d65 6e74 2028 6c69 6b65 2074 6572  onment (like ter
+00002f70: 6d69 6e61 6c29 0d0a 2020 2020 2020 2020  minal)..        
+00002f80: 2020 2020 7072 696e 7428 636f 6c6f 7265      print(colore
+00002f90: 6428 6622 5c6e 3e20 4361 6c6c 696e 6720  d(f"\n> Calling 
+00002fa0: 4d6f 6465 6c3a 207b 7365 6c66 2e6c 6c6d  Model: {self.llm
+00002fb0: 7d22 2c20 226d 6167 656e 7461 2229 290d  }", "magenta")).
+00002fc0: 0a20 2020 2020 2020 2020 2020 2063 7072  .            cpr
+00002fd0: 696e 7428 6622 5c6e 3e20 4920 616d 2067  int(f"\n> I am g
+00002fe0: 6f69 6e67 2074 6f20 6576 616c 7561 7465  oing to evaluate
+00002ff0: 2061 6e64 2072 616e 6b20 7468 6520 616e   and rank the an
+00003000: 7377 6572 2e20 506c 6561 7365 2077 6169  swer. Please wai
+00003010: 742e 2e5c 6e22 2c20 276d 6167 656e 7461  t..\n", 'magenta
+00003020: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
+00003030: 5d29 0d0a 0d0a 2020 2020 2020 2020 2320  ])....        # 
+00003040: 4361 6c6c 2074 6865 204f 7065 6e41 4920  Call the OpenAI 
+00003050: 4150 4920 616e 6420 6861 6e64 6c65 2072  API and handle r
+00003060: 6174 6520 6c69 6d69 7420 6572 726f 7273  ate limit errors
+00003070: 0d0a 2020 2020 2020 2020 7472 793a 0d0a  ..        try:..
+00003080: 2020 2020 2020 2020 2020 2020 6c6c 6d5f              llm_
+00003090: 7265 7370 6f6e 7365 2c20 746f 6b65 6e73  response, tokens
+000030a0: 5f75 7365 6420 3d20 7365 6c66 2e6c 6c6d  _used = self.llm
+000030b0: 5f63 616c 6c28 7261 6e6b 5f6d 6573 7361  _call(rank_messa
+000030c0: 6765 7329 0d0a 2020 2020 2020 2020 2020  ges)..          
+000030d0: 2020 0d0a 2020 2020 2020 2020 6578 6365    ..        exce
+000030e0: 7074 206f 7065 6e61 692e 6572 726f 722e  pt openai.error.
+000030f0: 5261 7465 4c69 6d69 7445 7272 6f72 3a0d  RateLimitError:.
+00003100: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00003110: 6e74 280d 0a20 2020 2020 2020 2020 2020  nt(..           
+00003120: 2020 2020 2022 5468 6520 4f70 656e 4149       "The OpenAI
+00003130: 2041 5049 2072 6174 6520 6c69 6d69 7420   API rate limit 
+00003140: 6861 7320 6265 656e 2065 7863 6565 6465  has been exceede
+00003150: 642e 2057 6169 7469 6e67 2031 3020 7365  d. Waiting 10 se
+00003160: 636f 6e64 7320 616e 6420 7472 7969 6e67  conds and trying
+00003170: 2061 6761 696e 2e22 0d0a 2020 2020 2020   again."..      
+00003180: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+00003190: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+000031a0: 3130 290d 0a20 2020 2020 2020 2020 2020  10)..           
+000031b0: 206c 6c6d 5f72 6573 706f 6e73 652c 2074   llm_response, t
+000031c0: 6f6b 656e 735f 7573 6564 203d 2073 656c  okens_used = sel
+000031d0: 662e 6c6c 6d5f 6361 6c6c 2872 616e 6b5f  f.llm_call(rank_
+000031e0: 6d65 7373 6167 6573 290d 0a20 2020 2020  messages)..     
+000031f0: 2020 200d 0a20 2020 2020 2020 2023 2045     ..        # E
+00003200: 7874 7261 6374 2074 6865 2063 6f64 6520  xtract the code 
+00003210: 6672 6f6d 2074 6865 2041 5049 2072 6573  from the API res
+00003220: 706f 6e73 650d 0a20 2020 2020 2020 2072  ponse..        r
+00003230: 616e 6b20 3d20 7365 6c66 2e5f 6578 7472  ank = self._extr
+00003240: 6163 745f 7261 6e6b 286c 6c6d 5f72 6573  act_rank(llm_res
+00003250: 706f 6e73 6529 2020 2020 2020 200d 0a0d  ponse)       ...
+00003260: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00003270: 7461 6c5f 746f 6b65 6e73 5f75 7365 642e  tal_tokens_used.
+00003280: 6170 7065 6e64 2874 6f6b 656e 735f 7573  append(tokens_us
+00003290: 6564 290d 0a0d 0a20 2020 2020 2020 2072  ed)....        r
+000032a0: 6574 7572 6e20 7261 6e6b 0d0a 0d0a 2020  eturn rank....  
+000032b0: 2020 6465 6620 7064 5f61 6765 6e74 5f63    def pd_agent_c
+000032c0: 6f6e 7665 7273 6528 7365 6c66 2c20 7175  onverse(self, qu
+000032d0: 6573 7469 6f6e 3d4e 6f6e 6529 3a0d 0a20  estion=None):.. 
+000032e0: 2020 2020 2020 2023 2046 756e 6374 696f         # Functio
+000032f0: 6e20 746f 2064 6973 706c 6179 2072 6573  n to display res
+00003300: 756c 7473 206e 6963 656c 790d 0a20 2020  ults nicely..   
+00003310: 2020 2020 2064 6566 2064 6973 706c 6179       def display
+00003320: 5f72 6573 756c 7473 2861 6e73 7765 722c  _results(answer,
+00003330: 2063 6f64 652c 2072 6566 6c65 6374 696f   code, reflectio
+00003340: 6e2c 2066 6c6f 772c 2072 616e 6b2c 2074  n, flow, rank, t
+00003350: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
+00003360: 5f73 756d 293a 0d0a 2020 2020 2020 2020  _sum):..        
+00003370: 2020 2020 6966 2027 6970 796b 6572 6e65      if 'ipykerne
+00003380: 6c27 2069 6e20 7379 732e 6d6f 6475 6c65  l' in sys.module
+00003390: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+000033a0: 2020 2020 2320 4a75 7079 7465 7220 6e6f      # Jupyter no
+000033b0: 7465 626f 6f6b 206f 7220 6970 7974 686f  tebook or ipytho
+000033c0: 6e0d 0a20 2020 2020 2020 2020 2020 2020  n..             
+000033d0: 2020 2064 6973 706c 6179 2848 544d 4c28     display(HTML(
+000033e0: 6627 3c70 3e3c 6220 7374 796c 653d 2263  f'<p><b style="c
+000033f0: 6f6c 6f72 3a62 6c75 653b 223e 416e 7377  olor:blue;">Answ
+00003400: 6572 3a3c 2f62 3e3c 6272 3e3c 7072 6520  er:</b><br><pre 
+00003410: 7374 796c 653d 2263 6f6c 6f72 3a62 6c61  style="color:bla
+00003420: 636b 3b22 3e3c 623e 7b61 6e73 7765 727d  ck;"><b>{answer}
+00003430: 3c2f 623e 3c2f 7072 653e 3c2f 703e 3c62  </b></pre></p><b
+00003440: 723e 2729 290d 0a20 2020 2020 2020 2020  r>'))..         
+00003450: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
+00003460: 544d 4c28 6627 3c70 3e3c 6220 7374 796c  TML(f'<p><b styl
+00003470: 653d 2263 6f6c 6f72 3a62 6c75 653b 223e  e="color:blue;">
+00003480: 4865 7265 2069 7320 7468 6520 6669 6e61  Here is the fina
+00003490: 6c20 636f 6465 2074 6861 7420 6163 636f  l code that acco
+000034a0: 6d70 6c69 7368 6573 2074 6865 2074 6173  mplishes the tas
+000034b0: 6b3a 3c2f 623e 3c62 723e 3c70 7265 2073  k:</b><br><pre s
+000034c0: 7479 6c65 3d22 636f 6c6f 723a 2335 3535  tyle="color:#555
+000034d0: 3535 353b 223e 7b63 6f64 657d 3c2f 7072  555;">{code}</pr
+000034e0: 653e 3c2f 703e 3c62 723e 2729 290d 0a20  e></p><br>')).. 
+000034f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00003500: 6973 706c 6179 2848 544d 4c28 6627 3c70  isplay(HTML(f'<p
+00003510: 3e3c 6220 7374 796c 653d 2263 6f6c 6f72  ><b style="color
+00003520: 3a62 6c75 653b 223e 4669 6e61 6c20 5468  :blue;">Final Th
+00003530: 6f75 6768 7473 3a3c 2f62 3e3c 6272 3e3c  oughts:</b><br><
+00003540: 7072 6520 7374 796c 653d 2263 6f6c 6f72  pre style="color
+00003550: 3a62 6c61 636b 3b20 7768 6974 652d 7370  :black; white-sp
+00003560: 6163 653a 2070 7265 2d77 7261 703b 2066  ace: pre-wrap; f
+00003570: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+00003580: 3b22 3e7b 7265 666c 6563 7469 6f6e 7d3c  ;">{reflection}<
+00003590: 2f70 7265 3e3c 2f70 3e3c 6272 3e27 2929  /pre></p><br>'))
+000035a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000035b0: 2020 6966 2073 656c 662e 666c 6f77 5f64    if self.flow_d
+000035c0: 6961 6772 616d 3a0d 0a20 2020 2020 2020  iagram:..       
+000035d0: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+000035e0: 706c 6179 2848 544d 4c28 6627 3c70 3e3c  play(HTML(f'<p><
+000035f0: 6220 7374 796c 653d 2263 6f6c 6f72 3a62  b style="color:b
+00003600: 6c75 653b 223e 4265 6c6f 7720 6973 206d  lue;">Below is m
+00003610: 7920 6170 7072 6f63 6820 6173 2061 2046  y approch as a F
+00003620: 6c6f 7720 6368 6172 743a 3c2f 623e 3c62  low chart:</b><b
+00003630: 723e 3c69 6d67 2073 7263 3d22 7b73 656c  r><img src="{sel
+00003640: 662e 6d6d 2866 6c6f 7729 7d22 2061 6c74  f.mm(flow)}" alt
+00003650: 3d22 416e 616c 7973 6973 2046 6c6f 7722  ="Analysis Flow"
+00003660: 3e3c 2f69 6d67 3e3c 2f70 3e3c 6272 3e27  ></img></p><br>'
+00003670: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
+00003680: 2020 2020 6966 2073 656c 662e 7261 6e6b      if self.rank
+00003690: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000036a0: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
+000036b0: 544d 4c28 6627 3c70 3e3c 6220 7374 796c  TML(f'<p><b styl
+000036c0: 653d 2263 6f6c 6f72 3a62 6c75 653b 223e  e="color:blue;">
+000036d0: 5261 6e6b 3a3c 2f62 3e3c 6272 3e3c 7370  Rank:</b><br><sp
+000036e0: 616e 2073 7479 6c65 3d22 636f 6c6f 723a  an style="color:
+000036f0: 626c 6163 6b3b 223e 7b72 616e 6b7d 3c2f  black;">{rank}</
+00003700: 7370 616e 3e3c 2f70 3e3c 6272 3e27 2929  span></p><br>'))
+00003710: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003720: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+00003730: 273c 703e 3c62 2073 7479 6c65 3d22 636f  '<p><b style="co
+00003740: 6c6f 723a 626c 7565 3b22 3e54 6f74 616c  lor:blue;">Total
+00003750: 2054 6f6b 656e 7320 5573 6564 3a3c 2f62   Tokens Used:</b
+00003760: 3e3c 6272 3e3c 7370 616e 2073 7479 6c65  ><br><span style
+00003770: 3d22 636f 6c6f 723a 626c 6163 6b3b 223e  ="color:black;">
+00003780: 7b74 6f74 616c 5f74 6f6b 656e 735f 7573  {total_tokens_us
+00003790: 6564 5f73 756d 7d3c 2f73 7061 6e3e 3c2f  ed_sum}</span></
+000037a0: 703e 3c62 723e 2729 290d 0a20 2020 2020  p><br>'))..     
+000037b0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+000037c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000037d0: 4f74 6865 7220 656e 7669 726f 6e6d 656e  Other environmen
+000037e0: 7420 286c 696b 6520 7465 726d 696e 616c  t (like terminal
+000037f0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00003800: 2020 2063 7072 696e 7428 6622 5c6e 3e20     cprint(f"\n> 
+00003810: 416e 7377 6572 3a5c 6e7b 616e 7377 6572  Answer:\n{answer
+00003820: 7d5c 6e22 2c20 2767 7265 656e 272c 2061  }\n", 'green', a
+00003830: 7474 7273 3d5b 2762 6f6c 6427 5d29 0d0a  ttrs=['bold'])..
+00003840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003850: 6370 7269 6e74 2866 223e 2048 6572 6520  cprint(f"> Here 
+00003860: 6973 2074 6865 2066 696e 616c 2063 6f64  is the final cod
+00003870: 6520 7468 6174 2061 6363 6f6d 706c 6973  e that accomplis
+00003880: 6865 7320 7468 6520 7461 736b 3a5c 6e7b  hes the task:\n{
+00003890: 636f 6465 7d5c 6e22 2c20 2767 7265 656e  code}\n", 'green
+000038a0: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
+000038b0: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
+000038c0: 2020 2020 6370 7269 6e74 2866 223e 2046      cprint(f"> F
+000038d0: 696e 616c 2054 686f 7567 6874 733a 5c6e  inal Thoughts:\n
+000038e0: 7b72 6566 6c65 6374 696f 6e7d 5c6e 222c  {reflection}\n",
+000038f0: 2027 6772 6565 6e27 2c20 6174 7472 733d   'green', attrs=
+00003900: 5b27 626f 6c64 275d 290d 0a20 2020 2020  ['bold'])..     
+00003910: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00003920: 6c66 2e72 616e 6b3a 0d0a 2020 2020 2020  lf.rank:..      
+00003930: 2020 2020 2020 2020 2020 2020 2020 6370                cp
+00003940: 7269 6e74 2866 223e 2052 616e 6b3a 5c6e  rint(f"> Rank:\n
+00003950: 7b72 616e 6b7d 5c6e 222c 2027 6772 6565  {rank}\n", 'gree
+00003960: 6e27 2c20 6174 7472 733d 5b27 626f 6c64  n', attrs=['bold
+00003970: 275d 290d 0a20 2020 2020 2020 2020 2020  '])..           
+00003980: 2020 2020 2063 7072 696e 7428 6622 3e20       cprint(f"> 
+00003990: 546f 7461 6c20 746f 6b65 6e73 2075 7365  Total tokens use
+000039a0: 643a 5c6e 7b74 6f74 616c 5f74 6f6b 656e  d:\n{total_token
+000039b0: 735f 7573 6564 5f73 756d 7d5c 6e22 2c20  s_used_sum}\n", 
+000039c0: 2779 656c 6c6f 7727 2c20 6174 7472 733d  'yellow', attrs=
+000039d0: 5b27 626f 6c64 275d 290d 0a20 2020 2020  ['bold'])..     
+000039e0: 2020 200d 0a20 2020 2020 2020 2023 2049     ..        # I
+000039f0: 6620 6120 7175 6573 7469 6f6e 2069 7320  f a question is 
+00003a00: 7072 6f76 6964 6564 2c20 736b 6970 2074  provided, skip t
+00003a10: 6865 2069 6e70 7574 2070 726f 6d70 740d  he input prompt.
+00003a20: 0a20 2020 2020 2020 2069 6620 7175 6573  .        if ques
+00003a30: 7469 6f6e 2069 7320 6e6f 7420 4e6f 6e65  tion is not None
+00003a40: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
+00003a50: 2049 6e69 7469 616c 697a 6520 7468 6520   Initialize the 
+00003a60: 6d65 7373 6167 6573 206c 6973 7420 7769  messages list wi
+00003a70: 7468 2061 2073 7973 7465 6d20 6d65 7373  th a system mess
+00003a80: 6167 6520 636f 6e74 6169 6e69 6e67 2074  age containing t
+00003a90: 6865 2074 6173 6b20 7072 6f6d 7074 0d0a  he task prompt..
+00003aa0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+00003ab0: 6167 6573 203d 205b 7b22 726f 6c65 223a  ages = [{"role":
+00003ac0: 2022 7379 7374 656d 222c 2022 636f 6e74   "system", "cont
+00003ad0: 656e 7422 3a20 7365 6c66 2e73 7973 7465  ent": self.syste
+00003ae0: 6d5f 7461 736b 2e66 6f72 6d61 7428 7175  m_task.format(qu
+00003af0: 6573 7469 6f6e 297d 5d0d 0a20 2020 2020  estion)}]..     
+00003b00: 2020 2020 2020 2023 2043 616c 6c20 7468         # Call th
+00003b10: 6520 7461 736b 5f65 7661 6c20 6d65 7468  e task_eval meth
+00003b20: 6f64 2077 6974 6820 7468 6520 7573 6572  od with the user
+00003b30: 2773 2071 7565 7374 696f 6e20 6966 2074  's question if t
+00003b40: 6865 2065 7870 6c6f 7261 746f 7279 206d  he exploratory m
+00003b50: 6f64 6520 6973 2054 7275 650d 0a20 2020  ode is True..   
+00003b60: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00003b70: 2e65 7870 6c6f 7261 746f 7279 2069 7320  .exploratory is 
+00003b80: 5472 7565 3a0d 0a20 2020 2020 2020 2020  True:..         
+00003b90: 2020 2020 2020 2074 6173 6b20 3d20 7365         task = se
+00003ba0: 6c66 2e74 6173 6b5f 6576 616c 2871 7565  lf.task_eval(que
+00003bb0: 7374 696f 6e29 0d0a 2020 2020 2020 2020  stion)..        
+00003bc0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+00003bd0: 2020 2020 2020 2020 2020 2074 6173 6b20             task 
+00003be0: 3d20 7175 6573 7469 6f6e 0d0a 2020 2020  = question..    
+00003bf0: 2020 2020 2020 2020 2320 4361 6c6c 2074          # Call t
+00003c00: 6865 2070 645f 6167 656e 7420 6d65 7468  he pd_agent meth
+00003c10: 6f64 2077 6974 6820 7468 6520 7573 6572  od with the user
+00003c20: 2773 2071 7565 7374 696f 6e2c 2074 6865  's question, the
+00003c30: 206d 6573 7361 6765 7320 6c69 7374 2c20   messages list, 
+00003c40: 616e 6420 7468 6520 6461 7461 6672 616d  and the datafram
+00003c50: 650d 0a20 2020 2020 2020 2020 2020 2061  e..            a
+00003c60: 6e73 7765 722c 2063 6f64 652c 2072 6566  nswer, code, ref
+00003c70: 6c65 6374 696f 6e2c 2066 6c6f 772c 2074  lection, flow, t
+00003c80: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
+00003c90: 5f73 756d 203d 2073 656c 662e 7064 5f61  _sum = self.pd_a
+00003ca0: 6765 6e74 2874 6173 6b2c 206d 6573 7361  gent(task, messa
+00003cb0: 6765 732c 2073 656c 662e 6466 290d 0a0d  ges, self.df)...
+00003cc0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+00003cd0: 746f 7265 2074 6865 206f 7269 6769 6e61  tore the origina
+00003ce0: 6c20 6c6c 6d20 7661 6c75 650d 0a20 2020  l llm value..   
+00003cf0: 2020 2020 2020 2020 206f 7269 6769 6e61           origina
+00003d00: 6c5f 6c6c 6d20 3d20 7365 6c66 2e6c 6c6d  l_llm = self.llm
+00003d10: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00003d20: 2320 5261 6e6b 2074 6865 204c 4c4d 2072  # Rank the LLM r
+00003d30: 6573 706f 6e73 650d 0a20 2020 2020 2020  esponse..       
+00003d40: 2020 2020 2069 6620 7365 6c66 2e72 616e       if self.ran
+00003d50: 6b3a 0d0a 2020 2020 2020 2020 2020 2020  k:..            
+00003d60: 2020 2020 2320 5377 6974 6368 2074 6f20      # Switch to 
+00003d70: 6770 742d 3420 6966 206c 6c6d 5f73 7769  gpt-4 if llm_swi
+00003d80: 7463 6820 7061 7261 6d65 7465 7220 6973  tch parameter is
+00003d90: 2073 6574 2074 6f20 5472 7565 2e20 5468   set to True. Th
+00003da0: 6973 2077 696c 6c20 696e 6372 6561 7365  is will increase
+00003db0: 2074 6865 2070 726f 6365 7373 696e 6720   the processing 
+00003dc0: 7469 6d65 2061 6e64 2063 6f73 740d 0a20  time and cost.. 
+00003dd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00003de0: 6620 7365 6c66 2e6c 6c6d 5f73 7769 7463  f self.llm_switc
+00003df0: 683a 0d0a 2020 2020 2020 2020 2020 2020  h:..            
+00003e00: 2020 2020 2020 2020 7365 6c66 2e6c 6c6d          self.llm
+00003e10: 203d 2027 6770 742d 3427 0d0a 2020 2020   = 'gpt-4'..    
+00003e20: 2020 2020 2020 2020 2020 2020 7261 6e6b              rank
+00003e30: 203d 2073 656c 662e 7261 6e6b 5f63 6f64   = self.rank_cod
+00003e40: 6528 636f 6465 2c71 7565 7374 696f 6e29  e(code,question)
+00003e50: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00003e60: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00003e70: 2020 2020 2072 616e 6b20 3d20 2222 0d0a       rank = ""..
+00003e80: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00003e90: 5377 6974 6368 2062 6163 6b20 746f 2074  Switch back to t
+00003ea0: 6865 206f 7269 6769 6e61 6c20 6c6c 6d20  he original llm 
+00003eb0: 6265 666f 7265 2074 6865 2066 756e 6374  before the funct
+00003ec0: 696f 6e20 6669 6e69 7368 6573 0d0a 2020  ion finishes..  
+00003ed0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+00003ee0: 6c6d 203d 206f 7269 6769 6e61 6c5f 6c6c  lm = original_ll
+00003ef0: 6d0d 0a0d 0a20 2020 2020 2020 2020 2020  m....           
+00003f00: 2064 6973 706c 6179 5f72 6573 756c 7473   display_results
+00003f10: 2861 6e73 7765 722c 2063 6f64 652c 2072  (answer, code, r
+00003f20: 6566 6c65 6374 696f 6e2c 2066 6c6f 772c  eflection, flow,
+00003f30: 2072 616e 6b2c 2074 6f74 616c 5f74 6f6b   rank, total_tok
+00003f40: 656e 735f 7573 6564 5f73 756d 290d 0a20  ens_used_sum).. 
+00003f50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003f60: 6e0d 0a0d 0a20 2020 2020 2020 2023 2053  n....        # S
+00003f70: 7461 7274 2061 6e20 696e 6669 6e69 7465  tart an infinite
+00003f80: 206c 6f6f 7020 746f 206b 6565 7020 6173   loop to keep as
+00003f90: 6b69 6e67 2074 6865 2075 7365 7220 666f  king the user fo
+00003fa0: 7220 7175 6573 7469 6f6e 730d 0a20 2020  r questions..   
+00003fb0: 2020 2020 2066 6972 7374 5f69 7465 7261       first_itera
+00003fc0: 7469 6f6e 203d 2054 7275 6520 2023 2046  tion = True  # F
+00003fd0: 6c61 6720 666f 7220 7468 6520 6669 7273  lag for the firs
+00003fe0: 7420 6974 6572 6174 696f 6e20 6f66 2074  t iteration of t
+00003ff0: 6865 206c 6f6f 700d 0a20 2020 2020 2020  he loop..       
+00004000: 2077 6869 6c65 2054 7275 653a 0d0a 2020   while True:..  
+00004010: 2020 2020 2020 2020 2020 2320 5072 6f6d            # Prom
+00004020: 7074 2074 6865 2075 7365 7220 746f 2065  pt the user to e
+00004030: 6e74 6572 2061 2071 7565 7374 696f 6e20  nter a question 
+00004040: 6f72 2074 7970 6520 2765 7869 7427 2074  or type 'exit' t
+00004050: 6f20 7175 6974 0d0a 2020 2020 2020 2020  o quit..        
+00004060: 2020 2020 6966 2027 6970 796b 6572 6e65      if 'ipykerne
+00004070: 6c27 2069 6e20 7379 732e 6d6f 6475 6c65  l' in sys.module
+00004080: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00004090: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
+000040a0: 2827 3c62 2073 7479 6c65 3d22 636f 6c6f  ('<b style="colo
+000040b0: 723a 626c 7565 3b22 3e45 6e74 6572 2079  r:blue;">Enter y
+000040c0: 6f75 7220 7175 6573 7469 6f6e 206f 7220  our question or 
+000040d0: 7479 7065 205c 2765 7869 745c 2720 746f  type \'exit\' to
+000040e0: 2071 7569 743a 3c2f 623e 2729 290d 0a20   quit:</b>')).. 
+000040f0: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00004100: 7565 7374 696f 6e20 3d20 696e 7075 7428  uestion = input(
+00004110: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
+00004120: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00004130: 2020 2020 2020 6370 7269 6e74 2822 5c6e        cprint("\n
+00004140: 456e 7465 7220 796f 7572 2071 7565 7374  Enter your quest
+00004150: 696f 6e20 6f72 2074 7970 6520 2765 7869  ion or type 'exi
+00004160: 7427 2074 6f20 7175 6974 3a22 2c20 2762  t' to quit:", 'b
+00004170: 6c75 6527 2c20 6174 7472 733d 5b27 626f  lue', attrs=['bo
+00004180: 6c64 275d 290d 0a20 2020 2020 2020 2020  ld'])..         
+00004190: 2020 2020 2020 2071 7565 7374 696f 6e20         question 
+000041a0: 3d20 696e 7075 7428 290d 0a0d 0a20 2020  = input()....   
+000041b0: 2020 2020 2020 2020 2023 2052 656d 656d           # Remem
+000041c0: 6265 7274 2074 6865 206f 7269 6769 6e61  bert the origina
+000041d0: 6c20 7175 6573 7469 6f6e 2066 6f72 2072  l question for r
+000041e0: 616e 6b69 6e67 0d0a 2020 2020 2020 2020  anking..        
+000041f0: 2020 2020 6f72 6967 696e 616c 5f71 7565      original_que
+00004200: 7374 696f 6e20 3d20 7175 6573 7469 6f6e  stion = question
+00004210: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00004220: 2320 4966 2074 6865 2075 7365 7220 7479  # If the user ty
+00004230: 7065 7320 2765 7869 7427 2c20 6272 6561  pes 'exit', brea
+00004240: 6b20 6f75 7420 6f66 2074 6865 206c 6f6f  k out of the loo
+00004250: 700d 0a20 2020 2020 2020 2020 2020 2069  p..            i
+00004260: 6620 7175 6573 7469 6f6e 2e73 7472 6970  f question.strip
+00004270: 2829 2e6c 6f77 6572 2829 203d 3d20 2765  ().lower() == 'e
+00004280: 7869 7427 3a0d 0a20 2020 2020 2020 2020  xit':..         
+00004290: 2020 2020 2020 2062 7265 616b 0d0a 0d0a         break....
+000042a0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000042b0: 6972 7374 5f69 7465 7261 7469 6f6e 3a0d  irst_iteration:.
+000042c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000042d0: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
+000042e0: 6520 6d65 7373 6167 6573 206c 6973 7420  e messages list 
+000042f0: 7769 7468 2061 2073 7973 7465 6d20 6d65  with a system me
+00004300: 7373 6167 6520 636f 6e74 6169 6e69 6e67  ssage containing
+00004310: 2074 6865 2074 6173 6b20 7072 6f6d 7074   the task prompt
+00004320: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00004330: 2020 6d65 7373 6167 6573 203d 205b 7b22    messages = [{"
+00004340: 726f 6c65 223a 2022 7379 7374 656d 222c  role": "system",
+00004350: 2022 636f 6e74 656e 7422 3a20 7365 6c66   "content": self
+00004360: 2e73 7973 7465 6d5f 7461 736b 2e66 6f72  .system_task.for
+00004370: 6d61 7428 7175 6573 7469 6f6e 2c71 7565  mat(question,que
+00004380: 7374 696f 6e29 7d5d 0d0a 2020 2020 2020  stion)}]..      
+00004390: 2020 2020 2020 2020 2020 2320 4361 6c6c            # Call
+000043a0: 2074 6865 2074 6173 6b5f 6576 616c 206d   the task_eval m
+000043b0: 6574 686f 6420 7769 7468 2074 6865 2075  ethod with the u
+000043c0: 7365 7227 7320 7175 6573 7469 6f6e 2069  ser's question i
+000043d0: 6620 7468 6520 6578 706c 6f72 6174 6f72  f the explorator
+000043e0: 7920 6d6f 6465 2069 7320 5472 7565 0d0a  y mode is True..
+000043f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004400: 6966 2073 656c 662e 6578 706c 6f72 6174  if self.explorat
+00004410: 6f72 7920 6973 2054 7275 653a 0d0a 2020  ory is True:..  
+00004420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004430: 2020 7461 736b 203d 2073 656c 662e 7461    task = self.ta
+00004440: 736b 5f65 7661 6c28 7175 6573 7469 6f6e  sk_eval(question
+00004450: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00004460: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00004470: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00004480: 736b 203d 2071 7565 7374 696f 6e0d 0a20  sk = question.. 
+00004490: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000044a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000044b0: 2020 7461 736b 203d 2071 7565 7374 696f    task = questio
+000044c0: 6e0d 0a0d 0a20 2020 2020 2020 2020 2020  n....           
+000044d0: 2023 2043 616c 6c20 7468 6520 7064 5f61   # Call the pd_a
+000044e0: 6765 6e74 206d 6574 686f 6420 7769 7468  gent method with
+000044f0: 2074 6865 2075 7365 7227 7320 7175 6573   the user's ques
+00004500: 7469 6f6e 2c20 7468 6520 6d65 7373 6167  tion, the messag
+00004510: 6573 206c 6973 742c 2061 6e64 2074 6865  es list, and the
+00004520: 2064 6174 6166 7261 6d65 0d0a 2020 2020   dataframe..    
+00004530: 2020 2020 2020 2020 616e 7377 6572 2c20          answer, 
+00004540: 636f 6465 2c20 7265 666c 6563 7469 6f6e  code, reflection
+00004550: 2c20 666c 6f77 2c20 746f 7461 6c5f 746f  , flow, total_to
+00004560: 6b65 6e73 5f75 7365 645f 7375 6d20 3d20  kens_used_sum = 
+00004570: 7365 6c66 2e70 645f 6167 656e 7428 7461  self.pd_agent(ta
+00004580: 736b 2c20 6d65 7373 6167 6573 2c20 7365  sk, messages, se
+00004590: 6c66 2e64 6629 0d0a 0d0a 2020 2020 2020  lf.df)....      
+000045a0: 2020 2020 2020 2320 5374 6f72 6520 7468        # Store th
+000045b0: 6520 6f72 6967 696e 616c 206c 6c6d 2076  e original llm v
+000045c0: 616c 7565 0d0a 2020 2020 2020 2020 2020  alue..          
+000045d0: 2020 6f72 6967 696e 616c 5f6c 6c6d 203d    original_llm =
+000045e0: 2073 656c 662e 6c6c 6d0d 0a0d 0a20 2020   self.llm....   
+000045f0: 2020 2020 2020 2020 2023 2052 616e 6b20           # Rank 
+00004600: 7468 6520 4c4c 4d20 7265 7370 6f6e 7365  the LLM response
+00004610: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00004620: 2073 656c 662e 7261 6e6b 3a0d 0a20 2020   self.rank:..   
+00004630: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+00004640: 7769 7463 6820 746f 2067 7074 2d34 2069  witch to gpt-4 i
+00004650: 6620 6c6c 6d5f 7377 6974 6368 2070 6172  f llm_switch par
+00004660: 616d 6574 6572 2069 7320 7365 7420 746f  ameter is set to
+00004670: 2054 7275 652e 2054 6869 7320 7769 6c6c   True. This will
+00004680: 2069 6e63 7265 6173 6520 7468 6520 7072   increase the pr
+00004690: 6f63 6573 7369 6e67 2074 696d 6520 616e  ocessing time an
+000046a0: 6420 636f 7374 0d0a 2020 2020 2020 2020  d cost..        
+000046b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000046c0: 6c6c 6d5f 7377 6974 6368 3a0d 0a20 2020  llm_switch:..   
+000046d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046e0: 2073 656c 662e 6c6c 6d20 3d20 2767 7074   self.llm = 'gpt
+000046f0: 2d34 270d 0a20 2020 2020 2020 2020 2020  -4'..           
+00004700: 2020 2020 2072 616e 6b20 3d20 7365 6c66       rank = self
+00004710: 2e72 616e 6b5f 636f 6465 2863 6f64 652c  .rank_code(code,
+00004720: 6f72 6967 696e 616c 5f71 7565 7374 696f  original_questio
+00004730: 6e29 0d0a 2020 2020 2020 2020 2020 2020  n)..            
+00004740: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00004750: 2020 2020 2020 2072 616e 6b20 3d20 2222         rank = ""
+00004760: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00004770: 2320 5377 6974 6368 2062 6163 6b20 746f  # Switch back to
+00004780: 2074 6865 206f 7269 6769 6e61 6c20 6c6c   the original ll
+00004790: 6d20 6265 666f 7265 2074 6865 2066 756e  m before the fun
+000047a0: 6374 696f 6e20 6669 6e69 7368 6573 0d0a  ction finishes..
+000047b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000047c0: 2e6c 6c6d 203d 206f 7269 6769 6e61 6c5f  .llm = original_
+000047d0: 6c6c 6d0d 0a0d 0a20 2020 2020 2020 2020  llm....         
+000047e0: 2020 2064 6973 706c 6179 5f72 6573 756c     display_resul
+000047f0: 7473 2861 6e73 7765 722c 2063 6f64 652c  ts(answer, code,
+00004800: 2072 6566 6c65 6374 696f 6e2c 666c 6f77   reflection,flow
+00004810: 2c72 616e 6b2c 746f 7461 6c5f 746f 6b65  ,rank,total_toke
+00004820: 6e73 5f75 7365 645f 7375 6d29 0d0a 0d0a  ns_used_sum)....
+00004830: 2020 2020 2020 2020 2020 2020 2320 4166              # Af
+00004840: 7465 7220 7468 6520 6669 7273 7420 6974  ter the first it
+00004850: 6572 6174 696f 6e2c 2073 6574 2074 6865  eration, set the
+00004860: 2066 6c61 6720 746f 2046 616c 7365 0d0a   flag to False..
+00004870: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+00004880: 745f 6974 6572 6174 696f 6e20 3d20 4661  t_iteration = Fa
+00004890: 6c73 650d 0a0d 0a20 2020 2064 6566 2070  lse....    def p
+000048a0: 645f 6167 656e 7428 7365 6c66 2c20 7175  d_agent(self, qu
+000048b0: 6573 7469 6f6e 2c20 6d65 7373 6167 6573  estion, messages
+000048c0: 2c20 6466 3d4e 6f6e 6529 3a0d 0a20 2020  , df=None):..   
+000048d0: 2020 2020 2023 2041 6464 2061 2075 7365       # Add a use
+000048e0: 7220 6d65 7373 6167 6520 7769 7468 2074  r message with t
+000048f0: 6865 2075 7064 6174 6564 2074 6173 6b20  he updated task 
+00004900: 7072 6f6d 7074 2074 6f20 7468 6520 6d65  prompt to the me
+00004910: 7373 6167 6573 206c 6973 740d 0a20 2020  ssages list..   
+00004920: 2020 2020 206d 6573 7361 6765 732e 6170       messages.ap
+00004930: 7065 6e64 287b 2272 6f6c 6522 3a20 2275  pend({"role": "u
+00004940: 7365 7222 2c20 2263 6f6e 7465 6e74 223a  ser", "content":
+00004950: 2073 656c 662e 7461 736b 2e66 6f72 6d61   self.task.forma
+00004960: 7428 7365 6c66 2e64 665f 6865 6164 2c20  t(self.df_head, 
+00004970: 7175 6573 7469 6f6e 297d 290d 0a0d 0a20  question)}).... 
+00004980: 2020 2020 2020 2069 6620 2769 7079 6b65         if 'ipyke
+00004990: 726e 656c 2720 696e 2073 7973 2e6d 6f64  rnel' in sys.mod
+000049a0: 756c 6573 3a0d 0a20 2020 2020 2020 2020  ules:..         
+000049b0: 2020 2023 204a 7570 7974 6572 206e 6f74     # Jupyter not
+000049c0: 6562 6f6f 6b20 6f72 2069 7079 7468 6f6e  ebook or ipython
+000049d0: 0d0a 2020 2020 2020 2020 2020 2020 6469  ..            di
+000049e0: 7370 6c61 7928 4854 4d4c 2866 273c 7020  splay(HTML(f'<p 
+000049f0: 7374 796c 653d 2263 6f6c 6f72 3a6d 6167  style="color:mag
+00004a00: 656e 7461 3b22 3e5c 6e43 616c 6c69 6e67  enta;">\nCalling
+00004a10: 204d 6f64 656c 3a20 7b73 656c 662e 6c6c   Model: {self.ll
+00004a20: 6d7d 3c2f 703e 2729 290d 0a20 2020 2020  m}</p>'))..     
+00004a30: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
+00004a40: 544d 4c28 6627 3c70 3e3c 6220 7374 796c  TML(f'<p><b styl
+00004a50: 653d 2263 6f6c 6f72 3a6d 6167 656e 7461  e="color:magenta
+00004a60: 3b22 3e49 2068 6176 6520 7365 6e74 2079  ;">I have sent y
+00004a70: 6f75 7220 7265 7175 6573 7420 746f 2074  our request to t
+00004a80: 6865 204c 4c4d 2061 6e64 2061 7761 6974  he LLM and await
+00004a90: 696e 6720 7265 7370 6f6e 7365 2c20 706c  ing response, pl
+00004aa0: 6561 7365 2077 6169 742e 2e2e 3c2f 623e  ease wait...</b>
+00004ab0: 3c2f 703e 3c62 723e 2729 290d 0a20 2020  </p><br>'))..   
+00004ac0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00004ad0: 2020 2020 2020 2020 2320 4f74 6865 7220          # Other 
+00004ae0: 656e 7669 726f 6e6d 656e 7420 286c 696b  environment (lik
+00004af0: 6520 7465 726d 696e 616c 290d 0a20 2020  e terminal)..   
+00004b00: 2020 2020 2020 2020 2070 7269 6e74 2863           print(c
+00004b10: 6f6c 6f72 6564 2866 225c 6e3e 2043 616c  olored(f"\n> Cal
+00004b20: 6c69 6e67 204d 6f64 656c 3a20 7b73 656c  ling Model: {sel
+00004b30: 662e 6c6c 6d7d 222c 2022 6d61 6765 6e74  f.llm}", "magent
+00004b40: 6122 2929 0d0a 2020 2020 2020 2020 2020  a"))..          
+00004b50: 2020 6370 7269 6e74 2866 225c 6e3e 2049    cprint(f"\n> I
+00004b60: 2068 6176 6520 7365 6e74 2079 6f75 7220   have sent your 
+00004b70: 7265 7175 6573 7420 746f 2074 6865 204c  request to the L
+00004b80: 4c4d 2061 6e64 2061 7761 6974 696e 6720  LM and awaiting 
+00004b90: 7265 7370 6f6e 7365 2c20 706c 6561 7365  response, please
+00004ba0: 2077 6169 742e 2e2e 5c6e 222c 2027 6d61   wait...\n", 'ma
+00004bb0: 6765 6e74 6127 2c20 6174 7472 733d 5b27  genta', attrs=['
+00004bc0: 626f 6c64 275d 290d 0a0d 0a20 2020 2020  bold'])....     
+00004bd0: 2020 2023 2043 616c 6c20 7468 6520 4f70     # Call the Op
+00004be0: 656e 4149 2041 5049 2061 6e64 2068 616e  enAI API and han
+00004bf0: 646c 6520 7261 7465 206c 696d 6974 2065  dle rate limit e
+00004c00: 7272 6f72 730d 0a20 2020 2020 2020 2074  rrors..        t
+00004c10: 7279 3a0d 0a20 2020 2020 2020 2020 2020  ry:..           
+00004c20: 206c 6c6d 5f72 6573 706f 6e73 652c 2074   llm_response, t
+00004c30: 6f6b 656e 735f 7573 6564 203d 2073 656c  okens_used = sel
+00004c40: 662e 6c6c 6d5f 6361 6c6c 286d 6573 7361  f.llm_call(messa
+00004c50: 6765 7329 0d0a 0d0a 2020 2020 2020 2020  ges)....        
+00004c60: 6578 6365 7074 206f 7065 6e61 692e 6572  except openai.er
+00004c70: 726f 722e 5261 7465 4c69 6d69 7445 7272  ror.RateLimitErr
+00004c80: 6f72 3a0d 0a20 2020 2020 2020 2020 2020  or:..           
+00004c90: 2070 7269 6e74 280d 0a20 2020 2020 2020   print(..       
+00004ca0: 2020 2020 2020 2020 2022 5468 6520 4f70           "The Op
+00004cb0: 656e 4149 2041 5049 2072 6174 6520 6c69  enAI API rate li
+00004cc0: 6d69 7420 6861 7320 6265 656e 2065 7863  mit has been exc
+00004cd0: 6565 6465 642e 2057 6169 7469 6e67 2031  eeded. Waiting 1
+00004ce0: 3020 7365 636f 6e64 7320 616e 6420 7472  0 seconds and tr
+00004cf0: 7969 6e67 2061 6761 696e 2e22 0d0a 2020  ying again."..  
+00004d00: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00004d10: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+00004d20: 6565 7028 3130 290d 0a20 2020 2020 2020  eep(10)..       
+00004d30: 2020 2020 206c 6c6d 5f72 6573 706f 6e73       llm_respons
+00004d40: 652c 2074 6f6b 656e 735f 7573 6564 203d  e, tokens_used =
+00004d50: 2073 656c 662e 6c6c 6d5f 6361 6c6c 286d   self.llm_call(m
+00004d60: 6573 7361 6765 7329 0d0a 0d0a 2020 2020  essages)....    
+00004d70: 2020 2020 2320 4578 7472 6163 7420 7468      # Extract th
+00004d80: 6520 636f 6465 2066 726f 6d20 7468 6520  e code from the 
+00004d90: 4150 4920 7265 7370 6f6e 7365 0d0a 2020  API response..  
+00004da0: 2020 2020 2020 636f 6465 2c72 6566 6c65        code,refle
+00004db0: 6374 696f 6e2c 666c 6f77 3d20 7365 6c66  ction,flow= self
+00004dc0: 2e5f 6578 7472 6163 745f 636f 6465 286c  ._extract_code(l
+00004dd0: 6c6d 5f72 6573 706f 6e73 6529 0d0a 0d0a  lm_response)....
+00004de0: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
+00004df0: 2074 6865 2074 6f74 616c 2074 6f6b 656e   the total token
+00004e00: 7320 7573 6564 0d0a 2020 2020 2020 2020  s used..        
+00004e10: 7365 6c66 2e74 6f74 616c 5f74 6f6b 656e  self.total_token
+00004e20: 735f 7573 6564 2e61 7070 656e 6428 746f  s_used.append(to
+00004e30: 6b65 6e73 5f75 7365 6429 0d0a 2020 2020  kens_used)..    
+00004e40: 2020 2020 746f 7461 6c5f 746f 6b65 6e73      total_tokens
+00004e50: 5f75 7365 645f 7375 6d20 3d20 7375 6d28  _used_sum = sum(
+00004e60: 7365 6c66 2e74 6f74 616c 5f74 6f6b 656e  self.total_token
+00004e70: 735f 7573 6564 290d 0a0d 0a20 2020 2020  s_used)....     
+00004e80: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
+00004e90: 6572 726f 7220 636f 7272 6563 7469 6f6e  error correction
+00004ea0: 2063 6f75 6e74 6572 0d0a 2020 2020 2020   counter..      
+00004eb0: 2020 6572 726f 725f 636f 7272 6563 7469    error_correcti
+00004ec0: 6f6e 7320 3d20 300d 0a0d 0a20 2020 2020  ons = 0....     
+00004ed0: 2020 2023 2053 746f 7265 2074 6865 206f     # Store the o
+00004ee0: 7269 6769 6e61 6c20 6c6c 6d20 7661 6c75  riginal llm valu
+00004ef0: 650d 0a20 2020 2020 2020 206f 7269 6769  e..        origi
+00004f00: 6e61 6c5f 6c6c 6d20 3d20 7365 6c66 2e6c  nal_llm = self.l
+00004f10: 6c6d 0d0a 0d0a 2020 2020 2020 2020 2320  lm....        # 
+00004f20: 4465 6275 6720 636f 6465 2069 6620 6465  Debug code if de
+00004f30: 6275 6720 7061 7261 6d65 7465 7220 6973  bug parameter is
+00004f40: 2073 6574 2074 6f20 5472 7565 0d0a 2020   set to True..  
+00004f50: 2020 2020 2020 6966 2073 656c 662e 6465        if self.de
+00004f60: 6275 673a 0d0a 2020 2020 2020 2020 2020  bug:..          
+00004f70: 2020 2320 5377 6974 6368 2074 6f20 6770    # Switch to gp
+00004f80: 742d 3420 6966 206c 6c6d 5f73 7769 7463  t-4 if llm_switc
+00004f90: 6820 7061 7261 6d65 7465 7220 6973 2073  h parameter is s
+00004fa0: 6574 2074 6f20 5472 7565 2e20 5468 6973  et to True. This
+00004fb0: 2077 696c 6c20 696e 6372 6561 7365 2074   will increase t
+00004fc0: 6865 2070 726f 6365 7373 696e 6720 7469  he processing ti
+00004fd0: 6d65 2061 6e64 2063 6f73 740d 0a20 2020  me and cost..   
+00004fe0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00004ff0: 2e6c 6c6d 5f73 7769 7463 683a 0d0a 2020  .llm_switch:..  
+00005000: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00005010: 6c66 2e6c 6c6d 203d 2027 6770 742d 3427  lf.llm = 'gpt-4'
+00005020: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005030: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
+00005040: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
+00005050: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005060: 2020 2020 2020 2320 4a75 7079 7465 7220        # Jupyter 
+00005070: 6e6f 7465 626f 6f6b 0d0a 2020 2020 2020  notebook..      
+00005080: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00005090: 7370 6c61 7928 4854 4d4c 2827 3c73 7061  splay(HTML('<spa
+000050a0: 6e20 7374 796c 653d 2263 6f6c 6f72 3a20  n style="color: 
+000050b0: 6d61 6765 6e74 613b 223e 5377 6974 6368  magenta;">Switch
+000050c0: 696e 6720 6d6f 6465 6c20 746f 2067 7074  ing model to gpt
+000050d0: 2d34 2074 6f20 6465 6275 6720 7468 6520  -4 to debug the 
+000050e0: 636f 6465 2e3c 2f73 7061 6e3e 2729 290d  code.</span>')).
+000050f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005100: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+00005110: 2020 2020 2020 2020 2020 2020 2320 434c              # CL
+00005120: 490d 0a20 2020 2020 2020 2020 2020 2020  I..             
+00005130: 2020 2020 2020 2070 7269 6e74 2863 6f6c         print(col
+00005140: 6f72 6564 2822 5c6e 3e20 5377 6974 6368  ored("\n> Switch
+00005150: 696e 6720 6d6f 6465 6c20 746f 2047 5054  ing model to GPT
+00005160: 2d34 2074 6f20 6465 6275 6720 7468 6520  -4 to debug the 
+00005170: 636f 6465 2e22 2c20 226d 6167 656e 7461  code.", "magenta
+00005180: 2229 290d 0a20 2020 2020 2020 2020 2020  "))..           
+00005190: 2063 6f64 6520 3d20 7365 6c66 2e64 6562   code = self.deb
+000051a0: 7567 5f63 6f64 6528 636f 6465 2c20 7175  ug_code(code, qu
+000051b0: 6573 7469 6f6e 290d 0a0d 0a20 2020 2020  estion)....     
+000051c0: 2020 2020 2020 2023 2053 7769 7463 6820         # Switch 
+000051d0: 6261 636b 2074 6f20 7468 6520 6f72 6967  back to the orig
+000051e0: 696e 616c 206c 6c6d 2062 6566 6f72 6520  inal llm before 
+000051f0: 7468 6520 6675 6e63 7469 6f6e 2066 696e  the function fin
+00005200: 6973 6865 730d 0a20 2020 2020 2020 2020  ishes..         
+00005210: 2020 2073 656c 662e 6c6c 6d20 3d20 6f72     self.llm = or
+00005220: 6967 696e 616c 5f6c 6c6d 0d0a 0d0a 2020  iginal_llm....  
+00005230: 2020 2020 2020 2320 5265 6469 7265 6374        # Redirect
+00005240: 2073 7461 6e64 6172 6420 6f75 7470 7574   standard output
+00005250: 2074 6f20 6120 5374 7269 6e67 494f 2062   to a StringIO b
+00005260: 7566 6665 720d 0a20 2020 2020 2020 2077  uffer..        w
+00005270: 6974 6820 7265 6469 7265 6374 5f73 7464  ith redirect_std
+00005280: 6f75 7428 696f 2e53 7472 696e 6749 4f28  out(io.StringIO(
+00005290: 2929 2061 7320 6f75 7470 7574 3a0d 0a20  )) as output:.. 
+000052a0: 2020 2020 2020 2020 2020 2023 2054 7279             # Try
+000052b0: 2074 6f20 6578 6563 7574 6520 7468 6520   to execute the 
+000052c0: 636f 6465 2061 6e64 2068 616e 646c 6520  code and handle 
+000052d0: 6572 726f 7273 0d0a 2020 2020 2020 2020  errors..        
+000052e0: 2020 2020 7768 696c 6520 6572 726f 725f      while error_
+000052f0: 636f 7272 6563 7469 6f6e 7320 3c20 7365  corrections < se
+00005300: 6c66 2e4d 4158 5f45 5252 4f52 5f43 4f52  lf.MAX_ERROR_COR
+00005310: 5245 4354 494f 4e53 3a0d 0a20 2020 2020  RECTIONS:..     
+00005320: 2020 2020 2020 2020 2020 2074 7279 3a0d             try:.
+00005330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005340: 2020 2020 206d 6573 7361 6765 732e 6170       messages.ap
+00005350: 7065 6e64 287b 2272 6f6c 6522 3a20 2261  pend({"role": "a
+00005360: 7373 6973 7461 6e74 222c 2022 636f 6e74  ssistant", "cont
+00005370: 656e 7422 3a20 6c6c 6d5f 7265 7370 6f6e  ent": llm_respon
+00005380: 7365 7d29 0d0a 2020 2020 2020 2020 2020  se})..          
+00005390: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
+000053a0: 7665 2074 6865 206f 6c64 6573 7420 636f  ve the oldest co
+000053b0: 6e76 6572 7361 7469 6f6e 2066 726f 6d20  nversation from 
+000053c0: 7468 6520 6d65 7373 6167 6573 206c 6973  the messages lis
+000053d0: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
+000053e0: 2020 2020 2020 2069 6620 6c65 6e28 6d65         if len(me
+000053f0: 7373 6167 6573 2920 3e20 7365 6c66 2e4d  ssages) > self.M
+00005400: 4158 5f43 4f4e 5645 5253 4154 494f 4e53  AX_CONVERSATIONS
+00005410: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00005420: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+00005430: 6765 732e 706f 7028 3129 0d0a 2020 2020  ges.pop(1)..    
+00005440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005450: 2020 2020 6d65 7373 6167 6573 2e70 6f70      messages.pop
+00005460: 2831 290d 0a20 2020 2020 2020 2020 2020  (1)..           
+00005470: 2020 2020 2020 2020 2023 2052 6573 6574           # Reset
+00005480: 2064 6620 746f 2074 6865 206f 7269 6769   df to the origi
+00005490: 6e61 6c20 7374 6174 6520 6265 666f 7265  nal state before
+000054a0: 2065 7865 6375 7469 6e67 2074 6865 2063   executing the c
+000054b0: 6f64 650d 0a20 2020 2020 2020 2020 2020  ode..           
+000054c0: 2020 2020 2020 2020 2073 656c 662e 6466           self.df
+000054d0: 203d 2073 656c 662e 6f72 6967 696e 616c   = self.original
+000054e0: 5f64 662e 636f 7079 2829 0d0a 2020 2020  _df.copy()..    
+000054f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005500: 2320 4578 6563 7574 6520 7468 6520 636f  # Execute the co
+00005510: 6465 0d0a 2020 2020 2020 2020 2020 2020  de..            
+00005520: 2020 2020 2020 2020 6966 2063 6f64 6520          if code 
+00005530: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
+00005540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005550: 2020 2020 2020 6578 6563 2863 6f64 652c        exec(code,
+00005560: 207b 2764 6627 3a20 7365 6c66 2e64 667d   {'df': self.df}
+00005570: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00005580: 2020 2020 2020 2062 7265 616b 0d0a 2020         break..  
+00005590: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000055a0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+000055b0: 7320 653a 0d0a 2020 2020 2020 2020 2020  s e:..          
+000055c0: 2020 2020 2020 2020 2020 2320 5072 696e            # Prin
+000055d0: 7420 7468 6520 6572 726f 7220 6d65 7373  t the error mess
+000055e0: 6167 650d 0a20 2020 2020 2020 2020 2020  age..           
+000055f0: 2020 2020 2020 2020 2069 6620 2769 7079           if 'ipy
+00005600: 6b65 726e 656c 2720 696e 2073 7973 2e6d  kernel' in sys.m
+00005610: 6f64 756c 6573 3a0d 0a20 2020 2020 2020  odules:..       
+00005620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005630: 2023 204a 7570 7974 6572 206e 6f74 6562   # Jupyter noteb
+00005640: 6f6f 6b0d 0a20 2020 2020 2020 2020 2020  ook..           
+00005650: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+00005660: 706c 6179 2848 544d 4c28 6627 3c62 723e  play(HTML(f'<br>
+00005670: 3c62 3e3c 7370 616e 2073 7479 6c65 3d22  <b><span style="
+00005680: 636f 6c6f 723a 2023 6438 3663 3030 3b22  color: #d86c00;"
+00005690: 3e49 2072 616e 2069 6e74 6f20 616e 2069  >I ran into an i
+000056a0: 7373 7565 3a3c 2f73 7061 6e3e 3c2f 623e  ssue:</span></b>
+000056b0: 3c62 723e 3c70 7265 2073 7479 6c65 3d22  <br><pre style="
+000056c0: 636f 6c6f 723a 2023 6438 3663 3030 3b22  color: #d86c00;"
+000056d0: 3e7b 657d 3c2f 7072 653e 3c62 723e 3c62  >{e}</pre><br><b
+000056e0: 3e3c 7370 616e 2073 7479 6c65 3d22 636f  ><span style="co
+000056f0: 6c6f 723a 2023 6438 3663 3030 3b22 3e49  lor: #d86c00;">I
+00005700: 2077 696c 6c20 6578 616d 696e 6520 6974   will examine it
+00005710: 2c20 616e 6420 7472 7920 6167 6169 6e20  , and try again 
+00005720: 7769 7468 2061 6e20 6164 6a75 7374 6564  with an adjusted
+00005730: 2063 6f64 652e 3c2f 7370 616e 3e3c 2f62   code.</span></b
+00005740: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+00005750: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00005760: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00005770: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+00005780: 4c49 0d0a 2020 2020 2020 2020 2020 2020  LI..            
+00005790: 2020 2020 2020 2020 2020 2020 2370 7269              #pri
+000057a0: 6e74 2863 6f6c 6f72 6564 2866 2749 2072  nt(colored(f'I r
+000057b0: 616e 2069 6e74 6f20 616e 2069 7373 7565  an into an issue
+000057c0: 3a20 7b65 7d2e 203e 2049 2077 696c 6c20  : {e}. > I will 
+000057d0: 6578 616d 696e 6520 6974 2c20 616e 6420  examine it, and 
+000057e0: 7472 7920 6167 6169 6e20 7769 7468 2061  try again with a
+000057f0: 6e20 6164 6a75 7374 6564 2063 6f64 652e  n adjusted code.
+00005800: 272c 2027 7265 6427 2929 0d0a 2020 2020  ', 'red'))..    
+00005810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005820: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00005830: 7269 7465 2827 5c30 3333 5b33 316d 2720  rite('\033[31m' 
+00005840: 2b20 6627 3e20 4920 7261 6e20 696e 746f  + f'> I ran into
+00005850: 2061 6e20 6973 7375 653a 207b 657d 2e20   an issue: {e}. 
+00005860: 5c6e 3e20 4920 7769 6c6c 2065 7861 6d69  \n> I will exami
+00005870: 6e65 2069 742c 2061 6e64 2074 7279 2061  ne it, and try a
+00005880: 6761 696e 2077 6974 6820 616e 2061 646a  gain with an adj
+00005890: 7573 7465 6420 636f 6465 2e27 202b 2027  usted code.' + '
+000058a0: 5c30 3333 5b30 6d27 202b 2027 5c6e 2729  \033[0m' + '\n')
+000058b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000058c0: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+000058d0: 6465 7272 2e66 6c75 7368 2829 0d0a 0d0a  derr.flush()....
+000058e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058f0: 2020 2020 2320 496e 6372 656d 656e 7420      # Increment 
+00005900: 7468 6520 6572 726f 7220 636f 7272 6563  the error correc
+00005910: 7469 6f6e 2063 6f75 6e74 6572 2061 6e64  tion counter and
+00005920: 2075 7064 6174 6520 7468 6520 6d65 7373   update the mess
+00005930: 6167 6573 206c 6973 7420 7769 7468 2074  ages list with t
+00005940: 6865 2065 7272 6f72 0d0a 2020 2020 2020  he error..      
+00005950: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00005960: 726f 725f 636f 7272 6563 7469 6f6e 7320  ror_corrections 
+00005970: 2b3d 2031 0d0a 2020 2020 2020 2020 2020  += 1..          
+00005980: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+00005990: 6573 2e61 7070 656e 6428 7b22 726f 6c65  es.append({"role
+000059a0: 223a 2022 7573 6572 222c 2022 636f 6e74  ": "user", "cont
+000059b0: 656e 7422 3a20 7365 6c66 2e65 7272 6f72  ent": self.error
+000059c0: 5f63 6f72 7265 6374 5f74 6173 6b2e 666f  _correct_task.fo
+000059d0: 726d 6174 2865 297d 290d 0a0d 0a20 2020  rmat(e)})....   
+000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059f0: 2023 2053 7769 7463 6820 746f 2067 7074   # Switch to gpt
+00005a00: 2d34 2069 6620 6c6c 6d5f 7377 6974 6368  -4 if llm_switch
+00005a10: 2070 6172 616d 6574 6572 2069 7320 7365   parameter is se
+00005a20: 7420 746f 2054 7275 652e 2054 6869 7320  t to True. This 
+00005a30: 7769 6c6c 2069 6e63 7265 6173 6520 7468  will increase th
+00005a40: 6520 7072 6f63 6573 7369 6e67 2074 696d  e processing tim
+00005a50: 6520 616e 6420 636f 7374 2e0d 0a20 2020  e and cost...   
+00005a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a70: 2069 6620 7365 6c66 2e6c 6c6d 5f73 7769   if self.llm_swi
+00005a80: 7463 683a 0d0a 2020 2020 2020 2020 2020  tch:..          
+00005a90: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00005aa0: 6c66 2e6c 6c6d 203d 2027 6770 742d 3427  lf.llm = 'gpt-4'
+00005ab0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005ac0: 2020 2020 2020 2020 2020 6966 2027 6970            if 'ip
+00005ad0: 796b 6572 6e65 6c27 2069 6e20 7379 732e  ykernel' in sys.
+00005ae0: 6d6f 6475 6c65 733a 0d0a 2020 2020 2020  modules:..      
+00005af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b00: 2020 2020 2020 2320 4a75 7079 7465 7220        # Jupyter 
+00005b10: 6e6f 7465 626f 6f6b 0d0a 2020 2020 2020  notebook..      
+00005b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b30: 2020 2020 2020 6469 7370 6c61 7928 4854        display(HT
+00005b40: 4d4c 2827 3c73 7061 6e20 7374 796c 653d  ML('<span style=
+00005b50: 2263 6f6c 6f72 3a20 2364 3836 6330 303b  "color: #d86c00;
+00005b60: 223e 5377 6974 6368 696e 6720 6d6f 6465  ">Switching mode
+00005b70: 6c20 746f 2067 7074 2d34 2074 6f20 7472  l to gpt-4 to tr
+00005b80: 7920 746f 2069 6d70 726f 7665 2074 6865  y to improve the
+00005b90: 206f 7574 636f 6d65 2e3c 2f73 7061 6e3e   outcome.</span>
+00005ba0: 2729 290d 0a20 2020 2020 2020 2020 2020  '))..           
+00005bb0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00005bc0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00005bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005be0: 2320 434c 490d 0a20 2020 2020 2020 2020  # CLI..         
+00005bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c00: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+00005c10: 6974 6528 275c 3033 335b 3331 6d27 202b  ite('\033[31m' +
+00005c20: 2066 273e 2053 7769 7463 6869 6e67 206d   f'> Switching m
+00005c30: 6f64 656c 2074 6f20 6770 742d 3420 746f  odel to gpt-4 to
+00005c40: 2074 7279 2074 6f20 696d 7072 6f76 6520   try to improve 
+00005c50: 7468 6520 6f75 7463 6f6d 652e 2720 2b20  the outcome.' + 
+00005c60: 275c 3033 335b 306d 2720 2b20 275c 6e27  '\033[0m' + '\n'
+00005c70: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00005c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005c90: 7973 2e73 7464 6572 722e 666c 7573 6828  ys.stderr.flush(
+00005ca0: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+00005cb0: 2020 2020 2020 2020 2023 2041 7474 656d           # Attem
+00005cc0: 7074 2074 6f20 636f 7272 6563 7420 7468  pt to correct th
+00005cd0: 6520 636f 6465 2061 6e64 2068 616e 646c  e code and handl
+00005ce0: 6520 7261 7465 206c 696d 6974 2065 7272  e rate limit err
+00005cf0: 6f72 730d 0a20 2020 2020 2020 2020 2020  ors..           
+00005d00: 2020 2020 2020 2020 2074 7279 3a0d 0a20           try:.. 
 00005d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d20: 6c6c 6d5f 7265 7370 6f6e 7365 2c20 746f  llm_response, to
-00005d30: 6b65 6e73 5f75 7365 6420 3d20 7365 6c66  kens_used = self
-00005d40: 2e6c 6c6d 5f63 616c 6c28 6d65 7373 6167  .llm_call(messag
-00005d50: 6573 290d 0a20 2020 2020 2020 2020 2020  es)..           
-00005d60: 2020 2020 2020 2020 2020 2020 2063 6f64               cod
-00005d70: 652c 7265 666c 6563 7469 6f6e 2c66 6c6f  e,reflection,flo
-00005d80: 7720 3d20 7365 6c66 2e5f 6578 7472 6163  w = self._extrac
-00005d90: 745f 636f 6465 286c 6c6d 5f72 6573 706f  t_code(llm_respo
-00005da0: 6e73 6529 0d0a 2020 2020 2020 2020 2020  nse)..          
-00005db0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00005dc0: 6c66 2e74 6f74 616c 5f74 6f6b 656e 735f  lf.total_tokens_
-00005dd0: 7573 6564 2e61 7070 656e 6428 746f 6b65  used.append(toke
-00005de0: 6e73 5f75 7365 6429 0d0a 2020 2020 2020  ns_used)..      
-00005df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e00: 2020 746f 7461 6c5f 746f 6b65 6e73 5f75    total_tokens_u
-00005e10: 7365 645f 7375 6d20 3d20 7375 6d28 7365  sed_sum = sum(se
-00005e20: 6c66 2e74 6f74 616c 5f74 6f6b 656e 735f  lf.total_tokens_
-00005e30: 7573 6564 290d 0a20 2020 2020 2020 2020  used)..         
-00005e40: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00005e50: 7420 6f70 656e 6169 2e65 7272 6f72 2e52  t openai.error.R
-00005e60: 6174 654c 696d 6974 4572 726f 723a 0d0a  ateLimitError:..
-00005e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e80: 2020 2020 2020 2020 7072 696e 7428 0d0a          print(..
-00005e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ea0: 2020 2020 2020 2020 2020 2020 2254 6865              "The
-00005eb0: 204f 7065 6e41 4920 4150 4920 7261 7465   OpenAI API rate
-00005ec0: 206c 696d 6974 2068 6173 2062 6565 6e20   limit has been 
-00005ed0: 6578 6365 6564 6564 2e20 5761 6974 696e  exceeded. Waitin
-00005ee0: 6720 3130 2073 6563 6f6e 6473 2061 6e64  g 10 seconds and
-00005ef0: 2074 7279 696e 6720 6167 6169 6e2e 220d   trying again.".
-00005f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005f10: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-00005f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f30: 2020 2020 7469 6d65 2e73 6c65 6570 2831      time.sleep(1
-00005f40: 3029 0d0a 2020 2020 2020 2020 2020 2020  0)..            
-00005f50: 2020 2020 2020 2020 2020 2020 6c6c 6d5f              llm_
-00005f60: 7265 7370 6f6e 7365 2c20 746f 6b65 6e73  response, tokens
-00005f70: 5f75 7365 6420 3d20 7365 6c66 2e6c 6c6d  _used = self.llm
-00005f80: 5f63 616c 6c28 6d65 7373 6167 6573 290d  _call(messages).
-00005f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005fa0: 2020 2020 2020 2020 2063 6f64 652c 7265           code,re
-00005fb0: 666c 6563 7469 6f6e 2c66 6c6f 7720 3d20  flection,flow = 
-00005fc0: 7365 6c66 2e5f 6578 7472 6163 745f 636f  self._extract_co
-00005fd0: 6465 286c 6c6d 5f72 6573 706f 6e73 6529  de(llm_response)
-00005fe0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005ff0: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-00006000: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00006010: 2e61 7070 656e 6428 746f 6b65 6e73 5f75  .append(tokens_u
-00006020: 7365 6429 0d0a 2020 2020 2020 2020 2020  sed)..          
-00006030: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00006040: 7461 6c5f 746f 6b65 6e73 5f75 7365 645f  tal_tokens_used_
-00006050: 7375 6d20 3d20 7375 6d28 7365 6c66 2e74  sum = sum(self.t
-00006060: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00006070: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-00006080: 2023 2053 7769 7463 6820 6261 636b 2074   # Switch back t
-00006090: 6f20 7468 6520 6f72 6967 696e 616c 206c  o the original l
-000060a0: 6c6d 2062 6566 6f72 6520 7468 6520 6675  lm before the fu
-000060b0: 6e63 7469 6f6e 2066 696e 6973 6865 730d  nction finishes.
-000060c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000060d0: 662e 6c6c 6d20 3d20 6f72 6967 696e 616c  f.llm = original
-000060e0: 5f6c 6c6d 0d0a 0d0a 2020 2020 2020 2020  _llm....        
-000060f0: 2320 4765 7420 7468 6520 6f75 7470 7574  # Get the output
-00006100: 2066 726f 6d20 7468 6520 6578 6563 7574   from the execut
-00006110: 6564 2063 6f64 650d 0a20 2020 2020 2020  ed code..       
-00006120: 2061 6e73 7765 7220 3d20 6f75 7470 7574   answer = output
-00006130: 2e67 6574 7661 6c75 6528 290d 0a0d 0a20  .getvalue().... 
-00006140: 2020 2020 2020 2023 2052 6573 6574 2074         # Reset t
-00006150: 6865 2053 7472 696e 6749 4f20 6275 6666  he StringIO buff
-00006160: 6572 0d0a 2020 2020 2020 2020 6f75 7470  er..        outp
-00006170: 7574 2e74 7275 6e63 6174 6528 3029 0d0a  ut.truncate(0)..
-00006180: 2020 2020 2020 2020 6f75 7470 7574 2e73          output.s
-00006190: 6565 6b28 3029 0d0a 0d0a 2020 2020 2020  eek(0)....      
-000061a0: 2020 7265 7475 726e 2061 6e73 7765 722c    return answer,
-000061b0: 2063 6f64 652c 2072 6566 6c65 6374 696f   code, reflectio
-000061c0: 6e2c 2066 6c6f 772c 2074 6f74 616c 5f74  n, flow, total_t
-000061d0: 6f6b 656e 735f 7573 6564 5f73 756d 0d0a  okens_used_sum..
-000061e0: 2020 2020                                    
+00005d20: 2020 2020 2020 206c 6c6d 5f72 6573 706f         llm_respo
+00005d30: 6e73 652c 2074 6f6b 656e 735f 7573 6564  nse, tokens_used
+00005d40: 203d 2073 656c 662e 6c6c 6d5f 6361 6c6c   = self.llm_call
+00005d50: 286d 6573 7361 6765 7329 0d0a 2020 2020  (messages)..    
+00005d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d70: 2020 2020 636f 6465 2c72 6566 6c65 6374      code,reflect
+00005d80: 696f 6e2c 666c 6f77 203d 2073 656c 662e  ion,flow = self.
+00005d90: 5f65 7874 7261 6374 5f63 6f64 6528 6c6c  _extract_code(ll
+00005da0: 6d5f 7265 7370 6f6e 7365 290d 0a20 2020  m_response)..   
+00005db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005dc0: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
+00005dd0: 746f 6b65 6e73 5f75 7365 642e 6170 7065  tokens_used.appe
+00005de0: 6e64 2874 6f6b 656e 735f 7573 6564 290d  nd(tokens_used).
+00005df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005e00: 2020 2020 2020 2020 2074 6f74 616c 5f74           total_t
+00005e10: 6f6b 656e 735f 7573 6564 5f73 756d 203d  okens_used_sum =
+00005e20: 2073 756d 2873 656c 662e 746f 7461 6c5f   sum(self.total_
+00005e30: 746f 6b65 6e73 5f75 7365 6429 0d0a 2020  tokens_used)..  
+00005e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e50: 2020 6578 6365 7074 206f 7065 6e61 692e    except openai.
+00005e60: 6572 726f 722e 5261 7465 4c69 6d69 7445  error.RateLimitE
+00005e70: 7272 6f72 3a0d 0a20 2020 2020 2020 2020  rror:..         
+00005e80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005e90: 7269 6e74 280d 0a20 2020 2020 2020 2020  rint(..         
+00005ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005eb0: 2020 2022 5468 6520 4f70 656e 4149 2041     "The OpenAI A
+00005ec0: 5049 2072 6174 6520 6c69 6d69 7420 6861  PI rate limit ha
+00005ed0: 7320 6265 656e 2065 7863 6565 6465 642e  s been exceeded.
+00005ee0: 2057 6169 7469 6e67 2031 3020 7365 636f   Waiting 10 seco
+00005ef0: 6e64 7320 616e 6420 7472 7969 6e67 2061  nds and trying a
+00005f00: 6761 696e 2e22 0d0a 2020 2020 2020 2020  gain."..        
+00005f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f20: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00005f30: 2020 2020 2020 2020 2020 2074 696d 652e             time.
+00005f40: 736c 6565 7028 3130 290d 0a20 2020 2020  sleep(10)..     
+00005f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f60: 2020 206c 6c6d 5f72 6573 706f 6e73 652c     llm_response,
+00005f70: 2074 6f6b 656e 735f 7573 6564 203d 2073   tokens_used = s
+00005f80: 656c 662e 6c6c 6d5f 6361 6c6c 286d 6573  elf.llm_call(mes
+00005f90: 7361 6765 7329 0d0a 2020 2020 2020 2020  sages)..        
+00005fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fb0: 636f 6465 2c72 6566 6c65 6374 696f 6e2c  code,reflection,
+00005fc0: 666c 6f77 203d 2073 656c 662e 5f65 7874  flow = self._ext
+00005fd0: 7261 6374 5f63 6f64 6528 6c6c 6d5f 7265  ract_code(llm_re
+00005fe0: 7370 6f6e 7365 290d 0a20 2020 2020 2020  sponse)..       
+00005ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006000: 2073 656c 662e 746f 7461 6c5f 746f 6b65   self.total_toke
+00006010: 6e73 5f75 7365 642e 6170 7065 6e64 2874  ns_used.append(t
+00006020: 6f6b 656e 735f 7573 6564 290d 0a20 2020  okens_used)..   
+00006030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006040: 2020 2020 2074 6f74 616c 5f74 6f6b 656e       total_token
+00006050: 735f 7573 6564 5f73 756d 203d 2073 756d  s_used_sum = sum
+00006060: 2873 656c 662e 746f 7461 6c5f 746f 6b65  (self.total_toke
+00006070: 6e73 5f75 7365 6429 0d0a 0d0a 2020 2020  ns_used)....    
+00006080: 2020 2020 2020 2020 2320 5377 6974 6368          # Switch
+00006090: 2062 6163 6b20 746f 2074 6865 206f 7269   back to the ori
+000060a0: 6769 6e61 6c20 6c6c 6d20 6265 666f 7265  ginal llm before
+000060b0: 2074 6865 2066 756e 6374 696f 6e20 6669   the function fi
+000060c0: 6e69 7368 6573 0d0a 2020 2020 2020 2020  nishes..        
+000060d0: 2020 2020 7365 6c66 2e6c 6c6d 203d 206f      self.llm = o
+000060e0: 7269 6769 6e61 6c5f 6c6c 6d0d 0a0d 0a20  riginal_llm.... 
+000060f0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
+00006100: 206f 7574 7075 7420 6672 6f6d 2074 6865   output from the
+00006110: 2065 7865 6375 7465 6420 636f 6465 0d0a   executed code..
+00006120: 2020 2020 2020 2020 616e 7377 6572 203d          answer =
+00006130: 206f 7574 7075 742e 6765 7476 616c 7565   output.getvalue
+00006140: 2829 0d0a 0d0a 2020 2020 2020 2020 2320  ()....        # 
+00006150: 5265 7365 7420 7468 6520 5374 7269 6e67  Reset the String
+00006160: 494f 2062 7566 6665 720d 0a20 2020 2020  IO buffer..     
+00006170: 2020 206f 7574 7075 742e 7472 756e 6361     output.trunca
+00006180: 7465 2830 290d 0a20 2020 2020 2020 206f  te(0)..        o
+00006190: 7574 7075 742e 7365 656b 2830 290d 0a0d  utput.seek(0)...
+000061a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000061b0: 616e 7377 6572 2c20 636f 6465 2c20 7265  answer, code, re
+000061c0: 666c 6563 7469 6f6e 2c20 666c 6f77 2c20  flection, flow, 
+000061d0: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
+000061e0: 645f 7375 6d0d 0a20 2020 20              d_sum..
```

### Comparing `bambooai-0.3.2/bambooai/prompts.py` & `bambooai-0.3.3/bambooai/prompts.py`

 * *Files identical despite different names*

### Comparing `bambooai-0.3.2/bambooai.egg-info/PKG-INFO` & `bambooai-0.3.3/bambooai.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bambooai
-Version: 0.3.2
+Version: 0.3.3
 Summary: A lightweight library for working with pandas dataframes using natural language queries
 Home-page: UNKNOWN
 Author: Palo Galko
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `bambooai-0.3.2/setup.py` & `bambooai-0.3.3/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 import os
 
 with open("README.md", "r") as fh:
     long_description = fh.read()
 
 setup(
     name='bambooai',
-    version='0.3.2',
+    version='0.3.3',
     description='A lightweight library for working with pandas dataframes using natural language queries',
     long_description=long_description,
     long_description_content_type="text/markdown",
     author='Palo Galko',
     packages=find_packages(),
     install_requires=[
         'openai',
```

